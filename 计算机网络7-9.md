# Chapter 7 网络安全

本章重要内容

+ 计算机网络面临的安全性威胁和计算机网络安全的主要问题
+ 对称密钥密码体制和公钥密码体制的特点
+ 数字签名与鉴别的概念
+ 网络层安全协议IPsec协议族和运输层安全协议SSL/TLS的要点
+ 应用层电子邮件的安全措施
+ 系统安全：防火墙与入侵检测

## 7.1 网络安全问题概述

### 7.1.1 计算机网络面临的安全性威胁

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329155454668.png" alt="image-20200329155454668" style="zoom:60%;" />

+ 计算机网络通信面临两大类威胁：

  + **被动攻击**

    + 攻击者从网络上窃听他人的通信内容
    + 通常称**截获**
    + 攻击者只是观察和分析某一个协议数据单元PDU而不干扰信息流，也可通过观察PDU的协议控制信息部分，了解正在通信协议实体的地址和身份，研究PDU的长度和传输的频度，从而了解所交换数据的某种性质，又称**流量分析(traffic analysis)**

  + **主动攻击**

    + 有如下几种最常见的方式：

      1. **篡改**

         攻击者故意篡改网络上传送的报文，包括彻底中断传送的报文，把完全伪造的报文传送给接收方。该攻击方式有时称更改报文流。

      2. **恶意程序**

         有以下几种：

         + **计算机病毒(computer virus)**

           一种会**传染**其他程序的程序，通过修改其他程序把自身或自己的变种复制进去完成

         + **计算机蠕虫(computer worm)**

           通过网络通信功能将自身从一个结点发送到另一个结点并自动启动运行的程序

         + **特洛伊木马(Trojan horse)**

           挂羊头卖狗肉

         + **逻辑炸弹(logic bomb)**

           当计算机的某些参数达到一定条件会执行特殊功能

         + **后门入侵(backdoor knocking)**

           利用系统实现中的漏洞通过网络入侵系统

         + **流氓软件**

           未经用户允许就在用户计算机上安装运行并损害用户利益的软件

      3. **拒绝服务DoS(Denial of Service)**

         + 攻击者向互联网上某个服务器不停发送大量分组，使该服务器无法提供正常服务，甚至完全瘫痪
         + 若从互联网上的成百上千个网站集中攻击一个网站，则称为**分布式拒绝服务DDoS(Distributed Denial of Service)**。有时也称此攻击为**网络带宽攻击**或**连通性攻击**

    + 对于主动攻击可以采取适当措施加以检测。但对于被动攻击，通常检测不出

  + 计算机网络通信安全的目标如下：

    1. 防止析出报文内容和流量分析
    2. 防止恶意程序
    3. 检测更改报文流和拒绝服务

  + 对付被动攻击可采用各种数据加密技术，而对付主动攻击，则需将加密技术与适当鉴别技术结合

### 7.1.2 安全的计算机网络

+ 网络的安全性是不可判定的
+ 保证所设计的协议是安全的方法有两种：
  + 形式化方法
    + 形式化方法证明比较困难，主要采用人工分析方法来找漏洞
  + 用经验分析协议的安全性
+ 安全的计算机网络应设法达到以下四个目标：
  1. **保密性**
     + 保密性就是只有信息的发送方和接收方才能懂得所发送信息的内容，而信息的截获者则看不懂所截获的信息
  2. **断电鉴别**
     + 安全的计算机网络必须能够鉴别信息的发送方和接收方的真实身份
  3. **信息的完整性**
     + 即使能够确认发送方的身份是真实的，并且所发送的信息都是经过加密的，我们依然不能认为网络是安全的
     + 既鉴别发送方的身份，又鉴别报文的完整性
  4. **运行的安全性**
     + 现在的机构与计算机网络的关系越密切，就越要重视计算机网络运行的安全性
+ **访问控制(access control)**十分必要，必须对访问网络的权限加以控制，并规定每个用户的访问权限，**多级安全(multilevel security)**也很重要

### 7.1.3 数据加密模型

+ 用户A向B发送**明文X**，但通过**加密算法E**运算后就得出**密文Y**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329155934604.png" alt="image-20200329155934604" style="zoom:60%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329160248985.png" alt="image-20200329160248985" style="zoom:50%;" />

+ **密码编码学(cryptography)**是密码体制的设计学，而**密码分析学(cryptanalysis)**则是在未知密钥的情况下从密文推演出明文或密钥的技术。密码编码学与密码分析学合称**密码学(cryptology)**
+ 如果不论截取者获得多少密文，但在密文中都没有足够的信息来唯一地确定出对应的明文，则这一密码体制称为**无条件安全的**，或称为**理论上是不可破的**
+ **目前几乎所有的密码体制均是可破的**
+ 人们关心的是要研制出**在计算上（而不是在理论上）是不可破的密码体制**
+ 如果一个密码体制中的密码，不能在一定时间内被可以使用的计算资源破译，则这一密码体制称为**在计算上是安全的**
+ 20世纪70年代后期，美国的**数据加密标准DES(Data Encryption Standard)**和**公钥密码体制(public key crypto-system)**，成为近代密码学发展史上的两个重要里程碑

## 7.2 两类密码体制

### 7.2.1 对称密钥密码体制

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329163606548.png" alt="image-20200329163606548" style="zoom:67%;" />

+ **对称密钥密码体制**，即**加密密钥与解密密钥是使用相同的密码体制**

+ **数据加密标准DES**属于对称密钥密码体制

+ **DES**是一种分组密码：

  1. 加密前先对整个明文进行分组，每组是64位长的二进制数据
  2. 对每个64位二进制数据进行加密处理，产生一组64位密文数据
  3. 最后将各组密文串接起来，即得出整个的密文。使用的密钥占有64位（实际长56位，外加8位用于奇偶校验）

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329163756189.png" alt="image-20200329163756189" style="zoom:50%;" />

+ **DES的保密性仅取决于对密钥的保密，而算法是公开的**

+ 现在对于56位DES密钥的搜索已成常态，56位DES已不再被认为是安全的

+ 三重DES

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329163826194.png" alt="image-20200329163826194" style="zoom:50%;" />

### 7.2.2 公钥密码体制

+ 公钥密码体制**使用不同的加密密钥与解密密钥**

+ 公钥密码的产生主要有两方面原因：

  + 对称密钥密码体制的**密钥分配**问题
  + 由于对**数字签名**的需求

+ **密钥分配中心KDC(Key Distribution Center)**

+ 公钥密码体制中，**加密密钥PK（public key，公钥）**向公众公开，而**解密密钥SK（secret key，即私钥或密钥）**则需要保密。加密算法E和解密算法D也都是公开的

+ 公钥密码体制的加密和解密过程有如下特点：

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329164957935.png" alt="image-20200329164957935" style="zoom:50%;" />

  + 虽然在计算机上可以容易地产生成对的PK~B~和SK~B~，但从已知的PK~B~实际上不可能推导出SK~B~，即从PK~B~到SK~B~是“**计算上不可能的**”
  + 虽然公钥可用来加密，但不能用来解密
  + 先后对X进行D运算和E运算或进行E运算和D运算，结果都相同

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329165609547.png" alt="image-20200329165609547" style="zoom:50%;" />

+ 公开密钥与对称密钥在使用通信信道方面有很大不同，在使用对称密钥时，由于双方用相同的密钥，因此在通信信道上可以进行**一对一的双向保密通信**，每一方既可用此密钥加密明文，并发送给对方，也可接收密文，用同一密钥对密文解密。这种保密通信仅限于持有此密钥的双方（有第三方则不保密）。但在使用公开密钥时，在通信信道上可以是**多对一的单向保密通信**

+ **任何加密方法的安全性取决于密钥的长度，以及攻破密文所需的计算量**，而不是简单地取决于加密的体制

+ 公钥加密算法的**开销较大**

## 7.3 数字签名

+ 数字签名必须保证能够实现以下三点功能：

  1. **报文鉴别**

     接收者能够核实发送者对报文的签名，其他人无法伪造对报文的签名

  2. **报文的完整性**

     接收者确信所收到的数据和发送者发送的完全一样而没有被篡改过

  3. **不可否认**

     + 发送者事后不能抵赖对报文的签名，叫做**不可否认**
     + 现在已有多种实现数字签名的方法。但采用公钥算法要比采用对称密钥算法更容易实现

+ 签名并非为了保密，而是为了进行签名和核实签名，即确认此明文的确是A发送的

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404160724875.png" alt="image-20200404160724875" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404160838558.png" alt="image-20200404160838558" style="zoom:50%;" />

## 7.4 鉴别

+ **鉴别是要验证通信的对方的确是自己所要通信的对象，而不是其他的冒充者，并且所传送的报文是完整的，没有被他人篡改过**
+ 授权涉及的问题是：所进行的过程是否被允许（如是否可以对某文件进行读或写）
+ 可再把鉴别细分两种：
  + **报文鉴别：**
    + 鉴别所收到的报文的确是报文的发送者发送的，而不是其他人伪造的或篡改的
    + 包含了端点鉴别和报文完整性的鉴别
  + **实体鉴别：**
    + 仅仅鉴别发送报文的实体
    + 实体可以是一个人，也可以是一个进程，这就是端点鉴别

### 7.4.1 报文鉴别

1. **密码散列函数**

   + 对较长的报文进行数字签名会使计算机增加非常大的负担
   + **密码散列函数(cryptographic hash function)**
   + 检验和就是散列函数的一种应用，用于发现数据在传输过程中的比特差错

   + 散列函数具有以下两个特点：
     1. 散列函数的输入长度可以很长，但其**输出长度则是固定的，并且较短**，散列函数的输出叫做**散列值**，或简称**散列**
     2. 不同的散列值肯定对应于不同的输入，但不同的输入却可能得出相同的散列值，亦即散列函数的输入与输出并非一一对应，是多对一的
   + 密码散列函数实际上是一种**单向函数(one-way function)**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404162218182.png" alt="image-20200404162218182" style="zoom:50%;" />

   + 散列H(X)可用来保护明文X的完整性

2. **实用的密码散列函数MD5和SHA-1**

   + MD是Message Digest的缩写，意思是**报文摘要**
   + MD5最终被另一种叫做**安全散列算法SHA(Secure Hash Algorithm)**的标准所取代
   + MD5算法大致过程：
     1. 先把任意长报文按模2^64^计算其余数（64位），追加在报文的后面
     2. 在报文和余数之间填充1~512位，使得填充后的总长度是512的整数倍，填充的首位是1，后面都是0
     3. 把追加和填充后的报文分割为一个个512位的数据块，每个512位的报文数据再分成4个128位的数据块依次送到不同的散列函数进行4轮计算，每一轮又都按32位的小数据块进行复杂的运算。一直到最后计算出MD5报文摘要代码（128位）
   + 这样得出的MD5报文摘要代码中的每一位都与原来报文中的每一位有关。像MD5这样的密码散列函数实际上已经是个相当复杂的算法，而不是简单的函数了
   + SHA是由美国标准与技术协会NIST提出的一个散列算法系列
   + **SHA比MD5更安全，但计算起来却比MD5要慢一点**

3. **报文鉴别码**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404163523935.png" alt="image-20200404163523935" style="zoom:50%;" />

   + 在A从报文X导出散列H后，就对散列H用密钥K加密。这样得出的结果叫做**报文鉴别码MAC(Message Authentication Code)**
   + 加密后得到的扩展报文，不仅不可伪造，也不可否认

### 7.4.2 实体鉴别

+ 实体鉴别和报文鉴别不同

  + **报文鉴别**是**对每一个收到的报文都要鉴别报文的发送者**
  + **实体鉴别**是**在系统接入的全部持续时间内对和自己通信的对方实体只需验证一次**

+ **鉴别过程**

  + A向远端的B发送带有自己身份A和口令的报文，并且使用双方约定好的共享对称密钥K~AB~进行加密

  + B收到此报文后，用共享对称密钥K~AB~进行解密，从而鉴别了实体A的身份

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404164401613.png" alt="image-20200404164401613" style="zoom:55%;" /> 

  + **重放攻击(replay attack)**可通过**不重数(nonce)**避免，不重数可以使B能够把重复的鉴别请求和新的鉴别请求区分开
  
    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404164748209.png" alt="image-20200404164748209" style="zoom:50%;" />
  
  + 由于不重数不能重复使用，所以C在进行重放攻击时无法重复使用所截获的不重数
  
  + 在使用公钥密码体制时，可以对不重数进行签名鉴别，互相签名不重数验证
  
  + **中间人攻击**：
  
    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404165859640.png" alt="image-20200404165859640" style="zoom:50%;" />

## 7.5 密钥分配

+ 密钥管理包括：密钥的产生、分配、注入、验证和使用
+ **密钥分配（或密钥分发）**是密钥管理中最大的问题。密钥必须通过最安全的通路进行分配
  + **网外分配方式**：可靠信使携带分配给各用户
  + **网内分配方式**：密钥自动分配

### 7.5.1 对称密钥分配

+ 两个问题：

  1. 如果n个人中的每个需要和其他 n-1 个人通信，就需要n(n-1)个密钥，但每两个人共享一个密钥，因此密钥数是n(n-1)/2，这常称为**n^2^问题**

  2. 通信的双方怎样才能安全地得到共享的密钥呢？

     + 目前常用的密钥分配方式是设立**密钥分配中心KDC(Key Distribution Center)

     + 给需要进行秘密通信的用户临时分配一个会话密钥（仅使用一次）
     + A和B在KDC登记时就已经在KDC的服务器上安装上了各自和KDC进行通信的**主密钥(master key)**K~A~和K~B~

  

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171443555.png" alt="image-20200404171443555" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171556188.png" alt="image-20200404171556188" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171617178.png" alt="image-20200404171617178" style="zoom:50%;" />

+ Kerbros使用两个服务器：**鉴别服务器AS(Authentication Server)、票据授予服务器TGS(Ticket-Granting Server)**，Kerberos只用于客户与服务器之间的鉴别，而不用于人对人的鉴别

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171709448.png" alt="image-20200404171709448" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404172402585.png" alt="image-20200404172402585" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404172437127.png" alt="image-20200404172437127" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404172459810.png" alt="image-20200404172459810" style="zoom:50%;" />

### 7.5.2 公钥的分配

+ 需要一个值得信赖的机构来将公钥与其对应的实体进行**绑定(binding)**
+ 每个实体都有CA发来的**证书(certificate)**，里面有公钥及其拥有者的标识信息（人名或IP地址）

## 7.6 互联网使用的安全协议

### 7.6.1 网络层使用的安全协议

1. **IPsec协议族概述**

   + IPsec并不是一个单一的协议，而是能够在IP层提供互联网通信安全的**协议族**
+ IPsec是个框架，它允许通信双方选择合适的算法和参数
   + IPsec协议族中的协议可划分为以下三个部分：
     1. IP安全数据报格式的两个协议：**鉴别首部AH(Authentication Header)协议**和**封装安全有效载荷ESP(Encapsulation Security Payload)协议**
     2. 有关加密算法的三个协议
     3. **互联网密钥交换IKE(Internet Security Payload)协议**
   + 使用ESP或AH协议的IP数据报称为**IP安全数据报（或IPsec数据报）**
   + IP数据报有以下两种不同的工作方式
     1. **运输方式(transport mode)：**
        + 运输方式是在整个运输层报文段的前后分别添加若干控制信息，再加上IP数据报，构成IP安全数据报
     2. **隧道方式(tunnel mode)**：
        + 隧道方式是在原始的IP数据报的前后分别添加若干控制信息，再加上新的IP首部，构成一个安全数据报
   + 所谓”安全数据报“是指数据报的数据部分是经过加密的，并能够被鉴别。通常把数据报的数据部分称为数据报的**有效载荷(payload)**
   + 目前使用最多的就是隧道方式
   
2. **安全关联**

   + 发送IP安全数据报之前，在源实体和目的实体之间必须创建一条网络层的逻辑连接，即**安全关联SA(Security Association)**，**传统互联网中无连接的网络层就变为了具有逻辑连接的一个层**。

   + 安全关联是从源点到终点的单向连接，它能够提供安全服务

   + 总部的主机H~1~要和总部的另一台主机H~3~通信，由于都在公司内部，所以无需加密，因此不需要建立安全关联

   + H~1~要上网查看天气预报，同样不需要建立安全关联，而是发送IP数据报

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200407215845328.png" alt="image-20200407215845328" style="zoom:60%;" />

   + 现在是在路由器R~1~和业务员的主机H~2~之间构成了一个安全隧道

   + 外地业务员利用事先安装在H~2~中的IPsec对IP安全数据报进行鉴别和解密，还原H~1~发来的IP数据报

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200407220932035.png" alt="image-20200407220932035" style="zoom:60%;" />

   + 建立安全关联SA的路由器或主机，必须维护这条SA的状态信息

   + 状态信息应包括项目：

     1. 一个32位的连接标识符，称为**安全参数索引SPI(Security Parameter Index)**
     2. 安全关联SA的源点和终点的IP地址
     3. 所使用的加密类型
     4. 加密的密钥
     5. 完整性检查的类型（如MD5或SHA-1）
     6. 鉴别使用的密钥

     当路由器通过SA发送IP安全数据报时，就必须读取SA的状态信息，以便知道如何把IP数据报进行加密和鉴别

3. **IP安全数据报的格式**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200407221803806.png" alt="image-20200407221803806" style="zoom:67%;" />

   1. 首先在原始IP数据报（也就是ESP的有效载荷）后面添加ESP尾部

      + ESP尾部有三个字段：
        1. 填充字段，用全0填充
        2. 填充长度（8位），指出填充字段的字节数
        3. 下一个首部（8位）

   2. 按照安全关联SA指明的加密算法和密钥，对“ESP的有效载荷（即原始IP数据报）+ESP尾部“进行加密

   3. 对”加密的部分“完成加密后，就添加ESP首部

      + ESP首部有两个32位字段：

        1. 安全参数索引SPI

           通过同一个SA的所有IP安全数据报都使用同样的SPI值

        2. 序号

           鉴别要用此序号防止重放攻击，分组重传时序号并不重复

   4. 按照SA指明的算法和密钥，对”ESP首部+加密的部分“生成报文鉴别码MAC

   5. 把所生成的报文鉴别码MAC添加在ESP尾部的后面，和ESP首部、ESP的有效载荷、ESP尾部一起，构成IP安全数据报的有效载荷

   6. 生成新的IP首部，通常为20字节长，和普通的IP数据报的首部格式一样

   + 路由器R~2~找到IP首部的协议字段值，就把IP首部后面的所有字段（即IP安全数据报的有效载荷）都用ESP协议进行处理
     + 先检查ESP首部中的安全参数索引SPI，以确定收到的数据报属于哪一个安全关联SA（因为路由器R~2~可能有多个安全关联）
     + 路由器R~2~接着计算报文鉴别码MAC，看是否和ESP尾部后面添加的报文鉴别码MAC相符
     + 如是，即知收到的数据报的确是来自路由器R~1~，再检验ESP首部中的序号，以证实有无被入侵者重放，接着要用和这个安全关联SA对应的加密算法和密钥，对已加密的部分进行解密。再根据ESP尾部中的填充长度，去除发送端填充的所有0，还原出加密前的ESP有效载荷，即原始数据报
     + 根据解密后得到的ESP尾部中”下一个首部“的值，把ESP有效载荷交给IP来处理，找到目的主机时就传送过去，传送过程就此结束
   + 原始IP首部中，**主机H~1~和H~2~的IP地址分别为源地址与目的地址**
   + IP安全数据报的”新的IP首部“中，使用**路由器R~1~和R~2~的IP地址作为源地址与目的地址**
   + **完整性检验——差错信息、有效序号——重放攻击**

4. **IPsec其他构件**

   + **安全关联数据库SAD（Security Association Database）**
     + 当主机要发送IP安全数据报时，就要在SAD中查找相应的SA，以便获得必要的信息，来对该IP安全数据报实施安全保护。当主机要接收IP安全数据报时，也要在SAD中查找相应的SA，以便获得信息来检验该分组的安全性
   + **安全策略库SPD（Security Policy Database）**
     + 指明什么样的数据报需要进行IPsec处理
     + 取决于源地址、源端口、目的地址、目的端口，以及协议的类型等
     + 当一个IP数据报到达时，SPD指出应当做什么（使用IP安全数据报还是不使用），而SAD则指出，如果需要使用IP安全数据报，应当怎样做（使用哪个SA）
   + **互联网密钥交换IKE（Internet Key Exchange）协议**
     + IKE用途就是为IP安全数据报创建安全关联SA
     + IKEv2以另外三个协议为基础：
       + Oakley——是个密钥生成协议
       + **安全密钥交换机制SKEME（Secure Key Exchange Mechanism）**是用于密钥交换协议。利用公钥加密来实现密钥交换协议中的实体鉴别
       + **互联网安全关联和密钥管理协议ISAKMP（Internet Secure Association and Key Management Protocol）**用于实现IKE中定义的密钥交换，使IKE的交换能够以标准化、格式化的报文创建安全关联SA

### 7.6.2 运输层安全协议

+ **安全套接字层SSL（Secure Socket Layer）**
+ **运输层安全TLS（Transport Layer Security）**
+ SSL作用在端系统应用层的HTTP和运输层之间，在TCP之上建立起一个安全通道，为通过TCP传输的应用层数据提供安全保障

+ IETF在SSL 3.0基础上建立起一个安全通道，为通过TCP传输的应用层数据提供安全保障

+ 运输层原来还有一个**安全电子交易SET(Secure Electronic Transaction)协议，是专门用于在互联网上进行安全信用卡交易的协议**，但SET在市场竞争中失败了

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415113540155.png" alt="image-20200415113540155" style="zoom:50%;" />

+ 应用层使用SSL最多的就是HTTP，但SSL并非仅应用于HTTP，而是可用于任何应用层的协议

+ SSL也可用于IMAP邮件存取的鉴别与数据加密。使用普通不加密的浏览器查看网页时，HTTP就直接使用TCP连接，这时SSL不起作用，但使用信用卡进行网上支付，要键入信用卡密码时，就需要使用安全的浏览器

+ **SSL提供的安全服务可归纳为以下三种：**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415113857878.png" alt="image-20200415113857878" style="zoom:60%;" />

+ **SSL工作过程：**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415114028024.png" alt="image-20200415114028024" style="zoom:60%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415114056500.png" alt="image-20200415114056500" style="zoom:60%;" />

### 7.6.3 应用层安全协议

+ 电子邮件中没有会话存在，存在**单向报文安全问题**

+ 电子邮件的安全协议就应当为每种加密操作定义相应的算法，以便用户在其系统中使用

+ **在应用层为电子邮件提供安全服务的协议PGP**

  + PGP(Pretty Good Privacy)是Zimmermann在1995年开发的，是一个完整的电子邮件安全软件包，包括加密、鉴别、电子签名和压缩等技术

  + 虽然PGP广泛使用，并且成为了电子邮件的事实上的标准，但并不是互联网的正式标准

  + <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115240233.png" alt="image-20200415115240233" style="zoom:60%;" />

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115107091.png" alt="image-20200415115107091" style="zoom:50%;" />

  + <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115209554.png" alt="image-20200415115209554" style="zoom:60%;" />

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115316691.png" alt="image-20200415115316691" style="zoom:50%;" />

  + PGP很难被攻破，因此目前可认为PGP足够安全。

## 7.7 系统安全：防火墙与入侵检测

### 7.7.1 防火墙

+ **防火墙(firewall)**作为一种访问控制技术，通过严格控制进出网络边界的分组，禁止任何不必要的通信，从而减少潜在入侵的发生，尽可能降低这类安全威胁所带来的安全风险

+ 由于防火墙不能阻止所有入侵行为，作为系统防御的第二道防线，**入侵检测系统IDS(Intrusion Detection System)**通过对进入网络的分组进行深度分析与检测发现疑似入侵行为的网络活动，并进行报警以便进一步采取相应措施

+ **防火墙**是一种特殊编程的路由器，安装在一个网点和网络的其余部分之间，目的是实施访问控制策略。这个访问控制策略是由使用防火墙的单位自行制定。这种安全策略应当最适合本单位需要

+ 一般都把防火墙里面的网络称为“**可信的网络**“(trusted network)，而把防火墙外面的网络称为”**不可信网络**“(untrusted network)

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415121118850.png" alt="image-20200415121118850" style="zoom:67%;" />

+ 防火墙技术一般分为两类：
  1. **分组过滤路由器**是一种具有分组过滤功能的路由器，它根据过滤规则对进出内部网络的分组执行转发或丢弃（即过滤）。过滤规则是基于分组的网络层或运输层首部的信息
     + 分组过滤可以是无状态的，即独立地处理每一个分组。也可以是有状态的，即要跟踪每个连接或会话的通信状态，并根据这些状态信息来决定是否转发分组
     + 分组过滤路由器的优点是简单高效，且对于用户是透明的，但不能对高层数据进行过滤
  2. **应用网关**也称为**代理服务器(proxy server)**，它在应用层通信中扮演报文中继的角色。
     + 所有进出网络的应用程序报文都必须通过应用网关
     + 应用网关也有一些缺点
       + 首先每种应用都需要一个不同的应用网关
       + 其次，在应用层转发和处理报文，处理负担较重
       + 对应用程序不透明，需要在应用程序客户端配置应用网关地址
+ 通常可将这两种技术结合使用，包括两个分组过滤路由和一个应用网关

### 7.7.2 入侵检测系统

+ IDS对进入网络的分组执行深度分组检查，当观察到可疑分组时，向网络管理员发出告警或执行阻断操作（由于IDS误报率通常较高，多数情况不执行自动阻断）
+ 入侵检测方法一般可分为**基于特征的入侵检测**和**基于异常的入侵检测**两种：
  + 基于特征的IDS维护一个所有已知攻击标志性特征的数据库
  + 基于特征的IDS只能检测已知攻击，对于未知攻击束手无策
+ 对于特定IDS，可通过调整某些阈值来降低”漏报“率，但同时回增大”误报“率

## 7.8 一些未来方向

1. 椭圆曲线密码(Elliptic Curve Cryptography)与AES
2. 移动安全(Mobile Security)
3. 量子密码(Quantum Cryptography)



# Chapter 8 互联网上的音频/视频服务

## 8.1 概述

+ 利用互联网传送音频/视频信息，常称为**多媒体信息**

+ 使用电路交换的好处是：一旦连接建立了，即拨通了电话，各种信号在电话线路上的**传输质量就有保证**

+ 多媒体信息与不包括声音图像的数据信息有很大区别：
  1. **多媒体信息的信息量往往很大**
  2. **在传输多媒体数据时，对时延和时延抖动均有较高的要求**
  
+ 分组在发送时的时间间隔都是恒定的，通常称这样的分组为**等时的(isochronous)**，这种等时分组进入互联网的速率也是恒定的。传统的互联网本身是**非等时的**，使得分组在到达接收端时变成**非等时的**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415142808006.png" alt="image-20200415142808006" style="zoom:80%;" />

+ 可以在接收端设置适当大小的缓存，当缓存中的分组数达到一定数量后再以恒定速率按顺序将这些分组读出进行还原播放

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415142827980.png" alt="image-20200415142827980" style="zoom:80%;" />

+ 缓存实际上就是一个先进先出队列，T为播放时延，这就是从最初的分组开始到达缓存算起，经过时间T后就按固定时间间隔把缓存中的分组按先后顺序依次读出

+ 从缓存中取出分组是按照固定的时钟节拍进行的，因此，到达的非等时的分组，经过缓存后再以恒定速率读出，就变成了等时的分组（时延太大的分组就丢弃），很大程度上**消除了时延的抖动**，代价是增加时延

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415144354437.png" alt="image-20200415144354437" style="zoom:60%;" />

+ 在传送**实验敏感(delay sensitive)**的实时数据时，不仅**传输时延不能太大**，而且**时延抖动也必须受到限制**

+ 对于传送实时数据，我们**宁可丢失少量分组**，**也不要太晚到达的分组**，即**丢失容忍(loss tolerant)**也是实时数据的另一个重要特点

+ 由于分组的到达可能不按序，但将分组还原和播放时又应当是按序的。因此在发送多媒体分组时还应当给每一个分组加上序号。这表明还应当有相应的协议支持才行，需要时间戳来实现

+ 目前互联网提供的音频/视频服务大体上可分为三种类型：

  1. **流式(streaming)存储音频/视频**

     这种类型是先把已压缩的录制好的音频/视频文件存储在服务器上，用户通过互联网下载这样的文件

  2. **流式实况音频/视频**

     这种类型和无线电台或电视台的实况广播相似，不同之处是音频/视频节目的广播是通过互联网传送的。流式实况音频/视频是一对多（而不是一对一）的通信。它的特点是：音频/视频节目不是事先录制好和存储在服务器中的，而是在发送方**边录制边发送**

  3. **交互式音频/视频**

     这种类型是用户使用互联网和其他人进行实时交互式通信

+ **流媒体(streaming media)**就是上面所说的流式音频/视频

## 8.2 流式存储音频/视频

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153508008.png" alt="image-20200415153508008" style="zoom:60%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153531647.png" alt="image-20200415153531647" style="zoom:50%;" />

### 8.2.1 具有元文件的万维网服务器

+ 在万维网服务器中，除了真正的音频/视频文件外，还增加了一个**元文件(metafile)**，它是一种非常小的文件，描述或指明**其他文件**的一些重要信息

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153841242.png" alt="image-20200415153841242" style="zoom:50%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153914517.png" alt="image-20200415153914517" style="zoom:50%;" />

### 8.2.2 媒体服务器

+ 为了更好提供播放流式音频/视频文件服务，现在最为流行的做法就是使用两个分开的服务器

+ 使用一个普通的万维网服务器和一个媒体服务器(media server)

+ 媒体服务器和万维网服务器可以运行在一个端系统内，也可运行在两个不同的端系统中，媒体服务器与普通的万维网服务器的最大区别就是，媒体服务器是专门为播放流式音频/视频文件而设计的，因此能够更加有效地为用户提供播放流式多媒体文件的服务，因此媒体服务器也常被称为**流式服务器(streaming server)**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415154532077.png" alt="image-20200415154532077" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416172452788.png" alt="image-20200416172452788" style="zoom:50%;" />

+ 传送音频/视频文件可以使用TCP，也可以使用UDP。

+ UDP传送会有以下几个缺点：

  1. 发送端按正常播放的速率发送流媒体数据帧，但由于网络的情况多变，在接收端的播放器很难做到始终按规定的速率播放
  2. 很多单位的防火墙往往阻拦外部UDP分组的进入，因而使用UDP传送多媒体文件时会被拦截
  3. 使用UDP时若用户希望在客户端能够控制媒体的播放，会增加成本的复杂性

+ 现在对流式存储音频/视频的播放，都采用TCP来传送

+ <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416172904190.png" alt="image-20200416172904190" style="zoom:67%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416172930169.png" alt="image-20200416172930169" style="zoom:50%;" />

  + 只有步骤4的读出速率为原规定速率播放，前三速率任意，缓存的功能就是保证在资源足够时为用户提供原速播放的体验
  + 实践证明，只要步骤2的TCP的平均传送速率达到视频节目规定的播放速率的两倍，媒体播放器一般就能流畅地播放网上的视频节目
  + **实况直播最好使用UDP**，如果使用TCP传送，则当出现网络严重拥塞而产生播放暂停时会比丢失分组造成的卡顿更难以接受

### 8.2.3 实时流式协议RTSP

+ **实时流式协议RTSP(Real-Time Streaming Protocol)**

+ RTSP是为了给流式过程增加更多的功能而设计的协议。RTSP本身并不传送数据，而仅仅是使媒体播放器能够**控制**多媒体流的传送，因此RTSP又称为**带外协议(out-of-band protocol)**

+ RTSP协议以C/S方式工作，它是一个应用层的**多媒体播放控制协议**，用来使用户在播放从互联网下载的实时数据时能够进行控制，因此，RTSP又称为**互联网录像机遥控协议**

+ RTSP是有状态的协议，记录客户机所处于的状态

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416173832801.png" alt="image-20200416173832801" style="zoom:50%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416173844913.png" alt="image-20200416173844913" style="zoom:50%;" />

  + 音频/视频文件被下载，所用的协议是运行在UDP上的，可以是后面要介绍的RTP，也可以是其他专用的协议，可实现随时对播放文件的操作

## 8.3 交互式音频/视频

### 8.3.1 IP电话简述

1. **狭义的和广义的IP电话**

   + 狭义的IP电话是指在IP网络上打电话（IP网络就是使用IP协议的分组交换网）
   + 广义的IP电话不仅仅指电话通信，还可以是在IP网络上进行交互式多媒体实时通信，甚至还包括**即时传信IM(Instant Messaging)**
   + 分组话音通话（在计算机网络上传送电话信息）
   + 分组话音通信发展并不快，原因有：
     + 缺少软硬件支持
     + 处理速率不够
     + 没有保证实时通信**服务质量QoS(Quality of Service)**的网络协议
     + 计算机网络的规模小，而通信网只有在具有一定规模后才能产生经济效益

2. **IP电话网关**

   + 1996年3月，IP电话进入转折点：VocalTec公司成功推出**IP电话网关(IP Telephony Gateway)**，它是公用电话网与IP网络的接口设备。IP电话网关的作用就是：

     + 在电话呼叫阶段和呼叫释放阶段**进行电话信令的转换**
     + 在通话期间**进行话音编码的转换**

   + **注意电路交换部分与分组交换分别是哪部分**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416175029383.png" alt="image-20200416175029383" style="zoom:60%;" />

3. **IP电话的通话质量**

   + **两方面因素决定：**

     + **通话双方端到端的时延和时延抖动**
     + **话音分组的丢失率**

   + **还取决于当时网络上的通信量**

   + 网络上的通信量非常大以致发生了网络拥塞，那么端到端时延和时延抖动以及分组丢失率都很高，这就导致IP电话的通信质量下降

   + 一个用户使用IP电话的通话质量**取决于当时其他许多其他用户的行为**

   + 当电路交换电话网的通信量太大时，往往使我们无法拨通电话，即电话网拒绝对正在拨号的用户提供接通服务。但是只是我们拨通了电话，那么电信公司就能保证让用户满意的通话质量

   + IP电话端到端时延是由以下几个因素造成的：

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416181009491.png" alt="image-20200416181009491" style="zoom:60%;" />

   + 