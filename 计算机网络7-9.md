# Chapter 7 网络安全

本章重要内容

+ 计算机网络面临的安全性威胁和计算机网络安全的主要问题
+ 对称密钥密码体制和公钥密码体制的特点
+ 数字签名与鉴别的概念
+ 网络层安全协议IPsec协议族和运输层安全协议SSL/TLS的要点
+ 应用层电子邮件的安全措施
+ 系统安全：防火墙与入侵检测

## 7.1 网络安全问题概述

### 7.1.1 计算机网络面临的安全性威胁

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329155454668.png" alt="image-20200329155454668" style="zoom:60%;" />

+ 计算机网络通信面临两大类威胁：

  + **被动攻击**

    + 攻击者从网络上窃听他人的通信内容
    + 通常称**截获**
    + 攻击者只是观察和分析某一个协议数据单元PDU而不干扰信息流，也可通过观察PDU的协议控制信息部分，了解正在通信协议实体的地址和身份，研究PDU的长度和传输的频度，从而了解所交换数据的某种性质，又称**流量分析(traffic analysis)**

  + **主动攻击**

    + 有如下几种最常见的方式：

      1. **篡改**

         攻击者故意篡改网络上传送的报文，包括彻底中断传送的报文，把完全伪造的报文传送给接收方。该攻击方式有时称更改报文流。

      2. **恶意程序**

         有以下几种：

         + **计算机病毒(computer virus)**

           一种会**传染**其他程序的程序，通过修改其他程序把自身或自己的变种复制进去完成

         + **计算机蠕虫(computer worm)**

           通过网络通信功能将自身从一个结点发送到另一个结点并自动启动运行的程序

         + **特洛伊木马(Trojan horse)**

           挂羊头卖狗肉

         + **逻辑炸弹(logic bomb)**

           当计算机的某些参数达到一定条件会执行特殊功能

         + **后门入侵(backdoor knocking)**

           利用系统实现中的漏洞通过网络入侵系统

         + **流氓软件**

           未经用户允许就在用户计算机上安装运行并损害用户利益的软件

      3. **拒绝服务DoS(Denial of Service)**

         + 攻击者向互联网上某个服务器不停发送大量分组，使该服务器无法提供正常服务，甚至完全瘫痪
         + 若从互联网上的成百上千个网站集中攻击一个网站，则称为**分布式拒绝服务DDoS(Distributed Denial of Service)**。有时也称此攻击为**网络带宽攻击**或**连通性攻击**

    + 对于主动攻击可以采取适当措施加以检测。但对于被动攻击，通常检测不出

  + 计算机网络通信安全的目标如下：

    1. 防止析出报文内容和流量分析
    2. 防止恶意程序
    3. 检测更改报文流和拒绝服务

  + 对付被动攻击可采用各种数据加密技术，而对付主动攻击，则需将加密技术与适当鉴别技术结合

### 7.1.2 安全的计算机网络

+ 网络的安全性是不可判定的
+ 保证所设计的协议是安全的方法有两种：
  + 形式化方法
    + 形式化方法证明比较困难，主要采用人工分析方法来找漏洞
  + 用经验分析协议的安全性
+ 安全的计算机网络应设法达到以下四个目标：
  1. **保密性**
     + 保密性就是只有信息的发送方和接收方才能懂得所发送信息的内容，而信息的截获者则看不懂所截获的信息
  2. **断电鉴别**
     + 安全的计算机网络必须能够鉴别信息的发送方和接收方的真实身份
  3. **信息的完整性**
     + 即使能够确认发送方的身份是真实的，并且所发送的信息都是经过加密的，我们依然不能认为网络是安全的
     + 既鉴别发送方的身份，又鉴别报文的完整性
  4. **运行的安全性**
     + 现在的机构与计算机网络的关系越密切，就越要重视计算机网络运行的安全性
+ **访问控制(access control)**十分必要，必须对访问网络的权限加以控制，并规定每个用户的访问权限，**多级安全(multilevel security)**也很重要

### 7.1.3 数据加密模型

+ 用户A向B发送**明文X**，但通过**加密算法E**运算后就得出**密文Y**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329155934604.png" alt="image-20200329155934604" style="zoom:60%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329160248985.png" alt="image-20200329160248985" style="zoom:50%;" />

+ **密码编码学(cryptography)**是密码体制的设计学，而**密码分析学(cryptanalysis)**则是在未知密钥的情况下从密文推演出明文或密钥的技术。密码编码学与密码分析学合称**密码学(cryptology)**
+ 如果不论截取者获得多少密文，但在密文中都没有足够的信息来唯一地确定出对应的明文，则这一密码体制称为**无条件安全的**，或称为**理论上是不可破的**
+ **目前几乎所有的密码体制均是可破的**
+ 人们关心的是要研制出**在计算上（而不是在理论上）是不可破的密码体制**
+ 如果一个密码体制中的密码，不能在一定时间内被可以使用的计算资源破译，则这一密码体制称为**在计算上是安全的**
+ 20世纪70年代后期，美国的**数据加密标准DES(Data Encryption Standard)**和**公钥密码体制(public key crypto-system)**，成为近代密码学发展史上的两个重要里程碑

## 7.2 两类密码体制

### 7.2.1 对称密钥密码体制

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329163606548.png" alt="image-20200329163606548" style="zoom:67%;" />

+ **对称密钥密码体制**，即**加密密钥与解密密钥是使用相同的密码体制**

+ **数据加密标准DES**属于对称密钥密码体制

+ **DES**是一种分组密码：

  1. 加密前先对整个明文进行分组，每组是64位长的二进制数据
  2. 对每个64位二进制数据进行加密处理，产生一组64位密文数据
  3. 最后将各组密文串接起来，即得出整个的密文。使用的密钥占有64位（实际长56位，外加8位用于奇偶校验）

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329163756189.png" alt="image-20200329163756189" style="zoom:50%;" />

+ **DES的保密性仅取决于对密钥的保密，而算法是公开的**

+ 现在对于56位DES密钥的搜索已成常态，56位DES已不再被认为是安全的

+ 三重DES

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329163826194.png" alt="image-20200329163826194" style="zoom:50%;" />

### 7.2.2 公钥密码体制

+ 公钥密码体制**使用不同的加密密钥与解密密钥**

+ 公钥密码的产生主要有两方面原因：

  + 对称密钥密码体制的**密钥分配**问题
  + 由于对**数字签名**的需求

+ **密钥分配中心KDC(Key Distribution Center)**

+ 公钥密码体制中，**加密密钥PK（public key，公钥）**向公众公开，而**解密密钥SK（secret key，即私钥或密钥）**则需要保密。加密算法E和解密算法D也都是公开的

+ 公钥密码体制的加密和解密过程有如下特点：

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329164957935.png" alt="image-20200329164957935" style="zoom:50%;" />

  + 虽然在计算机上可以容易地产生成对的PK~B~和SK~B~，但从已知的PK~B~实际上不可能推导出SK~B~，即从PK~B~到SK~B~是“**计算上不可能的**”
  + 虽然公钥可用来加密，但不能用来解密
  + 先后对X进行D运算和E运算或进行E运算和D运算，结果都相同

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200329165609547.png" alt="image-20200329165609547" style="zoom:50%;" />

+ 公开密钥与对称密钥在使用通信信道方面有很大不同，在使用对称密钥时，由于双方用相同的密钥，因此在通信信道上可以进行**一对一的双向保密通信**，每一方既可用此密钥加密明文，并发送给对方，也可接收密文，用同一密钥对密文解密。这种保密通信仅限于持有此密钥的双方（有第三方则不保密）。但在使用公开密钥时，在通信信道上可以是**多对一的单向保密通信**

+ **任何加密方法的安全性取决于密钥的长度，以及攻破密文所需的计算量**，而不是简单地取决于加密的体制

+ 公钥加密算法的**开销较大**

## 7.3 数字签名

+ 数字签名必须保证能够实现以下三点功能：

  1. **报文鉴别**

     接收者能够核实发送者对报文的签名，其他人无法伪造对报文的签名

  2. **报文的完整性**

     接收者确信所收到的数据和发送者发送的完全一样而没有被篡改过

  3. **不可否认**

     + 发送者事后不能抵赖对报文的签名，叫做**不可否认**
     + 现在已有多种实现数字签名的方法。但采用公钥算法要比采用对称密钥算法更容易实现

+ 签名并非为了保密，而是为了进行签名和核实签名，即确认此明文的确是A发送的

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404160724875.png" alt="image-20200404160724875" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404160838558.png" alt="image-20200404160838558" style="zoom:50%;" />

## 7.4 鉴别

+ **鉴别是要验证通信的对方的确是自己所要通信的对象，而不是其他的冒充者，并且所传送的报文是完整的，没有被他人篡改过**
+ 授权涉及的问题是：所进行的过程是否被允许（如是否可以对某文件进行读或写）
+ 可再把鉴别细分两种：
  + **报文鉴别：**
    + 鉴别所收到的报文的确是报文的发送者发送的，而不是其他人伪造的或篡改的
    + 包含了端点鉴别和报文完整性的鉴别
  + **实体鉴别：**
    + 仅仅鉴别发送报文的实体
    + 实体可以是一个人，也可以是一个进程，这就是端点鉴别

### 7.4.1 报文鉴别

1. **密码散列函数**

   + 对较长的报文进行数字签名会使计算机增加非常大的负担
   + **密码散列函数(cryptographic hash function)**
   + 检验和就是散列函数的一种应用，用于发现数据在传输过程中的比特差错

   + 散列函数具有以下两个特点：
     1. 散列函数的输入长度可以很长，但其**输出长度则是固定的，并且较短**，散列函数的输出叫做**散列值**，或简称**散列**
     2. 不同的散列值肯定对应于不同的输入，但不同的输入却可能得出相同的散列值，亦即散列函数的输入与输出并非一一对应，是多对一的
   + 密码散列函数实际上是一种**单向函数(one-way function)**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404162218182.png" alt="image-20200404162218182" style="zoom:50%;" />

   + 散列H(X)可用来保护明文X的完整性

2. **实用的密码散列函数MD5和SHA-1**

   + MD是Message Digest的缩写，意思是**报文摘要**
   + MD5最终被另一种叫做**安全散列算法SHA(Secure Hash Algorithm)**的标准所取代
   + MD5算法大致过程：
     1. 先把任意长报文按模2^64^计算其余数（64位），追加在报文的后面
     2. 在报文和余数之间填充1~512位，使得填充后的总长度是512的整数倍，填充的首位是1，后面都是0
     3. 把追加和填充后的报文分割为一个个512位的数据块，每个512位的报文数据再分成4个128位的数据块依次送到不同的散列函数进行4轮计算，每一轮又都按32位的小数据块进行复杂的运算。一直到最后计算出MD5报文摘要代码（128位）
   + 这样得出的MD5报文摘要代码中的每一位都与原来报文中的每一位有关。像MD5这样的密码散列函数实际上已经是个相当复杂的算法，而不是简单的函数了
   + SHA是由美国标准与技术协会NIST提出的一个散列算法系列
   + **SHA比MD5更安全，但计算起来却比MD5要慢一点**

3. **报文鉴别码**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404163523935.png" alt="image-20200404163523935" style="zoom:50%;" />

   + 在A从报文X导出散列H后，就对散列H用密钥K加密。这样得出的结果叫做**报文鉴别码MAC(Message Authentication Code)**
   + 加密后得到的扩展报文，不仅不可伪造，也不可否认

### 7.4.2 实体鉴别

+ 实体鉴别和报文鉴别不同

  + **报文鉴别**是**对每一个收到的报文都要鉴别报文的发送者**
  + **实体鉴别**是**在系统接入的全部持续时间内对和自己通信的对方实体只需验证一次**

+ **鉴别过程**

  + A向远端的B发送带有自己身份A和口令的报文，并且使用双方约定好的共享对称密钥K~AB~进行加密

  + B收到此报文后，用共享对称密钥K~AB~进行解密，从而鉴别了实体A的身份

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404164401613.png" alt="image-20200404164401613" style="zoom:55%;" /> 

  + **重放攻击(replay attack)**可通过**不重数(nonce)**避免，不重数可以使B能够把重复的鉴别请求和新的鉴别请求区分开

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404164748209.png" alt="image-20200404164748209" style="zoom:50%;" />

  + 由于不重数不能重复使用，所以C在进行重放攻击时无法重复使用所截获的不重数

  + 在使用公钥密码体制时，可以对不重数进行签名鉴别，互相签名不重数验证

  + **中间人攻击**：

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404165859640.png" alt="image-20200404165859640" style="zoom:50%;" />

## 7.5 密钥分配

+ 密钥管理包括：密钥的产生、分配、注入、验证和使用
+ **密钥分配（或密钥分发）**是密钥管理中最大的问题。密钥必须通过最安全的通路进行分配
  + **网外分配方式**：可靠信使携带分配给各用户
  + **网内分配方式**：密钥自动分配

### 7.5.1 对称密钥分配

+ 两个问题：

  1. 如果n个人中的每个需要和其他 n-1 个人通信，就需要n(n-1)个密钥，但每两个人共享一个密钥，因此密钥数是n(n-1)/2，这常称为**n^2^问题**

  2. 通信的双方怎样才能安全地得到共享的密钥呢？

     + 目前常用的密钥分配方式是设立**密钥分配中心KDC(Key Distribution Center)

     + 给需要进行秘密通信的用户临时分配一个会话密钥（仅使用一次）
     + A和B在KDC登记时就已经在KDC的服务器上安装上了各自和KDC进行通信的**主密钥(master key)**K~A~和K~B~

  

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171443555.png" alt="image-20200404171443555" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171556188.png" alt="image-20200404171556188" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171617178.png" alt="image-20200404171617178" style="zoom:50%;" />

+ Kerbros使用两个服务器：**鉴别服务器AS(Authentication Server)、票据授予服务器TGS(Ticket-Granting Server)**，Kerberos只用于客户与服务器之间的鉴别，而不用于人对人的鉴别

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404171709448.png" alt="image-20200404171709448" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404172402585.png" alt="image-20200404172402585" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404172437127.png" alt="image-20200404172437127" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200404172459810.png" alt="image-20200404172459810" style="zoom:50%;" />

### 7.5.2 公钥的分配

+ 需要一个值得信赖的机构来将公钥与其对应的实体进行**绑定(binding)**
+ 每个实体都有CA发来的**证书(certificate)**，里面有公钥及其拥有者的标识信息（人名或IP地址）

## 7.6 互联网使用的安全协议

### 7.6.1 网络层使用的安全协议

1. **IPsec协议族概述**

   + IPsec并不是一个单一的协议，而是能够在IP层提供互联网通信安全的**协议族**

+ IPsec是个框架，它允许通信双方选择合适的算法和参数
  + IPsec协议族中的协议可划分为以下三个部分：
    1. IP安全数据报格式的两个协议：**鉴别首部AH(Authentication Header)协议**和**封装安全有效载荷ESP(Encapsulation Security Payload)协议**
    2. 有关加密算法的三个协议
    3. **互联网密钥交换IKE(Internet Security Payload)协议**
  + 使用ESP或AH协议的IP数据报称为**IP安全数据报（或IPsec数据报）**
  + IP数据报有以下两种不同的工作方式
    1. **运输方式(transport mode)：**
       + 运输方式是在整个运输层报文段的前后分别添加若干控制信息，再加上IP数据报，构成IP安全数据报
    2. **隧道方式(tunnel mode)**：
       + 隧道方式是在原始的IP数据报的前后分别添加若干控制信息，再加上新的IP首部，构成一个安全数据报
  + 所谓”安全数据报“是指数据报的数据部分是经过加密的，并能够被鉴别。通常把数据报的数据部分称为数据报的**有效载荷(payload)**
  + 目前使用最多的就是隧道方式

2. **安全关联**

   + 发送IP安全数据报之前，在源实体和目的实体之间必须创建一条网络层的逻辑连接，即**安全关联SA(Security Association)**，**传统互联网中无连接的网络层就变为了具有逻辑连接的一个层**。

   + 安全关联是从源点到终点的单向连接，它能够提供安全服务

   + 总部的主机H~1~要和总部的另一台主机H~3~通信，由于都在公司内部，所以无需加密，因此不需要建立安全关联

   + H~1~要上网查看天气预报，同样不需要建立安全关联，而是发送IP数据报

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200407215845328.png" alt="image-20200407215845328" style="zoom:60%;" />

   + 现在是在路由器R~1~和业务员的主机H~2~之间构成了一个安全隧道

   + 外地业务员利用事先安装在H~2~中的IPsec对IP安全数据报进行鉴别和解密，还原H~1~发来的IP数据报

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200407220932035.png" alt="image-20200407220932035" style="zoom:60%;" />

   + 建立安全关联SA的路由器或主机，必须维护这条SA的状态信息

   + 状态信息应包括项目：

     1. 一个32位的连接标识符，称为**安全参数索引SPI(Security Parameter Index)**
     2. 安全关联SA的源点和终点的IP地址
     3. 所使用的加密类型
     4. 加密的密钥
     5. 完整性检查的类型（如MD5或SHA-1）
     6. 鉴别使用的密钥

     当路由器通过SA发送IP安全数据报时，就必须读取SA的状态信息，以便知道如何把IP数据报进行加密和鉴别

3. **IP安全数据报的格式**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200407221803806.png" alt="image-20200407221803806" style="zoom:67%;" />

   1. 首先在原始IP数据报（也就是ESP的有效载荷）后面添加ESP尾部

      + ESP尾部有三个字段：
        1. 填充字段，用全0填充
        2. 填充长度（8位），指出填充字段的字节数
        3. 下一个首部（8位）

   2. 按照安全关联SA指明的加密算法和密钥，对“ESP的有效载荷（即原始IP数据报）+ESP尾部“进行加密

   3. 对”加密的部分“完成加密后，就添加ESP首部

      + ESP首部有两个32位字段：

        1. 安全参数索引SPI

           通过同一个SA的所有IP安全数据报都使用同样的SPI值

        2. 序号

           鉴别要用此序号防止重放攻击，分组重传时序号并不重复

   4. 按照SA指明的算法和密钥，对”ESP首部+加密的部分“生成报文鉴别码MAC

   5. 把所生成的报文鉴别码MAC添加在ESP尾部的后面，和ESP首部、ESP的有效载荷、ESP尾部一起，构成IP安全数据报的有效载荷

   6. 生成新的IP首部，通常为20字节长，和普通的IP数据报的首部格式一样

   + 路由器R~2~找到IP首部的协议字段值，就把IP首部后面的所有字段（即IP安全数据报的有效载荷）都用ESP协议进行处理
     + 先检查ESP首部中的安全参数索引SPI，以确定收到的数据报属于哪一个安全关联SA（因为路由器R~2~可能有多个安全关联）
     + 路由器R~2~接着计算报文鉴别码MAC，看是否和ESP尾部后面添加的报文鉴别码MAC相符
     + 如是，即知收到的数据报的确是来自路由器R~1~，再检验ESP首部中的序号，以证实有无被入侵者重放，接着要用和这个安全关联SA对应的加密算法和密钥，对已加密的部分进行解密。再根据ESP尾部中的填充长度，去除发送端填充的所有0，还原出加密前的ESP有效载荷，即原始数据报
     + 根据解密后得到的ESP尾部中”下一个首部“的值，把ESP有效载荷交给IP来处理，找到目的主机时就传送过去，传送过程就此结束
   + 原始IP首部中，**主机H~1~和H~2~的IP地址分别为源地址与目的地址**
   + IP安全数据报的”新的IP首部“中，使用**路由器R~1~和R~2~的IP地址作为源地址与目的地址**
   + **完整性检验——差错信息、有效序号——重放攻击**

4. **IPsec其他构件**

   + **安全关联数据库SAD（Security Association Database）**
     + 当主机要发送IP安全数据报时，就要在SAD中查找相应的SA，以便获得必要的信息，来对该IP安全数据报实施安全保护。当主机要接收IP安全数据报时，也要在SAD中查找相应的SA，以便获得信息来检验该分组的安全性
   + **安全策略库SPD（Security Policy Database）**
     + 指明什么样的数据报需要进行IPsec处理
     + 取决于源地址、源端口、目的地址、目的端口，以及协议的类型等
     + 当一个IP数据报到达时，SPD指出应当做什么（使用IP安全数据报还是不使用），而SAD则指出，如果需要使用IP安全数据报，应当怎样做（使用哪个SA）
   + **互联网密钥交换IKE（Internet Key Exchange）协议**
     + IKE用途就是为IP安全数据报创建安全关联SA
     + IKEv2以另外三个协议为基础：
       + Oakley——是个密钥生成协议
       + **安全密钥交换机制SKEME（Secure Key Exchange Mechanism）**是用于密钥交换协议。利用公钥加密来实现密钥交换协议中的实体鉴别
       + **互联网安全关联和密钥管理协议ISAKMP（Internet Secure Association and Key Management Protocol）**用于实现IKE中定义的密钥交换，使IKE的交换能够以标准化、格式化的报文创建安全关联SA

### 7.6.2 运输层安全协议

+ **安全套接字层SSL（Secure Socket Layer）**

+ **运输层安全TLS（Transport Layer Security）**

+ SSL作用在端系统应用层的HTTP和运输层之间，在TCP之上建立起一个安全通道，为通过TCP传输的应用层数据提供安全保障

+ IETF在SSL 3.0基础上建立起一个安全通道，为通过TCP传输的应用层数据提供安全保障

+ 运输层原来还有一个**安全电子交易SET(Secure Electronic Transaction)协议，是专门用于在互联网上进行安全信用卡交易的协议**，但SET在市场竞争中失败了

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415113540155.png" alt="image-20200415113540155" style="zoom:50%;" />

+ 应用层使用SSL最多的就是HTTP，但SSL并非仅应用于HTTP，而是可用于任何应用层的协议

+ SSL也可用于IMAP邮件存取的鉴别与数据加密。使用普通不加密的浏览器查看网页时，HTTP就直接使用TCP连接，这时SSL不起作用，但使用信用卡进行网上支付，要键入信用卡密码时，就需要使用安全的浏览器

+ **SSL提供的安全服务可归纳为以下三种：**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415113857878.png" alt="image-20200415113857878" style="zoom:60%;" />

+ **SSL工作过程：**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415114028024.png" alt="image-20200415114028024" style="zoom:60%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415114056500.png" alt="image-20200415114056500" style="zoom:60%;" />

### 7.6.3 应用层安全协议

+ 电子邮件中没有会话存在，存在**单向报文安全问题**

+ 电子邮件的安全协议就应当为每种加密操作定义相应的算法，以便用户在其系统中使用

+ **在应用层为电子邮件提供安全服务的协议PGP**

  + PGP(Pretty Good Privacy)是Zimmermann在1995年开发的，是一个完整的电子邮件安全软件包，包括加密、鉴别、电子签名和压缩等技术

  + 虽然PGP广泛使用，并且成为了电子邮件的事实上的标准，但并不是互联网的正式标准

  + <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115240233.png" alt="image-20200415115240233" style="zoom:60%;" />

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115107091.png" alt="image-20200415115107091" style="zoom:50%;" />

  + <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115209554.png" alt="image-20200415115209554" style="zoom:60%;" />

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415115316691.png" alt="image-20200415115316691" style="zoom:50%;" />

  + PGP很难被攻破，因此目前可认为PGP足够安全。

## 7.7 系统安全：防火墙与入侵检测

### 7.7.1 防火墙

+ **防火墙(firewall)**作为一种访问控制技术，通过严格控制进出网络边界的分组，禁止任何不必要的通信，从而减少潜在入侵的发生，尽可能降低这类安全威胁所带来的安全风险

+ 由于防火墙不能阻止所有入侵行为，作为系统防御的第二道防线，**入侵检测系统IDS(Intrusion Detection System)**通过对进入网络的分组进行深度分析与检测发现疑似入侵行为的网络活动，并进行报警以便进一步采取相应措施

+ **防火墙**是一种特殊编程的路由器，安装在一个网点和网络的其余部分之间，目的是实施访问控制策略。这个访问控制策略是由使用防火墙的单位自行制定。这种安全策略应当最适合本单位需要

+ 一般都把防火墙里面的网络称为“**可信的网络**“(trusted network)，而把防火墙外面的网络称为”**不可信网络**“(untrusted network)

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415121118850.png" alt="image-20200415121118850" style="zoom:67%;" />

+ 防火墙技术一般分为两类：

  1. **分组过滤路由器**是一种具有分组过滤功能的路由器，它根据过滤规则对进出内部网络的分组执行转发或丢弃（即过滤）。过滤规则是基于分组的网络层或运输层首部的信息
     + 分组过滤可以是无状态的，即独立地处理每一个分组。也可以是有状态的，即要跟踪每个连接或会话的通信状态，并根据这些状态信息来决定是否转发分组
     + 分组过滤路由器的优点是简单高效，且对于用户是透明的，但不能对高层数据进行过滤
  2. **应用网关**也称为**代理服务器(proxy server)**，它在应用层通信中扮演报文中继的角色。
     + 所有进出网络的应用程序报文都必须通过应用网关
     + 应用网关也有一些缺点
       + 首先每种应用都需要一个不同的应用网关
       + 其次，在应用层转发和处理报文，处理负担较重
       + 对应用程序不透明，需要在应用程序客户端配置应用网关地址

+ 通常可将这两种技术结合使用，包括两个分组过滤路由和一个应用网关

### 7.7.2 入侵检测系统

+ IDS对进入网络的分组执行深度分组检查，当观察到可疑分组时，向网络管理员发出告警或执行阻断操作（由于IDS误报率通常较高，多数情况不执行自动阻断）
+ 入侵检测方法一般可分为**基于特征的入侵检测**和**基于异常的入侵检测**两种：
  + 基于特征的IDS维护一个所有已知攻击标志性特征的数据库
  + 基于特征的IDS只能检测已知攻击，对于未知攻击束手无策
+ 对于特定IDS，可通过调整某些阈值来降低”漏报“率，但同时回增大”误报“率

## 7.8 一些未来方向

1. 椭圆曲线密码(Elliptic Curve Cryptography)与AES
2. 移动安全(Mobile Security)
3. 量子密码(Quantum Cryptography)



# Chapter 8 互联网上的音频/视频服务

## 8.1 概述

+ 利用互联网传送音频/视频信息，常称为**多媒体信息**

+ 使用电路交换的好处是：一旦连接建立了，即拨通了电话，各种信号在电话线路上的**传输质量就有保证**

+ 多媒体信息与不包括声音图像的数据信息有很大区别：

  1. **多媒体信息的信息量往往很大**
  2. **在传输多媒体数据时，对时延和时延抖动均有较高的要求**

+ 分组在发送时的时间间隔都是恒定的，通常称这样的分组为**等时的(isochronous)**，这种等时分组进入互联网的速率也是恒定的。传统的互联网本身是**非等时的**，使得分组在到达接收端时变成**非等时的**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415142808006.png" alt="image-20200415142808006" style="zoom:80%;" />

+ 可以在接收端设置适当大小的缓存，当缓存中的分组数达到一定数量后再以恒定速率按顺序将这些分组读出进行还原播放

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415142827980.png" alt="image-20200415142827980" style="zoom:80%;" />

+ 缓存实际上就是一个先进先出队列，T为播放时延，这就是从最初的分组开始到达缓存算起，经过时间T后就按固定时间间隔把缓存中的分组按先后顺序依次读出

+ 从缓存中取出分组是按照固定的时钟节拍进行的，因此，到达的非等时的分组，经过缓存后再以恒定速率读出，就变成了等时的分组（时延太大的分组就丢弃），很大程度上**消除了时延的抖动**，代价是增加时延

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415144354437.png" alt="image-20200415144354437" style="zoom:60%;" />

+ 在传送**实验敏感(delay sensitive)**的实时数据时，不仅**传输时延不能太大**，而且**时延抖动也必须受到限制**

+ 对于传送实时数据，我们**宁可丢失少量分组**，**也不要太晚到达的分组**，即**丢失容忍(loss tolerant)**也是实时数据的另一个重要特点

+ 由于分组的到达可能不按序，但将分组还原和播放时又应当是按序的。因此在发送多媒体分组时还应当给每一个分组加上序号。这表明还应当有相应的协议支持才行，需要时间戳来实现

+ 目前互联网提供的音频/视频服务大体上可分为三种类型：

  1. **流式(streaming)存储音频/视频**

     这种类型是先把已压缩的录制好的音频/视频文件存储在服务器上，用户通过互联网下载这样的文件

  2. **流式实况音频/视频**

     这种类型和无线电台或电视台的实况广播相似，不同之处是音频/视频节目的广播是通过互联网传送的。流式实况音频/视频是一对多（而不是一对一）的通信。它的特点是：音频/视频节目不是事先录制好和存储在服务器中的，而是在发送方**边录制边发送**

  3. **交互式音频/视频**

     这种类型是用户使用互联网和其他人进行实时交互式通信

+ **流媒体(streaming media)**就是上面所说的流式音频/视频

## 8.2 流式存储音频/视频

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153508008.png" alt="image-20200415153508008" style="zoom:60%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153531647.png" alt="image-20200415153531647" style="zoom:50%;" />

### 8.2.1 具有元文件的万维网服务器

+ 在万维网服务器中，除了真正的音频/视频文件外，还增加了一个**元文件(metafile)**，它是一种非常小的文件，描述或指明**其他文件**的一些重要信息

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153841242.png" alt="image-20200415153841242" style="zoom:50%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415153914517.png" alt="image-20200415153914517" style="zoom:50%;" />

### 8.2.2 媒体服务器

+ 为了更好提供播放流式音频/视频文件服务，现在最为流行的做法就是使用两个分开的服务器

+ 使用一个普通的万维网服务器和一个媒体服务器(media server)

+ 媒体服务器和万维网服务器可以运行在一个端系统内，也可运行在两个不同的端系统中，媒体服务器与普通的万维网服务器的最大区别就是，媒体服务器是专门为播放流式音频/视频文件而设计的，因此能够更加有效地为用户提供播放流式多媒体文件的服务，因此媒体服务器也常被称为**流式服务器(streaming server)**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200415154532077.png" alt="image-20200415154532077" style="zoom:50%;" />

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416172452788.png" alt="image-20200416172452788" style="zoom:50%;" />

+ 传送音频/视频文件可以使用TCP，也可以使用UDP。

+ UDP传送会有以下几个缺点：

  1. 发送端按正常播放的速率发送流媒体数据帧，但由于网络的情况多变，在接收端的播放器很难做到始终按规定的速率播放
  2. 很多单位的防火墙往往阻拦外部UDP分组的进入，因而使用UDP传送多媒体文件时会被拦截
  3. 使用UDP时若用户希望在客户端能够控制媒体的播放，会增加成本的复杂性

+ 现在对流式存储音频/视频的播放，都采用TCP来传送

+ <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416172904190.png" alt="image-20200416172904190" style="zoom:67%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416172930169.png" alt="image-20200416172930169" style="zoom:50%;" />

  + 只有步骤4的读出速率为原规定速率播放，前三速率任意，缓存的功能就是保证在资源足够时为用户提供原速播放的体验
  + 实践证明，只要步骤2的TCP的平均传送速率达到视频节目规定的播放速率的两倍，媒体播放器一般就能流畅地播放网上的视频节目
  + **实况直播最好使用UDP**，如果使用TCP传送，则当出现网络严重拥塞而产生播放暂停时会比丢失分组造成的卡顿更难以接受

### 8.2.3 实时流式协议RTSP

+ **实时流式协议RTSP(Real-Time Streaming Protocol)**

+ RTSP是为了给流式过程增加更多的功能而设计的协议。RTSP本身并不传送数据，而仅仅是使媒体播放器能够**控制**多媒体流的传送，因此RTSP又称为**带外协议(out-of-band protocol)**

+ RTSP协议以C/S方式工作，它是一个应用层的**多媒体播放控制协议**，用来使用户在播放从互联网下载的实时数据时能够进行控制，因此，RTSP又称为**互联网录像机遥控协议**

+ RTSP是有状态的协议，记录客户机所处于的状态

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416173832801.png" alt="image-20200416173832801" style="zoom:50%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416173844913.png" alt="image-20200416173844913" style="zoom:50%;" />

  + 音频/视频文件被下载，所用的协议是运行在UDP上的，可以是后面要介绍的RTP，也可以是其他专用的协议，可实现随时对播放文件的操作

## 8.3 交互式音频/视频

### 8.3.1 IP电话简述

1. **狭义的和广义的IP电话**

   + 狭义的IP电话是指在IP网络上打电话（IP网络就是使用IP协议的分组交换网）
   + 广义的IP电话不仅仅指电话通信，还可以是在IP网络上进行交互式多媒体实时通信，甚至还包括**即时传信IM(Instant Messaging)**
   + 分组话音通话（在计算机网络上传送电话信息）
   + 分组话音通信发展并不快，原因有：
     + 缺少软硬件支持
     + 处理速率不够
     + 没有保证实时通信**服务质量QoS(Quality of Service)**的网络协议
     + 计算机网络的规模小，而通信网只有在具有一定规模后才能产生经济效益

2. **IP电话网关**

   + 1996年3月，IP电话进入转折点：VocalTec公司成功推出**IP电话网关(IP Telephony Gateway)**，它是公用电话网与IP网络的接口设备。IP电话网关的作用就是：

     + 在电话呼叫阶段和呼叫释放阶段**进行电话信令的转换**
     + 在通话期间**进行话音编码的转换**

   + **注意电路交换部分与分组交换分别是哪部分**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416175029383.png" alt="image-20200416175029383" style="zoom:60%;" />

3. **IP电话的通话质量**

   + **两方面因素决定：**

     + **通话双方端到端的时延和时延抖动**
     + **话音分组的丢失率**

   + **还取决于当时网络上的通信量**

   + 网络上的通信量非常大以致发生了网络拥塞，那么端到端时延和时延抖动以及分组丢失率都很高，这就导致IP电话的通信质量下降

   + 一个用户使用IP电话的通话质量**取决于当时其他许多其他用户的行为**

   + 当电路交换电话网的通信量太大时，往往使我们无法拨通电话，即电话网拒绝对正在拨号的用户提供接通服务。但是只是我们拨通了电话，那么电信公司就能保证让用户满意的通话质量

   + IP电话端到端时延是由以下几个因素造成的：

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200416181009491.png" alt="image-20200416181009491" style="zoom:60%;" />

   + 目前适合IP电话使用的ITU-T标准主要有以下两种：

     + G729 话音速率为8Kbit/s的**共轭结构代数码激励线性预测CS-ACELP声码器**
     + G723.1 话音速率为5.3/6.3 kbit/s的**线性预测编码LPC声码器**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200421203504383.png" alt="image-20200421203504383" style="zoom:50%;" />

   + 对于丢失的话音分组可以使用前一个话音分组来填补丢失的话音分组的间隙，称**丢失掩蔽策略**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200421203955458.png" alt="image-20200421203955458" style="zoom:50%;" />

   + 所有各环节的时延总和约为100\~262ms（IP电话网关之间）或170\~562ms（PC之间），可见为减小时延应尽可能不要直接使用PC打IP电话

### 8.3.2 IP电话所需要的几种应用协议

+ 至少需要两种协议：

  1. **信令协议**：使我们能够在互联网上找到被叫用户。
  2. **传送协议**：使我们用来进行电话通信的话音数据能够以实验敏感属性在互联网中传送

+ 与信令有关（左），与提高服务质量相关（中），直接传送音频/视频数据（右）

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200421204939340.png" alt="image-20200421204939340" style="zoom:50%;" />

### 8.3.3 实时运输协议RTP

+ **实时运输协议RTP(Real-time Transport Protocol)**

+ **RTP为实时应用提供端对端的运输，但不提供任何服务质量的保证**

+ 需要发送的多媒体数据块（音频/视频）经过压缩编码处理后

  + 先送给RTP封装成为RTP分组
  + RTP分组装入运输层的UDP用户数据报后，再向下递交给IP层

+ RTP是一个**协议框架**，因为它只包含了实时应用的一些共同功能。

+ RTP自己并不对多媒体数据块做任何处理，而只是向应用层提供一些附加的信息，让应用层知道应当如何进行处理

+ RTP的名称又表示一个运输层协议，它封装了多媒体应用的数据块，并且由于RTP向多媒体应用程序提供了服务，因此也可以把RTP看成是在UDP之上的一个**运输层子层的协议**

+ RTP分组只包含RTP数据，而控制是由另一个配套使用的RTCP协议提供的

+ RTP在端口号1025到65535之间选择一个未使用的偶数UDP端口号，而在同一次会话中的RTCP则使用下一个奇数UDP端口号

+ RTP分组的首部中，前12字节必需，之后部分可选

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200421205806657.png" alt="image-20200421205806657" style="zoom:50%;" />

  1. **有效载荷类型(payload type)**
     + 占7位
     + 指出后面的RTP数据属于何种格式的应用
  2. **序号**
     + 占16位
     + 对每个发送出的RTP分组，序号+1
     + 一次RTP会话开始时的初始序号是随机选择的
     + 序号使接收端能够发现丢失的分组，同时也能将失序的RTP分组重新按序排列好
  3. **时间戳**
     + 占32位
     + 时间戳反映了RTP分组中数据的第一个字节的采样时刻
     + 在一次会话开始时时间戳的初始值也是随机选择的
     + 即使没有信号发送时，时间戳的数值也要随时间而不断增加
     + 接收端使用时间戳可准确知道应当在什么时间还原哪一个数据块，从而消除时延的抖动
     + 时间戳还可以用来使视频应用中声音和图像同步
  4. **同步源标识符**
     + 占32位
     + **同步源标识符SSRC(Synchronous SouRCe identifier)**是一个数，用来标志RTP流(stream)的来源
     + SSRC与IP地址无关，在新的RTP流开始时随机地产生
  5. **参与源标识符**
     + 选项，最多可有15个
     + **参与源标识符CSRC(Contributing SouRCe identifier)**也是一个32位数，用来标志来源于不同地点的RTP流
  6. **参与源数**
     + 占4位
     + 给出后面的参与源标识符的数目
  7. **版本**
     + 占2位
     + 当前使用的版本2
  8. **填充P**
     + 占1位
     + 某些特殊情况下需要对应数据块加密，往往要求每一个数据块右确定长度，如不满足则进行填充
  9. **扩展X**
     + 占1位
     + X置1表示在此RTP首部后面还有扩展首部
  10. **标记M**
      + 占1位
      + M置1表示这个RTP分组具有特殊意义

### 8.3.4 实时运输控制协议RTCP

+ **RTCP(RTP Control Protocol)**

+ 协议的主要功能是：

  + 服务质量的监视
  + 反馈、媒体间的同步（如某一个RTP发送的声音和图像的配合）
  + 多播组中成员的标志

+ RTCP的五种分组类型

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200423222355660.png" alt="image-20200423222355660" style="zoom:50%;" />


### 8.3.5 H.323

+ **H.323是一组协议**

+ H.323指明了四种构件

  + **H.323 终端**
    + 可以是PC也可以运行H.323程序的单个设备
  + **网关**
    + 网关连接到两种不同的网络
    + 仅在一个网络上通信不需网关
  + **网闸(gatekeeper)**
    + 相当于整个网络的大脑
  + **多点控制单元MCU（Multipoint Control Unit)**
    + 管理会议资源，确定使用的音频或视频编解码器

+ 网关、网闸和MCU在逻辑上是分开的构件，但可实现在一个物理设备中

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200425154501552.png" alt="image-20200425154501552" style="zoom:50%;" />

+ H.323包括以下一些组成部分：

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200425154605844.png" alt="image-20200425154605844" style="zoom:67%;" />

### 8.3.6 会话发起协议SIP

+ **会话发起协议SIP(Session Initiation Protocol)**

+ 使用了KISS原则：“保持简单、傻瓜(Keep it simple and Stupid)”

+ SIP使用文本方式的客户服务协议

+ SIP系统只有两种构建，即：

  + **用户代理(user agent)**
    + **用户代理客户UAC(User Agent Client)**
    + **用户代理服务器UAS(User Agent Server)**
  + **网络服务器(network server)**
    + **代理服务器(proxy server)**
    + **重定向服务器(redirect server)**

+ SIP的会话共有三个阶段：建立会话、通信和终止会话

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200425162335227.png" alt="image-20200425162335227" style="zoom:67%;" />

+ SIP有一种跟踪用户的机制，可以找出被叫方使用的PC的IP地址。SIP定义一些服务器作为**SIP登记器(regitster)**。每个SIP用户都有一个相关联的SIP登记器。

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200425163434665.png" alt="image-20200425163434665" style="zoom:65%;" />

+ SIP还有一个配套协议是**会话描述协议SDP(Session Description Protocol)**，在会议情况下十分重要，支持**动态地加入和退出**

## 8.4 改进”尽最大努力交付“的服务

### 8.4.1 使互联网提供服务质量

+ **服务质量QoS是服务性能的总效果，此效果决定了一个用户对服务的满意程度**

+ 基本性能指标包括：可用性、差错率、响应时间、吞吐量、分组丢失率、连接建立时间、故障检测和改正时间

+ 服务提供者可向用户保证提供某一种等级的服务质量

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427152105242.png" alt="image-20200427152105242" style="zoom:50%;" />

+ 增加一些机制可以提供更好的服务质量

### 8.4.2 调度和管制机制

1. **调度机制**

   + 调度就是指**排队的规则**

   + 路由器的队列采用的默认排队规则就是**先进先出FIFO(First In First Out)**，当队列已满时，后到达的分组就被丢弃

   + **按优先级排队**，就能使优先级高的分组优先得到服务

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427152903382.png" alt="image-20200427152903382" style="zoom:50%;" />

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427152921975.png" alt="image-20200427152921975" style="zoom:50%;" />

   + 简单地按优先级排队会带来一个缺点，**在高优先级队列中总是有分组时，低优先级队列中的分组就长期得不到服务**

   + **公平排队FQ(Fair Queuing)**对每种类别的分组流设置一个队列，然后轮流使每个队列一次只能发送一个分组。对于空的队列就跳过去

   + **加权公平排队WFQ(Weighted Fair Queuing)**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427153410402.png" alt="image-20200427153410402" style="zoom:50%;" />

2. **管制机制**

   对于数据流可以从三个方面进行管制：

   1. **平均速率**

      + 网络需要控制一个数据流的平均速率
      + **一定时间间隔内通过的分组数**

      <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427153852538.png" alt="image-20200427153852538" style="zoom:50%;" />

   2. **峰值速率**

      + 峰值速率限制了数据流在非常短的时间间隔内的流量
      + 峰值速率也同时受到链路带宽的限制

   3. **突发长度**

      + 网络也限制在非常短的时间间隔内连续注入到网络中的分组数

   + 对以上三个指标进行管制，使用非常著名的**漏筒管制器(leaky bucket policer)**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427154529442.png" alt="image-20200427154529442" style="zoom:50%;" />

     

3. **漏桶机制与加权公平排队相结合**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427161318974.png" alt="image-20200427161318974" style="zoom:50%;" />

### 8.4.3 综合服务IntServ与资源预留协议RSVP

+ IntServ可对单个的应用绘画提供服务质量的保证，其主要特点有二：

  1. **资源预留**
     + 一个路由器需要知道给不断出现的会话已经预留了多少资源

  2. **呼叫建立**

     + 一个需要服务质量保证的会话，必须首先在源点到终点路径上的**每一个路由器**预留足够的资源，以保证其端到端的服务质量要求。

     + 每一个路由器都要确定该会话所需的本地资源是否够用，同时还不要影响到已经建立的会话的服务质量

+ IntServ定义了两类服务：

  **(1) 有保证的服务（guaranteed service)**

  ​	可保证一个分组在通过路由器时的排队时延有一个严格的上限

  **(2)受控负载的服务(controlled-load service)**

   	可以使应用程序得到比通常的“尽最大努力”更加可靠的服务

+ IntServ共有以下四个组成部分：

  1. **资源预留协议RSVP**，它是InterServ的**信令协议**
  2. **接纳控制(admission control)**，用来决定是否同意对某一资源的请求
  3. **分类器(classifier)**，用来把进入路由器的分组进行分类，并根据分类的结果把不同类别的分组放入特定的队列
  4. **调度器(scheduler)**，根据服务质量要求决定分组发送的前后顺序

+ **流：一般定义为“具有同样的源IP地址、源端口号、目的IP地址、目的端口号、协议标识符及服务质量需求的一连串分组**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427191021785.png" alt="image-20200427191021785" style="zoom:50%;" />

+ IntServ/RSVP所基于的概念是端系统中与分组流有关的状态信息

+ 各路由器中的预留信息**只存储有限时间**（称为**软状态**），因而各终点对这些预留信息**必须定期进行更新**

+ RSVP协议不是运输层协议而是网络层的控制协议，RSVP不携带应用数据

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427191325488.png" alt="image-20200427191325488" style="zoom:50%;" />

+ IntServ体系结构分为前台和后台两个部分，前台部分画在下面，包括两个功能块，即**分类器与分组转发**，分组的**调度器**。每个进入路由器的分组都要通过这两个功能块。后台部分画在上面，包括四个功能块和两个数据库

+ <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427191721774.png" alt="image-20200427191721774" style="zoom:50%;" />

### 8.4.4 区分服务DiffServ

1. **区分服务的基本概念**

   + 区分服务DiffServ(Differentiated Services)，有时简写DS

   1. 区分服务DiffServ力图不改变网络的基础结构，但在路由器中**增加区分服务的功能**
      + **利用DS字段的不同数值就可提供不同等级的服务质量**
   2. **网络被划分为许多个DS域(DS Domain)**
      + **DiffServ将所有的复杂性放在DS域的边界结点(boundary node)中，而使DS域内部路由器工作得尽可能简单**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200427192247911.png" alt="image-20200427192247911" style="zoom:50%;" />

   3. 边界路由器中的功能较多，可分为**分类器(classifier)**和**通信量调节器(conditioner)**两大部分

      + 调节器又由**标记器(marker)、整形器(shaper)、测定器(meter)**三个部分组成

      + 分类器根据分组首部中的一些字段对分组进行分类，然后将分组交给标记器。标记器根据分组的类别设置DS字段的值

   4. DiffServ提供了一种**聚合(aggregation)**功能

2. **每跳行为**

   + **PHB(Per-Hop Behavior)**

   + 两种PHB：

     + **迅速转发PBH(Expedited Forwarding PHB)可记为EF PHB，或EF**

       EF PHB用来构造通过DS域的一个低丢失率、低时延、低时延抖动、确保带宽的端到端服务

     + **确保转发PHB(Assured Forwarding PHB)可记为AF PHB或AF**

       AF用DSCP的第0~2位把通信量划分为四个等级，并给每一种等级提供最低数量的带宽和缓存空间

# Chapter 9 无线网络和移动网络

+ 本章重要内容：
  + 无线局域网的组成，特别是分配系统DS(Distribution System)和接入点AP(Access Point)的作用
  + 无线局域网使用的CSMA/CA协议（与载波监听多点接入/碰撞检测CSMA/CD的区别）和无线局域网MAC帧使用的几种地址
  + 移动用户在移动时怎样保持IP地址不变
  + 蜂窝移动通信网中对移动用户的路由选择问题

## 9.1 无线局域网WLAN

+ **WLAN(Wireless Local Area Network)**
+ **便携站(portable station)**和**移动站(mobile station)**：
  + **便携站**便于移动，但便携站在工作时其位置是固定不变的
  + **移动站**不仅能够移动，还可以**在移动的过程中进行通信**

### 9.1.1 无线局域网的组成

+ 分为两大类：
  + **有固定基础设施的**
  + **无固定基础设施的**

1. IEEE 802.11

   + 802.11就是无线以太网标准，使用星形拓扑，其中心叫做**接入点AP(Access Point)**，在MAC层使用CSMA/CD协议

   + 802.11标准规定无线局域网的最小构件是**基本服务集BSS(Basic Service Set)**

   + 一个服务集BSS包括一个基站和若干个移动站，一个站无论要和本BSS的站进行通信，还是要和其他BSS的站进行通信，都必须通过本BSS的基站

   + 接入点AP就是基本服务集内的**基站(base station)**

   + 当网络管理员安装AP时，必须为该AP分配一个不超过32字节的**服务集标识符SSID(Service Set IDentifier)**和一个通信信道，SSID其实是指使用该AP的无线局域网的名字

   + 一个基本服务集BSS所覆盖的地理范围叫做一个**基本服务区BSA(Basic Service Area)**

   + 无线局域网的基本服务区BSA的范围直径一般不超过100米

   + 一个基本服务集可以是孤立的，也可通过接入点AP连接到一个**分配系统DS(Distribution System)**，然后再连接到另一个基本服务集，这样就构成了一个**扩展的服务集ESS(Extended Service Set)**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428174456877.png" alt="image-20200428174456877" style="zoom:60%;" />

   + 一个移动站若要加入到一个基本服务集BSS，就必须先选择一个接入点AP，并与此接入点建立关联(association)

   + 关联阶段后，移动站点要通过关联的AP向该子网发送DHCP发现报文以获取IP地址

   + 若移动站使用**重建关联(reassociation)**服务，就可把这种关联转移到另一个接入点。当使用**分离(dissociation)**服务时，就可终止这种关联

   + 移动站与接入点AP建立关联的方法有两种：

     + **被动扫描**

       移动站等待接收接入点AP周期性发出的**信标帧(beacon frame)**，信标帧中包含有若干系统参数（如服务集标识符SSID以及支持的速率等）

     + **主动扫描**

       移动站主动发出**探测请求帧(probe request frame)**，然后等待从接入点发回的**探测响应帧(probe response frame)**

   + 由许多热点和接入点AP连接起来的区域叫做**热区(hot zone)**，热点也就是公众无限入网点

   + **无线互联网服务提供者WISP(Wireless Internet Service Provider)**使得用户可通过无线信道接入到WISP，然后再经过无线信道接入到互联网

   + WPA(WiFi Protected Access，意思是“无线局域网受保护的接入”）

2. **移动自组网络**

   + 另一类无线局域网是无固定基础设施的无线局域网，它又叫做**自组网络(ad hoc network)**

   + 由于自组网络没有预先建好的网络固定基础设施（基站），因此自组网络的服务范围通常是受限的，而且自组网络一般也不和外界的其他网络相连接。移动自组网络也就是**移动分组无线网络**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428180734566.png" alt="image-20200428180734566" style="zoom:50%;" />

   + **无线传感器网络WSN(Wireless Sensor Network)**是由大量传感器结点通过无线通信技术构成的自组网络

   + 无线传感器网络中的结点基本上是固定不变的，无线传感器网络主要的应用领域就是组成各种**物联网IoT(Internet of Things)**

   + **移动自组网络和移动IP并不相同**，移动IP技术使漫游的主机可以用多种方式连接到互联网

   + <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428181126180.png" alt="image-20200428181126180" style="zoom:50%;" />

### 9.1.2 802.11局域网的物理层

### 9.1.3 802.11局域网的MAC层协议

1. **CSMA/CA协议**

   + 碰撞检测在无线环境下不能使用：

     + 碰撞检测要求一个站点在发送本站数据的同时，还必须不间断地检测信道

       若要在无线局域网的适配器上实现碰撞检测，在硬件上的花费就会过大

     + 即使能够在硬件上实现无线局域网的碰撞功能，也仍然无法避免碰撞的发生，表明无线局域网不需要进行碰撞检测

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428182547267.png" alt="image-20200428182547267" style="zoom:35%;" /> <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428182624918.png" alt="image-20200428182624918" style="zoom:35%;" />

   + 未能检测出信道上其他站点信号的问题叫做**隐蔽站问题(hidden station problem)**

   + 三角形位置时若A与C间有一座山，彼此听不见，而同时向B发送数据就会产生碰撞，使B无法正常接收

   + 右图为暴露站问题(exposed station problem)

   + 无线局域网中，在不发生干扰的情况下，可允许同时有多个移动站进行通信。这点与有线局域网有很大的差别

   + 无线局域网可能出现检测错误的情况：检测到信道空闲，其实信道并不空闲；有时检测到信道忙，其实信道并不忙

   + CSMA/CD有两个要点：

     + 发送前先检测信道，信道空闲就立即发送，信道忙就随机推迟发送
     + 边发送边检测信道，一发现碰撞就立即停止发送

   + 802.11局域网使用CSMA/CA协议，CA表示Collision Avoidance，是**碰撞避免**，**协议的设计是要尽量减少碰撞发生的概率**

   + 802.11局域网在使用CSMA/CA的同时，还使用停止等待协议，因此无线站点每通过无线局域网发送完一帧后，要等到收到对方的确认帧后才能继续发送下一帧，这是**链路层确认**

   + 802.11标准设计了独特的MAC层，通过**协调功能(Coordination Function)**来确定在基本服务集BSS中的移动站，在什么时间能发送数据或接收数据。802.11的MAC层在物理层的上面，它包括两个子层

     + **分布协调功能DCF(Distributed Coordination Function)**

       DCF不采用任何中心控制，而是在每一个结点使用CSMA机制的分布式接入算法，让各个站通过争用信道来获取发送权

       规定所有的实现都**必须有DCF功能**

     + **点协调功能PCF(Point Coordination Function)**

       PCF是**选项**，使用接入点AP集中控制整个BSS内的活动，因此自组网络就没有PCF子层

       PCF使用集中控制的接入算法，用类似探询的方法把发送数据权轮流交给各个站，从而避免了碰撞的产生

       <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428185339993.png" alt="image-20200428185339993" style="zoom:50%;" />

     + 为了尽量避免碰撞，802.11规定，所有的站在完成发送后，必须等待一段很短的时间（继续监听）才能发送下一帧。这段时间通称为**帧间间隔IFS(InterFrame Space)**

     + 帧间间隔的长短取决于该站要发送的帧的类型

     + 高优先级需要等待的时间较短，因此可优先获得发送权，但低优先级帧就必须等待较长时间

       <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428185718474.png" alt="image-20200428185718474" style="zoom:60%;" />

       1. **SIFS，即短(Short)帧间间隔**

          长度为28μs，SIFS是最短的帧间间隔，用来分隔开属于一次对话的各帧

       2. **DISF，即分布协调功能帧间间隔**

          它比SIFS的帧间间隔要长很多，长度为128μs，在DCF方式中，DIFS用来发送数据帧和管理帧

   + 802.11标准还采用了一种叫**虚拟载波监听(Virtual Carrier Sense)**的机制，这就是让源站把它要占用信道的时间（包括目的站发回确认帧所需的时间）及时通知给所有其他站，以便使其他所有站在这一段时间都停止发送数据，这样就大大减少了碰撞的机会，这种效果**好像**是其他站并没有监听信道

   + 当一个站检测到正在信道中传送的MAC帧首部的“持续时间”字段时，就调整自己的**网络分配向量NAV(Network Allocation Vector)**。NAV指出了必须经过多少时间才能完成数据帧的这次传输，才能使信道转入到空闲状态。某个站认为信道处于忙态就有两种可能，一种可能是由于其物理层的载波监听检测到信道忙，另一种可能是由于MAC层的虚拟载波监听机制指出了信道忙

   + 信道从忙态变为空闲时，任何一个站要发送数据帧时，只要不是要发送的第一个帧，不仅都必须等待一个DIFS的间隔，而且还要进入**争用窗口**，并计算随机退避时间，以便再次重新试图接入到信道

   + **在信道从忙态转为空闲时，为了避免几个站同时发送数据（一旦发送就要把一帧发送完，不能中途停止），所有想发送数据的站就要执行退避算法**

   + 802.11标准也是使用二进制指数退避算法，但具体做法稍有不同。这就是：第i次退避就在2^2+i^个时隙中随机地选择一个

   + 当**退避计时器(backoff timer)**的时间还未减小到零时而信道又转变为忙态，这时就冻结退避计时器的数值，重新等待信道变为空闲，再经过时间DIFS后，继续启动退避计时器（从剩下的时间开始）

   + 这里决定退避时间的变量i称为**退避变量**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200428193615597.png" alt="image-20200428193615597" style="zoom:60%;" />

   + 站点每经历一个时隙的时间就检测一次信道，这可能发生两种情况：若检测到信道空闲，退避计时器就继续倒计时；若检测到信道忙，就**冻结退避计时器的剩余时间**，重新等待信道变为空闲并再经过时间DIFS后，从剩余时间开始继续倒计时。如果退避计时器的时间减小到0时，就开始发送整个数据帧

   + 冻结退避计时器剩余时间的的做法是为了使协议对所有站点更加公平

   + **CSMA/CA算法归纳如下：**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502170339419.png" alt="image-20200502170339419" style="zoom:55%;" />

   + 当一个站要发送数据帧，仅在**检测到信道是空闲的，并且这个数据帧是它想发送的第一个数据帧**的情况下才**不使用**退避算法

2. **对信道进行预约**

   + 为了更好地解决隐蔽站带来的碰撞问题，802.11允许要发送数据的站对信道进行**预约**

   + 具体做法如图：

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502171632692.png" alt="image-20200502171632692" style="zoom:67%;" />

     + A在向B发送数据帧之前，先发送一个短的控制帧，叫做**请求发送RTS(Request To Send)**，它包括源地址、目的地址和这次通信（包括相应的确认帧）所需的持续时间。A在发送RTS帧之前，必须先监听信道。若信道空闲，则等待一段时间DIFS后，才能发送RTS帧。若B正确收到A发来的RTS帧，且媒体空闲，则等待一段时间SIFS后，就向A发送一个叫做**允许发送CTS(Clear To Send)**的控制帧，它也包括这次通信所需的持续时间。A收到CTS帧后，再等待一段时间SIFS后，就可发送数据帧。若B正确收到了A发来的数据帧，在等待时间SIFS后，就向A发送确认帧ACK
     + 虽然两种帧会使网络通信效率有所下降，但协议还是设有三种情况供用户选择：
       1. 使用RTS帧和CTS帧
       2. 只有当数据帧的长度超过某一数值时才使用RTS帧和CTS帧
       3. 不使用RTS帧和CTS帧

   + **CSMA/CA协议的基本流程图**
   
     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502173804059.png" alt="image-20200502173804059" style="zoom:60%;" />

### 9.1.4 802.11局域网的MAC帧

+ 802.11帧共有三种类型，即**控制帧、数据帧、管理帧**

+ 802.11数据帧由以下三大部分组成：

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502174332703.png" alt="image-20200502174332703" style="zoom:60%;" />



​						<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502174610092.png" alt="image-20200502174610092" style="zoom:60%;" />

 	1. **MAC首部**
          
     + 共30字节
     + 帧的复杂性都在帧的首部
     
	2. **帧主体**
        
    + 帧的数据部分，不超过2312字节
	+ 此数值比以太网的最大长度长很多。不过802.11帧的长度通常都小于1500字节
    3. **帧检验序列FCS**
+ MAC尾部，共4字节
  
3. **帧检验序列FCS**

   + MAC尾部，共4字节

1. **关于802.11数据帧的地址**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502180454081.png" alt="image-20200502180454081" style="zoom:50%;" />

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502180608440.png" alt="image-20200502180608440" style="zoom:67%;" />

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502180859578.png" alt="image-20200502180859578" style="zoom:60%;" />

2. **序号控制字段、持续期字段和帧控制字段**

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502181555090.png" alt="image-20200502181555090" style="zoom:50%;" />

   <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502181850160.png" alt="image-20200502181850160" style="zoom:55%;" />

## 9.2 无线个人区域网WPAN

+ **无线个人区域网WPAN(Wireless Personal Area Network)**就是在个人工作地方把属于个人使用的电子设备（如便携式电脑、平板电脑、便携式打印机以及蜂窝电话等）用无线技术连接起来自组网络，不需要使用接入点AP，整个网络的范围约为10m
+ 无限个人区域网WPAN和个人区域网PAN(Personal Area Network)并不完全等同，因为PAN不一定都是使用无线连接的
+ WPAN和无线局域网WLAN并不一样
  + WPAN是以个人为中心来使用的无线个人区域网，它实际上就是一个低功率、小范围、低速率和低价格的电缆替代技术
  + WLAN是同时为许多用户服务的无线局域网，它是一个大功率、中等范围、高速率的局域网

1. **蓝牙系统**

   + 最早的WPAN是1994年爱立信公司推出的**蓝牙(Bluetooth)**系统，标准为IEEE802.15.1

   + 蓝牙使用TDM方式和调频扩频FHSS技术组成不用基站的**皮可网(piconet)**

   + 每个皮可网有一个**主设备(Master)**和最多7个工作的**从设备(Slave)**

   + 通过共享主设备或从设备，可以把多个皮可网链接起来，形成一个范围更大的**扩散网(scatternet)**

   + M和S的小圆圈分别表示主设备和从设备，而标有P的小圆圈表示不工作的**搁置的(Parked)**设备

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502185755129.png" alt="image-20200502185755129" style="zoom:50%;" />

   + 为适应不同用户的需求，WPAN还定义了另外两种低速WPAN和高速WPAN

2. **低速WPAN**

   + 低速WPAN主要用于工业监控组网、办公自动化与控制等领域

   + 低速WPAN中最重要的就是ZigBee
   
   + ZigBee技术主要用于各种电子设备之间的无线通信，主要特点是通信距离短（10m~80m），传输数据速率低，并且成本低廉，功耗非常低，网络容量大（一个ZigBee网络最多包括255个结点，其中一个是主设备(Master)，其余为从设备(Slave)，若通过网络协调器(Network Coordinator)，整个网络最多可支持超过64000个结点）
   
   + 虽然人们常常把ZigBee和802.15.4作为同义词，但仍有区别
   
     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502205133524.png" alt="image-20200502205133524" style="zoom:50%;" />
   
     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502205159324.png" alt="image-20200502205159324" style="zoom:50%;" />
   
   + ZigBee的结点按功能的强弱可划分为两大类：
   
     + **全功能设备FFD(Full-Function Device)**
   
       FFD结点具备控制器(Controller)的功能
   
       在一个ZigBee网络中有一个FFD充当该网络的**协调器(coordinator)**
   
     + **精简功能设备RFD(Reduced-Function Device)**
   
       RFD结点是ZigBee网络中数量最多的**端设备**，电路简单，存储容量较小，因而成本较低
   
       RFD结点只能与处在该星形网中心的FFD结点交换数据
   
     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502210120535.png" alt="image-20200502210120535" style="zoom:50%;" />
   
3. **高速WPAN**

   + 高速WPAN的标准是IEEE 802.15.3，是专为在便携式多媒体装置之间传送数据而制定的
   + 在个人使用的数码设备日益增多的情况下特别方便
   + IEEE 802.15.3a工作组还提出了更高数据率的物理层标准的**超高速WPAN**，这种网络使用**超宽带UWB(Ultra-Wide Band)技术**

## 9.3 无线城域网 WMAN

+ WMAN(Wireless Metropolitan Area Network)
+ 早期出现的**本地多点分配系统LMDS(Local Multipoint Distribution System)**就是一种宽带无线城域网接入技术
+ WMAN可提供“最后一英里”的宽带无线接入（固定的、移动的和便携式的）
+ 在许多情况下，无线城域网可用来代替现有的有线宽带接入，因此它有时又称为**无线本地环路(wireless local loop)**
+ **WiMAX是Worldwide Interoperability for Microwave Acess**
+ 在许多文献中，我们可以见到WiMAX常用来表示无线城域网WMAN，这与Wi-Fi常用来表示无线局域网WLAN相似
+ <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502212059472.png" alt="image-20200502212059472" style="zoom:60%;" />
+ IEEE 802.16工作组是无线城域网标准的制定者，而WiMAX论坛是802.16技术的推动者
+ 接收到的信号功率和信噪比等也会有很大的差别
+ 工作在毫米波段的802.16必须有不同的物理层，由于天气条件对毫米波传输的影响较大，与室内工作的无线局域网相比，802.16对差错的处理也更为重要

## 9.4 蜂窝移动通信网

### 9.4.1 蜂窝无线通信技术简介

+ 移动通信的种类很多，如蜂窝移动通信、卫星移动通信、集群移动通信、无绳电话通信等，但目前使用最多的是蜂窝移动通信，它又称为小区制移动通信。

+ 这种通信的特点是把整个的网络服务区划分成许多小区(cell)，每个小区设置一个基站，负责本小区各个移动站的联络与控制。移动站的发送或接收都必须经过基站完成

+ **第一代蜂窝移动通信 1G**

  + 为话音通信设计的模拟FDM系统，1G的蜂窝无线网络早已淘汰了

+ **第二代蜂窝移动通信 2G**

  + 代表性体制就是最流行的GSM系统
  + 除了基本的话音通信，它只能提供低俗数字通信（短信服务）
  + 2G蜂窝移动通信系统增加了如GPRS(2.5G)和EDGE(2.75G)等技术

+ **第三代蜂窝移动通信 3G**

  + 使用IP体系结构和混合的交换机制（电路交换和分组交换）
  + 能够提供移动宽带多媒体业务
  + 3G开始以后的各代蜂窝移动通信都是**以传输数据业务为主的通信系统**，而且必须兼容2G功能，即所谓的向后兼容

+ **高级国际移动通信 4G**

  + 正式名称是**IMT-Advanced(International Mobile Telecommunications-Advanced)**
  + 4G目标峰值数据率是：
    + 固定的和低速移动通信时应达到1Gbit/s
    + 高速移动通信时应达到100Mbit/s

+ **5G已投入使用**

+ 每个基站的发射功率既要能够覆盖本小区，也不能太大以致干扰了临近小区的通信

+ 小区的大小视该小区内的移动用户数而定，从半径20m（移动用户很密集的地方）到1~25km不等

+ 采用蜂窝形状结构的小区的好处是可以最大限度地进行频率复用

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502214447658.png" alt="image-20200502214447658" style="zoom:60%;" />

+ 每一个基站都有一个基站收发信机，其作用就是在移动站和**无线网络控制器RNC(Radio Network Controller)**进行通信时，起到转接作用。无线网络控制器RNC控制一组基站（例如控制几十个基站），负责管理无线小区及其无线信道。
+ 如果移动站要进行电话通信，就必须和小区中的基站相关联，和基站建立起双向的无线通信信道。
+ 基站通过RNC连接到**移动交换中心MSC(Mobile Switching Center)**
+ MSC控制所有RNC的话音业务，提供电路交换功能，处理所控制区域内移动站的信令，以及移动站的位置更新
+ 移动通信运营商可以建立很多的MSC，然后通过网关移动交换中心连接到公用电话网或其他移动通信网络
+ GPRS核心网络包括两部分，即SGSN(Serving GPRS Support Node)，即GPRS服务支持结点，和GGSN(Gateway GPRS Support Node)，即网关GPRS支持结点
+ SGSN主要完成IP数据报的转发、移动性管理、会话管理、逻辑链路管理、鉴别和加密、话单产生和输出等功能。SGSN还要和移动交换中心MSC进行通信，以便完成用户的鉴别、通信的切换等功能。GGSN具有网络接入控制功能，因此又称为GPRS路由器，它选择那些分组可以进入GPRS网络，以保证GPRS网络的安全
+ 无线网络控制器RNC所起的关键作用。RNC处在无线接入网的边缘，它进行无线通信和有限通信的转换。在有限通信这边，RNC把电路交换的话音通信传送到MSC，而把分组交换的数据传送到SGSN

### 9.4.2 移动IP

+ **移动IP(Mobile IP)又称为移动IP协议**，允许计算机移动到外地时，仍然保留其原来的IP地址

+ 希望移动站所建立的TCP连接在移动站漫游时一直保持连接，否则我们的上网就会变为断断续续的

+ 移动IP所要解决的问题，就是要使用户的移动性对上层的网络应用是透明的，即想办法使已建立的TCP连接与移动用户的漫游无关

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502220848168.png" alt="image-20200502220848168" style="zoom:50%;" />

+ 首先，一个移动站A必须有一个原始地址（相当于上面提到的家庭地址），即**永久地址**，或**归属地址(home address)**，移动站原始连接到的网络叫做**归属网络(home network)**。永久地址和归属网络的关联是不会改变的

+ 为了让地址的改变对互联网的其余部分是透明的，移动IP使用了代理。**归属代理(home agent)**通常就是连接在归属网络上的路由器

+ **当移动站A移动到另一个地点**

  + 他所接入的网络称为**被访网络(visited network)**或**外地网络(foreign network)**。
  + 被访网络中使用的代理叫做**外地代理(foreign agent)**，它通常就是连接在被访网络上的路由器（当然也充当主机）
  + 外地代理的一个任务就是要为移动站A创建一个临时地址，叫做**转交地址(care-of address)**

+ **注意两点:**

  + 转交地址是供移动站、归属代理以及外地代理使用的，各种应用程序都不适用这种转交地址；
  + 转交地址在互联网中并不具有唯一性

+ 有时，移动站本身也可以充当外地代理，即移动站和外地代理是同一个设备。这时的转交地址叫做**同址转交地址(co-located care-of address)**，移动站必须能够接收发送到转交地址的数据报。

+ **使用同址转交地址**

  + 好处是移动站可以移动到任何网络，而不必担心外地代理的可用性
  + 缺点是移动站需要有额外的软件，是指能够充当自己的外地代理。

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502222012924.png" alt="image-20200502222012924" style="zoom:60%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502222045862.png" alt="image-20200502222045862" style="zoom:50%;" />

+ 间接路由选择可能会引起数据报转发的低效，文献中称之为**三角形路由选择问题(triangle routing problem)**

+ 解决这个问题的一种方法是使用**直接路由选择**，但这是以增加复杂性为代价的：

  + 让通信者B创建一个**通信这代理(correspondent agent)**，让这个通信者代理向归属代理询问到移动站在被访网络的转交地址，然后由通信者代理（而不是由归属代理）把数据报用隧道技术发送到被访网络的外地代理，最后再由这个外地代理拆封，把数据报转发给移动站

+ 使用这种方法时必须解决以下两个问题：

  1. 增加一个协议，即**移动用户定位协议(mobile-user location protocol)**，用来使通信者代理向移动站的归属代理查询移动站的转交地址

  2. **当移动站再移动到其他网络时，怎样得到移动站的位置信息：**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502222909180.png" alt="image-20200502222909180" style="zoom:60%;" />

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502223009015.png" alt="image-20200502223009015" style="zoom:60%;" />

     + 绝对不能容许不法分子把别人发送给A的数据报，转发到被暗中设定的某个伪造的外地代理

### 9.4.3 蜂窝移动通信网中对移动用户的路由选择

+ MSC是蜂窝移动通信网中的核心构件

+ MSC还要维护两个非常重要的数据库，即**归属位置寄存器HLR(Home Location Register)**和**来访用户位置寄存器VLR(Visitor Location Register)

+ HLR存放签约用户的所有数据信息，VLR则临时存放着当前漫游到这个MSC控制区的用户位置信息

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502223525013.png" alt="image-20200502223525013" style="zoom:60%;" />

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502223612123.png" alt="image-20200502223612123" style="zoom:50%;" />

+ 不管被叫移动用户的位置如何，呼叫的第一步总是先找到被叫移动用户的归属MSC，呼叫的第二步再从归属MSC找到被访网络的MSC和与该MSC相关联的被叫
+ **数据库HLR和VLR都必须具有很高的可靠性与可用性，并且查询响应时间必须非常短，否则就不能使电话的接通时间让用户满意**

### 9.4.4 GSM中的切换

+ 移动用户在进行通信时总是处在某一个基站的服务小区内。

+ 当移动用户进入到地理上相邻的另一个小区时，他就与该小区的基站相关联。所谓**切换(handover)**就是移动用户与相关联的基站发生了改变

+ 小区的大小和形状取决于该地区的地形、基站的分布以及基站收发信机的功率。

+ 设计良好的蜂窝通信网络应当使移动用户在大多数情况下都能够处在超过一个基站的服务区内

+ 网络会决定在什么时候由哪一个基站来为该移动用户服务

+ 切换基站的原因是：

  + 当前基站和移动用户之间的信号减弱，有使呼叫中断的可能
  + 一个蜂窝小区内的呼叫太多，基站不堪重负。这时可以把移动用户切换到与相邻的不太拥塞的蜂窝小区的基站相关联以减轻原来基站的负荷

+ 移动站的切换可能仍处在同一个MSC的控制下，只是相关联的基站发生了变化。但在许多情况下，移动站的切换是相关联的MSC都改变了

+ 移动用户在不同的小区之间漫游时，呼叫路由只在从锚MSC到被访网络的MSC这一段发生变化

+ 在通信者和被叫移动用户之间，最多出现三个MSC，即归属MSC、锚MSC和被访网络的MSC

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502230514036.png" alt="image-20200502230514036" style="zoom:60%;" />

### 9.4.5 无线网络对高层协议的影响

+ 当无线信道出现严重的比特差错，或由于切换产生报文段丢失，减小TCP发送方的拥塞窗口对改善网络性能并不会有任何好处

+ 可以使用三种方法来处理这个问题：

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502231042316.png" alt="image-20200502231042316" style="zoom:50%;" />

+ 在蜂窝无线通信网中实验的结果表明，采用拆分TCP连接的方法可以使整个性能得到明显的改进

## 9.5 两种不同的无线上网

+ 上网所需的费用是很不一样的
+ Wi-Fi 上网的最大问题就是每个热点覆盖面积很小，在许多需要上网的地方很可能没有Wi-Fi信号。在这种情况下，无线上网只能依靠比较昂贵的蜂窝移动无线网络了

<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200502231612673.png" alt="image-20200502231612673" style="zoom:67%;" />