---
typora-copy-images-to: PhotosInMd
---

# Chapter 1 概述

## 1.1 计算机网络在信息时代中的作用

+ 三大类网络
  + 电信网络
  + 有线电视网络
  + 计算机网络

## 1.2 互联网概述

### 1.2.1 网络的网络

+ 网络把许多计算机连接在一起，而互联网吧许多网络通过路由器连接在一起。与网络相连的常称为主机。
+ 简单的物理连接不是网络，配合与协议等才是完整的

### 1.2.2 互联网基础结构发展的三个阶段

1. 单个网络ARPANET向互连网发展的过程
2. 建成了三级结构的互连网（主干网、地区网、校园网）
3. 逐渐形成多层次[ISP](https://baike.baidu.com/item/%E4%BA%92%E8%81%94%E7%BD%91%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E5%95%86/12508386?fromtitle=ISP&fromid=10152)结构的互连

+ 根据提供服务的覆盖面积大小以及所拥有的IP地址数目不同，ISP分为不同层次：
  + 主干ISP
  + 地区ISP
  + 本地ISP
+ IXP(Internet eXchange Point)互连网交换点用于优化速度，高效利用网络资源，主要作用是允许两个网络直接相连并交换分组，不需要再通过第三个网络来转发分组

### 1.2.3 互联网的标准化工作

+ 标准制定的时机不宜过早过晚，过早技术未发展至成熟水平，旧技术限制新技术，过晚使技术发展无章可循产品相互不兼容。
+ ISOC(Internet Society) 互联网协会
  + IAB(Internet Architecture Board) 互联网体系结构委员会
    + 互联网工程部 IETF
    + 互联网研究部 IRTF
  + RFC(Request of Comments) 文档
+ 制定互联网的正式标准要经过以下三个阶段
  1. 互联网草案
  2. 建议标准（成为RFC文档）
  3. 互联网标准

## 1.3 互联网的组成

+ 互联网从工作方式上看分为两大块
  + 边缘部分：由所有连接在互联网上的主机组成。这部分由用户直接使用，用来进行通信和资源共享
  + 核心部分：由大量网络和连接这些网络的路由器组成。这部分使为边缘部分提供服务的。

### 1.3.1 互联网的边缘部分

+ **主机A的某个进程和主机B的另一个进程通信**

+ 边缘部分利用核心部分所提供的服务使众多的主机之间能够互相通信并交换或共享信息

+ 网络边缘的端系统之间的通信方式通常可划分为两大类：

  + **客户-服务器方式（C/S方式）**
    客户是服务请求方，服务器是服务提供方。
    **客户程序特点：**

    1. 被用户调用后运行，在通信时主动向远地服务器发起通信请求服务。
    2. 不需要特殊的硬件和很复杂的操作系统。

    **服务器程序特点：**

    1. 是一种专门用来提供某种服务的程序，可同时处理多个远地或本地客户的请求
    2. 系统启动后即调用并一直不断地运行着，被动地等待并接受来自各地的客户的通信请求。服务器程序不需要知道客户程序地址。
    3. 客户与服务器的通信关系建立后，通信可以是双向的，客户与服务器都可发送和接收数据。

  + **对等方式（P2P方式）**
    Peer-to-peer
    既是C又是S

### 1.3.2 互联网的核心部分

1. **电路交换主要特点**
   + 电话机数量大时电线**数量太大**
   + **步骤**：建立连接-通话（持续占用）-释放连接
   + 通话的全部时间内，通话的两个用户始终占用端到端的通信资源，资源利用率太低
2. **分组交换的主要特点**

   + 采用**存储转发技术**
   + 发送的整块数据称为一个**报文(message)**，添加**首部**之后可构成分组，又称**包**，首部可称**包头**
   + 《**主机**是为用户进行信息处理的，**路由器**是用来转发分组的，即进行分组交换

   + **路由器的短分组暂存在内存中而非磁盘中**以保证较高的交换速率
   + 路由器步骤：暂存-查表-发出
   + **分组交换优点**：*高效、灵活、迅速、可靠* 
3. **报文交换**是将整个报文以路由转发传送至目的地

## 1.4 计算机网络在我国的发展

## 1.5 计算机网络的定义

### 1.5.1 计算机网络的定义

1. 计算机网络所连接的硬件并不仅限于一般的计算机，还包括智能手机等。
2. 计算机网络并非专门用于传输数据，而能支持多种应用。

### 1.5.2 几种不同类别的计算机网络

1. 按照**网络作用范围**分类

   + **WAN** (Wide Area Network)  广域网：几十到几千公里

   + **MAN** (Metropolitan Area Network)  城域网：5~50公里

   + **LAN** (Local Area Network)  局域网：较小范围如1公里内

   + **PAN** (Private Area Network)  个人区域网：范围很小如10米

     <!-- 太近的中央处理机当作多处理机系统而非计算机网络 -->

2. 按照**网络的使用者**分类

   + **公用网** (Public Network)
   + **专用网** (Private Network)

3. 用来把用户接入到互联网的网络

   + **AN** (Access Network) **接入网**或称本地接入网或居民接入网

     **接入网本身不属于互联网的核心部分，也不属于边缘部分**

   + 从覆盖的范围看，很多接入网还是属于局域网

   + 作用上看，接入网只是起到让用户能够与互联网连接的“桥梁”作用

## 1.6 计算机网络的性能

### 1.6.1 计算机网络的性能指标

1. **速率**

   + **数据的传输速率**
   + **数据率**或**比特率**

   + 网络速率往往指的是 **额定速率** 或 **标称速率**

2. **带宽**

   1. **某个信号具有的频带宽度**
      + 某信道允许通过的信号频带范围就称为该信道的带宽
      + 单位：**赫兹**
   2. 网络中某**通道**传送数据的能力
      + 在单位时间内网络中的某信道所能通过的”最高数据率”
      + 单位：bit/s

3. **吞吐量**

   + 在单位时间内通过某个网络（或信道、接口）的实际的数据量
   + 多用于网络测量

4. **时延**

   + **发送时延**

     主机或路由器发送数据帧所需要的时间，即发送第一比特算起到发送完最后一个比特为止。

     ![image-20200208114640331](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208114640331.png)

   + **传播时延**

     电磁波在信道中传播一定距离需要花费的时间。

     ![image-20200208114911047](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208114911047.png)

   + 处理时延

     主机或路由器在收到分组时嗷花费一定的时间进行处理，例如分析分组的首部、从分组中提取数据部分、进行差错检验或查找适当的路由等，这就产生了处理时延。

   + 排队时延

     路由器转发过程中排队消耗的时间。

     ![image-20200208185700043](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208185700043.png)

![image-20200208185854770](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208185854770.png)

**对于高速网络链路，我们提高的仅仅是数据的发送速率而不是比特在链路上的传播速率。传播速率相对恒定，参考光速。**

5. **时延带宽积**

   ![image-20200208190609260](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208190609260.png)

   + 以比特为单位的链路长度

     ![image-20200208190931697](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208190931697.png)

6. **往返时间RTT**

   + 用于判定双方交互一次的时间。

   + 在互联网中，往返时间还包括各中间节点的处理时延、排队时延以及转发数据时的发送时延。卫星通信时RTT相对较长，是很重要的一个性能指标。

   + 

7. **利用率**

   + 信道利用率

     令D0 表示网络空闲时的时延，D表示网络当前的时延，则在适当的假定条件下，可以用下面的简单公式表示D和D0之间的关系：![image-20200208192021821](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208192021821.png)

   + 网络利用率

     + 当网络利用率达到容量的1/2时就要加倍。

     + 信道或网络的利用率过高会产生非常大的时延。

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208192212142.png" alt="image-20200208192212142" style="zoom:60%;" />

### 1.6.2 计算机网络的非功能特征

1. 费用
2. 质量
   3. 标准化
   4. 可靠性
   5. 可扩展性和可升级性
   6. 易于管理和维护

## 1.7 计算机网络体系结构

### 	1.7.1 计算机网络体系结构的形成

​		**开放系统互连基本参考模型OSI/RM ( Open System Interconnection Reference Model)**

​		但是OSI太晚进入市场，TCP/IP占有太多份额，因此TCP/IP占到先机

OSI缺点 

1. 缺乏经验，缺乏商业驱动力

2. 实现复杂，运行效率低
3. 指定周期太长，无法及时进入市场
4. 层次划分不合理，有些功能在多个层次中重复出现

### 	1.7.2 协议与层次划分

+ 规则明确规定了所交换数据的格式以及有关的同步问题
+ 分层的好处
  + 各层之间独立，层次间不需知道对方如何实现
  + 灵活性好
  + 结构上可分割开
  + 易于实现与维护
  + 能促进标准化工作
+ 各层所要完成的功能
  + 差错控制
  + 流量控制
  + 分段与重装
  + 复用和分用
  + 连接建立和释放
+ **计算机网络的各层及其协议的集合**就是网络的体系结构
+ 计算机网络的体系结构就是这个计算机网络及其构件所应完成的功能的精确定义
+ 体系结构是抽象的，而实现则是具体的，是真正在运行的计算机硬件和软件

### 1.7.3 具有五层协议的体系结构

1. **应用层（application layer）**
   + 通过应用进程间的交互来完成特定网络应用
   + 应用层协议定义的是应用进程间通信和交互的规则
   + 应用层交互的数据单元称为**报文**

2. **运输层（transport layer）**
   + 两台主机中进程间通信提供通用数据传输业务
     + TCP (Transmission Control Protocol) 传输控制协议
       + **面向连接**、**可靠**数据传输、传输单位 **报文段**
     + UDP(User Datagram Protocol) 用户数据报协议
       + **无连接**、尽最大努力（best-effort）、不保证可靠、传输单位 **用户数据报**
3. **网络层（network layer）**
   + 负责为分组交换网上的不同主机提供通信服务
   + 发送数据时，网络层把运输层产生的报文段或用户数据报封装成分组或包进行传送
   + 使用IP协议，分组也叫做IP数据报，或简称为数据报
   + 也称网际层，IP层

4. **数据链路层（data link layer）**
   + 简称链路层
   + 将网络层浇下来的IP数据报组装成帧，在相邻节点间的链路上传送帧
   + 每一帧包括数据和必要的控制信息
   + 帧有差错则**丢弃**该帧
5. **物理层（physical layer）**
   + 传输数据单位是比特
   + 有人将物理层下面的物理媒体当作第0层

+ **经常提到的TCP/IP协议并不一定单指具体的这两个协议，往往表示互联网所使用的整个TCP/IP协议族（protocol suite）**
+ **对等层**（peer layers）相同层次 相同协议
+ **协议栈**（protocol stack）类似栈的结构

### 1.7.4 实体、协议、服务和服务访问点

+ **实体（entity）**

  + 任何可发送或接收信息的硬件或软件进程

+ **协议（protocol)**

  + 控制两个对等实体进行通信的规则集合
  + 在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务，要实现本层协议，还需要使用下面一层所提供的服务
  + 协议是水平的

+ **服务访问点SAP（Service Access Point）**

  + 同一系统相邻两层的实体进行交互的地方。

+ **服务（service）**

  + 下层为上层提供服务

    ![image-20200208225705464](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208225705464.png)

### 1.7.5 TCP/IP 的体系结构

+ TCP/IP协议可为各式各样的应用提供服务（everything over IP）

+ 允许IP协议在各式各样的网络构成的互联网上运行

+ 沙漏计时器TCP/IP协议族

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200208230154611.png" alt="image-20200208230154611" style="zoom:60%;" />

# Chapter 2 物理层

## 2.1 物理层的基本概念

+ 物理层协议也称为物理层规程
+ 物理层的主要任务描述为确定与传输媒体的接口有关的一些特性：
  + 机械特性
  + 电气特性
  + 功能特性
  + 过程特性
+ 物理层还要完成计算机的**并行处理**与**串行传输**的转换

## 2.2 数据通信的基础知识

### 2.2.1 数据通信系统的模型

+ 一个数据通信系统可分为三大部分：
  + **源系统**（或发送端、发送方）
    + **源点（source）**：源点设备产生要传输的数据。
    + **发送器**：用于编码等的调制器
  + **传输系统**（或传输网络）
    + 
  + **目的系统**（或接收端、接收方）
    + **接收器**
    + **终点（destination）**
+ 常用术语
  + 通信的目的是传递 **消息**
  + **数据**是运送消息的实体
+ 信号分类
  + **模拟信号** 或 连续信号
  + **数字信号** 或 离散信号
+ 代表不同离散数值的基本波形就称为**码元**

### 2.2.2 有关信道的几个基本概念

+ **通信方式**

  + 单向通信（单工通信）
  + 双向交替通信（半双工通信）
  + 双向同时通信（全双工通信）
    + 全双工传输效率最高

+ **信号**

  + 来自信源的信号常称为 **基带信号（基本频带信号）**
  + 基带信号进行调制以优化传输质量
  + 波形变换——基带调制，编码
  + 载波调制得到带通信号——带通调制

+ **常用编码方式**

  ![image-20200209010243055](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209010243055.png)

  + **不归零制**：正电平代表1，负电平代表0。
  + **归零制**：正脉冲代表1，负脉冲代表0。
  + **曼彻斯特编码**：位周期中心的向上跳变代表0，为周期中心的向下跳变代表1。反过来定义也可。
  + **差分曼彻斯特编码**：在每一位的中心处始终都有跳变，位开始边界有跳变代表0，而位开始边界没有跳变代表1。

+ **基本的带通调制方法**

  ![image-20200209010812511](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209010812511.png)

### 2.2.3 信道的极限容量

+ 限制码元传输速率的因素有：

  + 信道能够通过的频率范围
  + 信噪比

+ **香农公式**

  + 信道的极限信息传输速率：

    <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209054026815.png" alt="image-20200209054026815" style="zoom:65%;" />

+ 让每个码元携带更多比特的信息量可提高信息的传输速率

## 2.3 物理层下面的传输媒体

![image-20200209054604114](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209054604114.png)

### 2.3.1 导引型传输媒体

+ **双绞线**

  + 也称双扭线
  + 外面加一层金属丝编织成的屏蔽层成为屏蔽双绞线STP

  ![image-20200209054631223](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209054631223.png)

![image-20200209054639693](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209054639693.png)![image-20200209054648438](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209054648438.png)

+ 同轴线缆

  ![image-20200209054942801](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209054942801.png)

+ 光缆

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209055000158.png" alt="image-20200209055000158" style="zoom:67%;" />

  + 多条不同角度入射的光线在一条光纤中传输称为多模光纤

### 2.3.2 非导引型传输媒体

+ 微波接力通信等

## 2.4 信道复用技术

### 2.4.1 频分复用、时分复用和统计时分复用

+ **复用**

  + 共享资源

    ![image-20200209140236119](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209140236119.png)

  ![image-20200209140421858](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209140421858.png)

  ![image-20200209140438723](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200209140438723.png)

  + 复用器与分用器成对使用可实现复用

### 2.4.2 波分复用

+ WDM ( Wavelength Division Multiplexing)
+ 光的频分复用

### 2.4.3 码分复用

+ CDM (Code Division Multiplexing)
+ CDMA (Code Division Multiplexing Access) 码分多址
+ 各用户使用经过特殊处理的码型，因此各用户之间不会造成干扰
+ 很强的抗干扰能力，频谱类似白噪声，不易被敌人发现
+ CDMA原理：
  + 利用各站点持有独有的码片序列，且不同站点间的码片序列相互正交的特点，过滤出需要接收的站点用到的码片序列，得到0 1 序列，实现复用。

## 2.5 数字传输系统

+ 早期数字传输系统存在许多缺点：
  + 速率标准不统一
  + 不是同步传输

## 2.6 宽带接入技术

### 2.6.1 ADSL技术——非对称数字用户线

+ (Asymmetric Digital Subscriber Line) 技术就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务。
+ 下行带宽远远大于上行带宽，即 **非对称**

### 2.6.2 光纤同轴混合网

+ (HFC网，Hybrid Fiber Coax)
+ 我国的HFC网段划分<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200210190600838.png" alt="image-20200210190600838" style="zoom:55%;" />

### 2.6.3 FTTx技术

+ 光纤入户FTTH(Fiber To The Home)应当是最好的选择

+ 但价格稍贵，且不一定需要更高数据率

+ x代替H指光纤到达用户家附近即可

+ 无源光配网线的组成

  ![image-20200210191058833](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200210191058833.png)

+ 各种FTTx

  + 光纤到路边 FTTC curb

  + 光纤到小区 FTTZ zone
  + 光纤到大楼 FTTB building
  + 光纤到楼层 FTTF floor
  + 光纤到办公室 FTTO office
  + 光纤到桌面  FTTD desk

# Chapter 3 数据链路层

+ 数据链路层主要有以下两种类型

  + 点对点信道
  + 广播信道

+ 重要内容：

  + 数据链路层的点对点信道和广播信道的特点，以及两种信道所使用的协议（PPP协议以及CSMA/CD协议）的特点
  + 数据链路层的三个基本问题：
    + 封装成帧
    + 透明传输
    + 差错检测
  + 以太网MAC层的硬件地址
  + 适配器、转发器、集线器、网桥、以太网交换机的作用与使用场合。

+ 数据链路层地位

  ![image-20200211180726755](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200211180726755.png)

## 3.1 使用点对点信道的数据链路层

### 3.1.1 数据链路和帧

+ **链路**： 

  + 从一个节点到相邻节点的一段物理线路，中间没有任何其他的交换节点
  + 一条链路只是一条通路的一个组成部分

+ **数据链路**：

  + 除了物理线路外还需要各种协议来控制数据的传输。
  + 常用的如网络适配器
  + 也有人将数据链路分为**物理链路**与**逻辑链路**
  + 早期的数据通信协议叫做通信**规程**(procedure)

+ **帧**：

  + 点对点信道的数据链路层的协议数据单元
  + 数据链路层把网络层交下来的数据构成帧发送到链路上。
  + 点对点信道的数据链路层在进行通信时的主要步骤如下：
    1. 结点A的数据链路层把网络层交下来的IP数据报添加首部与尾部封装成帧
    2. 结点A把封装好的帧发送给结点B的数据链路层
    3. 若结点B的数据链路层收到的帧无差错，则从收到的帧中提取出IP数据报交给上面的网络层；否则丢弃这个帧

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200211182137497.png" alt="image-20200211182137497" style="zoom:50%;" />

### 3.1.2 三个基本问题

+ 数据链路层协议多种，三个基本问题相近：

  1. **封装成帧(framing)**

     + 添加首部与尾部

     + 首部尾部标识了一段一段比特流

     + 首部尾部一个重要的作用就是进行 **帧定界**（确定帧的界限）

     + 每一种链路层协议都规定了所能传送的帧的 **数据部分长度上限——最大传送单元MTU(Maximum Transfer Unit**

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200211182857715.png" alt="image-20200211182857715" style="zoom:50%;" />

     + 数据时由可打印的ASCII码组成的文本文件时，帧定界可以使用特殊的**帧定界符**。

     + 控制字符SOH(Start of Header)，编码00000001，放在一帧的最前面，表示帧的首部开始。

     + 控制字符EOT(End of Transmission)，编码00000100表示帧的结束。

     + 控制字符不是S/O/H/E/O/T。

       ![image-20200212060452733](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212060452733.png)

  2. **透明传输**

     + 若出现预期外的帧定界符，则使用转义字符。

     + **透明：某一个实际存在的事物看起来却好像不存在一样。**

     + 即对所传送的数据来说，这些数据就“看不见”数据链路层有什么妨碍数据传输的东西，亦即数据链路层对这些数据来说是透明的。

     + 转义字符“ESC”（编码1B）。

     + **字节填充或字符填充：** 具体方法是发送端的数据链路层在数据中出现控制字符的前面插入转义字符，在接收端的数据链路层在把数据送至网络层前删去插入的转义字符。

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212061443687.png" alt="image-20200212061443687" style="zoom:50%;" />

  3. **差错检测**

     + 比特在传输过程中可能出现差错，如1->0 / 0->1，称为 **比特差错**。

       + **误码率BER(Bit Error Rate)**：在一段时间内，传输错误的比特占所传输比特总数的比率。

       + 数据链路层广泛使用 **循环冗余检验CRC(Cyclic Redundancy Check)**。

       + **帧检验序列FCS(Frame Check Sequence)**：作为检验的余数。

       + CRC指方法，FCS指末尾添加的序列。

       + 例：

         <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212063549585.png" alt="image-20200212063549585" style="zoom:30%;" /> <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212063613420.png" alt="image-20200212063613420" style="zoom:33%;" />

       + 将接收的数据除以P（模2）若余数为0则正确，接受；否则错误，丢弃。

       + **凡是接收端数据链路层接受的帧均无差错，但不能做到对帧的无差错接受。**

       + *可以看出数据链路层主要提供数据传输的可靠性保证。*

     + 除了最简单的比特差错外，没有出现比特差错却出现了 如下状况称 **出现传输差错**：

       + **帧丢失**：收到1，3，丢失2。
       + **帧重复**：收到1，2，2，3。
       + **帧失序**：收到1，3，2。
       + 解决方案是增加**帧编号**、**确认**与**重传机制**。
       + 如今因为传输技术的提高，采用区别对待以平衡正确性与速率的最优化。

## 3.2 点对点协议PPP(Point-to-Point Protocol)

### 3.2.1 PPP协议的特点

1. **PPP协议应满足的需求**
   1. **简单**
      + IETF在设计互联网体系结构时将最复杂部分放在TCP协议中，而网际协议IP则相对比较简单，提供不可靠的数据报服务。
      + 对数据链路层的帧**不需纠错，不需序号，不需流量控制**。
      + 接收方收到帧，对收，错弃。
      + 简单为首要要求，提高互操作性。
   2. **封装成帧**
      + PPP协议必须规定特殊的字符作为 **帧定界符**，以便准确找到帧的开始与结束位置。
   3. **透明性**
      + 有效解决帧定界符与数据重复的问题。
   4. **多种网络层协议**
      + 必须能够 **在同一条物理链路上同时支持多种网络层协议**。
      + 当点对点链路所连接的时局域网或路由器时，PPP协议必须同时支持在链路所连接的局域网或路由器上运行的各种网络层协议。
   5. **多种类型链路**：
      + 支持如串行/并行、同步/异步、低速/高速、电的/光的、交换的/非交换的点对点链路。
      + PPPoE (PPP over Ethernet)
   6. **差错检测**
      - 作为接收数据的第一层，及时的判断差错是否存在可节省大量资源。
   7. **检测连接状态**
      - 可自动检测链路是否处于正常工作状态。
   8. **最大传送单元**
      - 必须对每一种类型的点对点链路设置 **最大传送单元MTU的默认值**，促进各种实现之间的互操作性。
      - **MTU时数据链路层的帧*可以载荷的数据部分*的最大长度而非*帧的总长度*。**
   9. **网络层地址协商**
      + 必须提供一种机制使得通信的两个网络层的实体能够通过协商知道或能配置彼此的网络层地址。
      + 简单且能在所有情况下得出协商结果。
   10. **数据压缩协商**
       + 必须提供一种方法来协商数据压缩算法。但PPP协议并不要求将数据压缩算法进行标准化。
       + TCP/IP协议族中，可靠传输由运输层的TCP协议负责，因此数据链路层的PPP协议不需要进行纠错，设序号，或进行流量控制。
2. **PPP协议的组成**（三部分）
   1. 一个将IP数据报封装到串行链路的方法。
      + PPP既支持异步，也支持面向比特的同步链路。
      + IP数据报在PPP帧中就是其信息部分。长度由MTU限制。
   2. 一个用来建立、配置、测试数据链路连接的 **链路控制协议LCP(Link Control Protocol)**。
      + 通信双方可协商一些选项。
   3. 一套 **网络控制协议NCP(Network Control Protocol)**。
      + 期中每个协议支持不同的网络层协议。

### 3.2.2 PPP协议的帧格式

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212191823260.png" alt="image-20200212191823260" style="zoom:50%;" />

1. **各字段的意义**
   + PPP帧的首部和尾部分别为四个字段与两个字段。
   + 连续出现两个标志字段就表示这是一个空帧，应当丢弃。
2. **字节填充**
   + 当信息字段中出现和标志字段一样的比特（0x7E）组合时，就必须采取一些措施使这种形式上和标志字段一样的比特组合不出现在信息字段中，亦即 **支持更多字符的透明化**。
   + 填充后字节数超过原来的字节数，接收端逆变换后恢复出原来信息。
3. **零比特填充**
   + **F为0x7E**
   + 为避免F的识别错误，发送端每5个1后添加一个0，接收端每5个1后删去一个0。

### 3.2.3 PPP协议的工作状态

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212212334032.png" alt="image-20200212212334032" style="zoom:50%;" />

+ 链路建立中协商LCP的一些配置选项，发送LCP的配置请求帧，是一个PPP帧，链路另一边回复：
  + 配置确认帧(Configure-Ack)：所有选项都接受。
  + 配置否认帧(Configure-Nak)：所有选项都理解但不能接受。
  + 配置拒绝帧(Configure-Reject)：选项有的无法识别或不能接受，需要协商。
+ 链路静止->物理链路->LCP链路->鉴别->NCP链路->交换数据

## 3.3 使用广播信道的数据链路层

### 3.3.1 局域网的数据链路层

+ 局域网最主要的特点：**网络为一个单位所拥有，且地理范围和站点数目均有限。**
+ 局域网的主要优点：
  + 具有广播功能，从一个站点可以很方便地访问全网，局域网上的主机可共享连接在局域网上的各种硬件和软件资源。
  + 便于系统的扩展和逐渐演变，各设备的位置可灵活调整和改变。
  + 提高了系统的可靠性(reliability)，可用性(availability)和生存性(survivability)。

+ 常见拓扑结构有：星形，环形，总线……
+ **共享信道**着重要考虑的一个问题就是如何使众多用户合理方便地共享通信媒体资源，两种方法：
  1. **静态划分信道**
     + 只要分配到了信道就不会和其他用户发生冲突，但是局域网内该方法代价高，不适合局域网。
  2. **动态媒体接入控制**
     + 又称 **多点接入**，特点是信道并非在用户通信时固定分配给用户。分两类：
       + **随机接入**。所有用户随机发信息，如果恰巧产生冲突，碰撞，则失败，因此要有解决碰撞的网络协议。
       + **受控接入**。用户必须服从一定的控制。例如分散控制的**令牌环局域网**和**集中控制的多点线路探寻**或**轮询**。较少。

+ 传统以太网——表示最早流行的10Mbit/s速率以太网。

1. 以太网的两个标准

   + IEEE 802委员会是专门制定局域网和城域网标准的机构。
   + 1983年制定了第一个IEEE的以太网标准IEEE 802.3[W-IEEE802.3]，数据率为10Mbit/s。

2. 适配器的作用

   + 计算机与外界局域网的连接是通过通信适配器进行的。

   + 网络接口板又称为**网络接口卡NIC（Network Interface Card）**，或简称为**网卡**

   + 这种通信适配器上装有处理器和存储器（RAM和ROM）。

   + 适配器的一个重要功能就是要进行数据串行传输和并行传输的转换。

   + 由于网络的数据率与计算机总线上的数据率并不相同，因此适配器中必须装有对数据进行缓存的存储芯片。

   + 适配器包含了物理层与数据链路层的功能。

   + 适配器接收和发送各种帧时不使用计算机的CPU，当收到正确帧时使用中断通知该计算机，并交付协议栈中的网络层。当计算机要发送IP数据报时，就由协议把IP数据报向下交给适配器，组装成帧后发送到局域网。

   + 计算机的硬件地址——MAC地址，就在适配器的ROM中，而计算机的软件地址——IP地址，在计算机的存储器中。

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212230954273.png" alt="image-20200212230954273" style="zoom:50%;" />

### 3.3.2 CSMA/CD协议

+ 总线的特点：当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据，这就是广播通信的方式。

+ 为实现一对一通信，我们可以使每一台计算机的适配器拥有一个与其他适配器都不同的地址。

+ 接收时地址与自己相同则接收不同则丢弃。

+ 局域网上的计算机常被称为**主机、工作站、站点、站**

+ 为通信简便，以太网采取了以下两种措施：

  1. 采用较为灵活的**无连接**的工作方式。

     + 即不必先建立连接就可直接发送数据。
     + 不进行编号，也不要求对方发回确认。
     + 提供的服务是尽最大努力交付，即不可靠交付。
     + 对有差错帧是否需要重传则由高层决定。以太网并不清楚发送或接收的是否为重复帧，只有上层知道
     + 由于是总线结构，因此同一时间只允许一台计算机发送数据。使用**CSMA/CD协议**，即**载波监听多点接入/碰撞检测（Carrier Sense Multiple Access with Collision Detection）**避免碰撞情况。

  2. 以太网发送的数据都使用**曼彻斯特编码**的信号

     + 最大问题：当出现一长串的连1或连0时，接收端就无法从收到的比特流中提取位同步信号。

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212232800244.png" alt="image-20200212232800244" style="zoom:50%;" />

+ **CSMA/CD协议要点**

  + **多点接入**

    + 说明是总线型网络，协议实质为 **载波监听**和**碰撞检测**。

  + **载波监听**

    + 不管在发送前，发送中，每个站都必须不停地检测信道。
    + 发送前检测是为了发送权，若检测出已经有其他站在发送，则暂时不发，信道空闲时再发送。
    + 发送中检测信道，是为了及时发现有没有其他站的发送和本站的发送的碰撞，称为 **碰撞检测**。

  + **碰撞检测**

    + **边发送边监听**

    + 也称 **冲突检测**

    + 一旦发现总线上出现碰撞，其适配器就要立即停止发送。

    + 局域网分析中，常把总线上的单程端到端传播时延记为τ，最迟发生碰撞时间为2τ。

      <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200212234132583.png" alt="image-20200212234132583" style="zoom:50%;" />

+ 在使用CSMA/CD协议时，一个站不可能同时进行发送和接收，但必须边发送边监听信道。因此CSMA/CD协议只能 **半双工通信**。

+ **强化碰撞**：当发送数据的站一旦发现发生了碰撞时，除了立即停止发送数据外，还需要再继续发送32比特或48比特的人为干扰信号。以便让所有用户都知道现在已经发生了碰撞。

+ 以太网还规定了 **帧间最小间隔**为9.6μm。相当于96比特时间。以便刚刚收到数据帧的站的接收缓存来得及清理。

+ CSMA/CD**协议要点**

  1. **准备发送**：适配器从网络层获得一个分组，加上以太网的首部和尾部，组成以太帧，放入适配器的缓存中，发送前注意检测。
  2. **检测信道**：若信道忙，则不断检测，一直等到信道转为空闲，若空闲且96bit时间内信道空闲， 就发送这个帧。
  3. **发送中不断检测**，只有两种可能性：
     1. 发送成功，争用期内未检测到碰撞。
     2. 发送失败：争用期内检测到碰撞。立即停止发送数据，并按规定发送人为干扰信号，执行退避算法。若重传达16次，则向上报错。

+ 以太网每发送完一帧先保留一下以便重传。

### 3.3.3 使用集线器的星形拓扑

+ **集线器（hub）**：星形中心增加的一种可靠性非常高的设备。

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213072731370.png" alt="image-20200213072731370" style="zoom:50%;" />

+ 集线器的一些特点：

  + 使用集线器的以太网再逻辑上 **仍是一个总线网**，各站共享逻辑上的总线，使用的还是CSMA/CD协议（实质是各计算机中的适配器使用的还是CSMA/CD协议）。同一时刻至多只允许一个站发送数据。

  + 一个集线器有许多接口，像一个多借口转发器。

    <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213073512621.png" alt="image-20200213073512621" style="zoom:50%;" />

  + 集线器工作在物理层，每个接口仅仅简单地转发比特，不进行碰撞检测。

  + 集线器采用了专门的芯片，进行自适应串音回波抵消。可使接口转发出去地较强信号不致对该接口接收到的较弱信号产生干扰。

  + 集线器本身必须可靠。

### 3.3.4 以太网的信道利用率

+ 多个站同时工作时数据率会因碰撞情况而下降。

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213144410990.png" alt="image-20200213144410990" style="zoom:50%;" />

+ 成功发送一个帧需要占用信道的时间是T0+τ，比这个帧的发送时间要多一个单程端到端时延τ。因此必须在经过时间T0+τ后以太网的媒体才完全进入空闲状态，才允许其他站发送数据。

+ 要提高以太网的信道利用率，就必须减小τ与T0之比。以太网中定义a为 **单程端到端时延τ**与 **帧的发送时间T0**之比：

  $$
  a=\frac{τ}{T_0}
  $$

  + 当a->0时，表示只要一发生碰撞就立即可以检测出来。

  + a应当尽量小一些。

  + 假设不会发生碰撞且最大化利用网络传输资源，则发送一帧占用线路的时间是T~0~+τ，而帧本身发送时间是T~0~，则极限信道利用率S~max~为：
    $$
    S_{max}=\frac{T_0}{T_0+τ}=\frac{1}{1+a}
    $$

    + 只有当a远小于1才能得到尽可能高的极限信道利用率。

### 3.3.5 以太网的MAC层

1. **MAC层的硬件地址**

   + **硬件地址**又称**物理地址**或**MAC地址**.

   + ==**“名字指出我们所要寻找的那个资源，地址指出那个资源在何处，路由告诉我们如何到达该处。**==

   + IEEE 802为局域网规定了一种48位的全球地址，指局域网上的每一台计算机中 **固化在适配器的ROM中的地址**，因此：

     1. 适配器损坏则地址改变。
     2. 物理地址与地理位置无关。

   + 如果连接在局域网上的主机或路由器安装有多个适配器，那么这样的主机或路由器就有多个地址。更准确的说，这种48位地址更像是某个接口的标识符。

   + IEEE的**注册管理机构RA( Registration Authority)**是局域网全球地址的法定管理机构，它负责分配地址字段的6个字节中的前三个字节，称为 **组织唯一标识符OUI(Organizationally Unique Identifier**，通常也称为 **公司标识符(company_id)** 厂家自行分配之后的字节，称为 **扩展标识符(extended identifier)**。

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213162704794.png" alt="image-20200213162704794" style="zoom:50%;" />

   + 适配器的**过滤功能**，每收到一个MAC帧就先用硬件检查目的地址，如果是本站的帧则收下，否则丢弃，发往本站的帧包括以下三种帧：

     1. **单播(unicast)**：一对一，收到的帧的MAC地址与本站的硬件地址相同
     2. **广播(broadcast)**：一对全体，即发送给本局域网上所有站点的帧（全1地址）
     3. **多播(multicast)**：一对多，即发送给本局域网上一部分站点的帧

   + 以太网适配器还可设置为一种特殊的工作方式，即 **混杂方式(promiscuous mode)**。可用于黑客窃听。

2. **MAC帧的格式**

   <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213163047040.png" alt="image-20200213163047040" style="zoom:50%;" />

   + 前两个字段为**目的地址**和**源地址**。
   + **类型字段**用来标志**上一层使用的是什么协议**，以便把收到的MAC帧的数据上交给上一层的这个协议。 
   + **数据字段**长度在46到1500字节之间。
   + 最后一个字段是4字节**帧检验序列FCS（使用CRC检验）**。
   + 当数据字段长度小于46字节时，MAC子层就会在数据字段后面加入一个整数字节的填充字段。保证MAC帧长度不小于64字节。
   + 从MAC子层向下传到物理层时还要在帧的前面插入8字节（由硬件生成），它由两个字段构成。
     1. 第一个字段是7个字节的前同步码（1和0的交替码），它的作用是使接收端的适配器在接收MAC帧时能够迅速调整其时钟频率。
     2. 第二个字段是帧开始定界符，定义为10101011，他的前六位作用与同步码一样，最后两个连续的1告诉接收端适配器”MAC帧马上来，请签收。“
   + IEEE 802.3标准规定的MAC帧格式与上述以太网V2 MAC帧格式的区别在于两处：
     + 第一，IEEE 802.3第三字段是”长度/类型“大于0x0600时表示类型，小于时表示长度。
     + 第二，小于0x0600时，数据字段必须装入上面的逻辑链路控制LLC子层的LLC帧。
   + LLC帧逐渐失去原来意义。

## 3.4 扩展的以太网

+ 这种扩展的以太网络在网络层看来仍然是一个网络。

### 3.4.1 在物理层扩展以太网

+ 思想是利用光纤的高速通信来克服CSMA/CD的距离限制。使得主机间距离可以达到更远，实现在物理层的扩展。

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213171107787.png" alt="image-20200213171107787" style="zoom:50%;" />

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213171312188.png" alt="image-20200213171312188" style="zoom:50%;" />

+ 优点：

  1. 不同系跨系通信。
  2. 扩大以太网覆盖范围。

+ 缺点：

  1. 每个系的10BASE-T以太网是一个独立的**碰撞域（collision domain，又称为冲突域）**，即任意时刻，每个域中只能有一个站在发送数据。这一特点也会扩展，即多个碰撞域内同时刻只能有一个主机在发送数据。
  2. 如果不同的系使用不同的以太网技术，就不能用集线器将他们互连。

### 3.4.2 在数据链路层扩展以太网

+ 扩展以太网更常用的方法是在数据链路层进行。
+ 最初使用网桥。网桥对收到的帧根据其MAC帧的目的地址进行**转发**和**过滤**。
+ 网桥收到一个帧时并不是向所有的接口转发此帧，而是根据目的MAC地址查找网桥中的地址表，然后确定发送给某个接口或丢弃。
+ 后来出现 **交换式集线器(switching hub)**，常被称为以太网**交换机(switch)**或**第二层交换机(L2 switch)**，强调**这种交换机工作在数据链路层**。

1. **以太网交换机的特点**

   + **多接口网桥**
   + 相互通信的主机都是 **独占传输媒体，无碰撞地传输数据**
   + 接口有存储器，能在输出端口繁忙时把到来的帧进行缓存。
   + 是一种即插即用设备，内部的帧**交换表**（又称**地址表**）是通过自学习算法自动地逐渐建立起来的。
   + 使用独立芯片比网桥快很多。
   + 不贵。
   + 共享带宽，不独占，使得用户间不冲突，==最大优点==。
   + 从共享总线以太网转到交换式以太网时，所有接入设备的软件和硬件、适配器等都不需要做任何改动。
   + 多种速率选择。

2. **以太网交换机的自学习功能**

   + 以太网交换机运行自学习算法自动维护交换表，

   + 算法思想为：有就发，没有就加。

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213174846724.png" alt="image-20200213174846724" style="zoom:50%;" />	

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213174617346.png" alt="image-20200213174617346" style="zoom:50%;" />

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213174812314.png" alt="image-20200213174812314" style="zoom:50%;" />

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213174949201.png" alt="image-20200213174949201" style="zoom:50%;" />

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213175022308.png" alt="image-20200213175022308" style="zoom:50%;" />

+ 当添加冗余链路时，可能会出现兜圈子帧问题。

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213175651284.png" alt="image-20200213175651284" style="zoom:50%;" />

+ 为解决兜圈子帧的问题IEEE 802.1D标准制定了一个**生成树协议（STP Spanning Tree Protocol）**，逻辑上是切断了某些链路使得一台主机到所有其他主机的路径是无环路的树状结构。

3. **从总线以太网到星形以太网**
   + 技术越来越强就换了。
   + 虽然不用CSMA/CD但仍为以太帧结构，所以称以太网。

### 3.4.3 虚拟局域网 VLAN(Virtual LAN)

+ 定义：**有一些局域网网段构成的与物理位置无关的逻辑组，而这些网段具有某些共同的需求，每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的计算机属于哪个VLAN。**

+ 只是局域网给用户提供的一种服务而非一种新型局域网。

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213182200006.png" alt="image-20200213182200006" style="zoom:50%;" />

+ 防止产生广播风暴现象。

+ 插入VLAN标记后变成了802.1Q帧<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213182519801.png" alt="image-20200213182519801" style="zoom:50%;" />

## 3.5 高速以太网

+ 速率达到或超过**100Mbit/s**的以太网称为高速以太网

### 3.5.1 100BASE-T以太网

### 3.5.2 吉比特以太网

### 3.5.3 10吉比特以太网和更快的以太网

+ 以太网的工作范围已逐渐扩大，从而实现了端到端的以太网传输。此工作方式的好处有：
  1. 经实践证明的成熟技术，大家都愿意使用。
  2. 互操作性很好，不同厂商生产的以太网都能可靠地互操作。
  3. 在广域网中使用以太网时价格便宜。
  4. 适应多种传输媒体，不必重新布线。
  5. 端到端的以太网连接使得帧的格式全都是以太网的格式，不需要格式转换，简化操作与管理。
+ 以太网从10Mbit/s到10Gbit/s甚至100Gbit/s的演进证明以太网是：
  1. 可扩展的（速率的提升）
  2. 灵活的（多种媒体、全/半双工、共享/交换）
  3. 易于安装
  4. 稳健性好

### 3.5.4 使用以太网进行宽带接入

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200213183019325.png" alt="image-20200213183019325" style="zoom:50%;" />



# Chapter 4 网络层

+ 重要内容：
  + 虚拟互连网络的概念
  + IP地址与物理地址的关系
  + 传统的分类的IP地址（包括子网掩码）和无分类域间路由选择CIDR
  + 路由选择协议的工作原理

## 4.1 网络层提供的两种服务

+ 起初提出借鉴电信网的成功经验，在网络层建立虚电路，每组IP报只需包含分组号即可由对应虚电路传输数据。但先驱者提出电信网的端设备为电话，不够智能，没有差错处理机制，因此电信网提供的端到端可靠传输服务对电话业务合适但不适合计算机的端到端通信。

+ 互联网采用的设计思路为：

  + 网络层向上只提供**简单灵活的、无连接的、尽量大努力交付的数据报服务**。
  + 网络层不提供服务质量的承诺。可能出现出错、丢失、重复、失序，不保证分组交付，可靠性由运输层保证。

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200214053138911.png" alt="image-20200214053138911" style="zoom:40%;" /><img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200214053158005.png" alt="image-20200214053158005" style="zoom:43%;" />

+ | **对比的方面**                 | **虚电路服务**                                     | **数据报服务**                                         |
  | ------------------------------ | -------------------------------------------------- | ------------------------------------------------------ |
  | **思路**                       | **可靠通信应当由网络来保证**                       | **可靠通信应当由用户主机来保证**                       |
  | **连接的建立**                 | **必须有**                                         | **不需要**                                             |
  | **终点地址**                   | **仅在连接建立阶段使用，每个分组使用短的虚电路号** | **每个分组都有终点的完整地址**                         |
  | **分组的转发**                 | **属于同一条虚电路的分组均按照同一路由进行转发**   | **每个分组独立选择路由进行转发**                       |
  | **当结点出故障时**             | **所有通过出故障的结点的虚电路均不能工作**         | **出故障的结点可能会丢失分组，一些路由可能会发生变化** |
  | **分组的顺序**                 | **总是按发送顺序到达终点**                         | **到达终点时不一定按发送顺序**                         |
  | **端到端的差错处理和流量控制** | **可以由网络负责，也可以由用户主机负责**           | **由用户主机负责**                                     |

## 4.2 网际协议IP

+ 这里讲IPv4

+ 与IP协议配套使用的还有三个协议：

  + **地址解析协议ARP(Address Resolution Protocol)**
  + **网际控制报文协议ICMP(Internet Control Message Protocol)**
  + **网际组管理协议IGMP(Internet Group Management Protocol)**

  还有一个协议叫做逆地址解析协议RARP(Reverse Address Resolution Protocol)和ARP协议配合使用，但已淘汰。

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200214054218777.png" alt="image-20200214054218777" style="zoom:50%;" />

+ 称**网际层**或**IP层**是为了表达网际协议IP是用来使互连起来的许多计算机网络能够通信，强调这是由很多网络构成的互联网络。

### 4.2.1 虚拟互连网络

+ **没有一种单一的网络可以适应所有用户的需求。**

+ 从一般概念来讲，将网络互相连起来要使用一些中间设备，根据中间设备所在的层次可有四种不同的中间设备：

  1. 物理层——**转发器(repeater)**，仅扩大网络。
  2. 数据链路层——**网桥**或**桥接器**(bridge)，仅扩大网络。
  3. 网络层——**路由器(router)**，一台专用计算机，用来在互联网中进行路由选择。
  4. 网络层以上——**网关(gateway)**，用网关连接两个不兼容的系统需要在高层进行协议的转换。

  + 由于历史原因，许多有关TCP/IP的文献曾经把网络层使用的路由器称为网关（PacketTracer？）

+ 由于参加互连的计算机网络都是用相同的**网际协议IP(Internet Protocol)**，因此可将互连后的计算机网络看成一个**虚拟互连网络(internet)**。
  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200214063435898.png" alt="image-20200214063435898" style="zoom:67%;" />

+ 互连起来的各种物理网络的异构性本来是客观存在的，但我们利用**IP协议**可使这些性能各异的网络**在网络层上看起来好像是一个统一的网络**。

+ 这里强调：**互联网可以由多种异构网络互连组成。**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200214064032940.png" alt="image-20200214064032940" style="zoom:50%;" />

### 4.2.2 分类的IP地址

1. **IP地址及其表示方法**

   + 整个的互联网就是一个**单一的、抽象的网络**。

   + IP地址就是给互联网上的**每一台主机（或路由器）**的每一个接口分配一个在全世界范围内是唯一的32位标识符。

   + IP地址结构使我们可以在互联网上很方便地进行寻址。

   + IP地址现在由**互联网名字和数字分配机构ICANN（Internet Corporation for Assigned Names and Numbers）进行分配。

   + IP地址的编址方法经过了三个历史阶段：

     + **分类的IP地址。**最基本的编址方法。
     + **子网的划分。**这是对最基本的编址方法的改进。
     + **构成超网。**这是比较新的无分类编址方法。

   + 分类的IP地址就是将IP地址划分为若干个固定类，这里的A类、B类、C类地址都由两个固定长度的字段组成。

   + 第一个字段是 **网络号(net-id)**，标志主机所连接到的网络。

     + 一个网络号在整个互联网范围内必须是唯一的。

   + 第二个字段是 **主机号(host-id)**，标志该主机（或路由器）。

     + 一台主机号在它前面的网络范围内必须唯一。

   + 这种两级的IP地址可记为：
     $$
     IP地址 ::= \{<网络号>,<主机号>\}
     $$
     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200214070057328.png" alt="image-20200214070057328" style="zoom:50%;" />

     + A类、B类、C类地址的网络号字段分别为1个、2个、3个字节长，而在网络号字段的最前面有1~3位的类别位，数值分别规定为0，10，110（哈夫曼思想）。
     + A类、B类、C类地址的主机号字段分别为3个，2个，1个字节长。
     + D类地址（前四位1110）用于多播。
     + E类地址（前四位1111）保留为以后用。
     + 从IP地址的结构来看，IP地址不仅指明一台主机，而且指明了主机所连接到的网络。

   + 书写时多采用 **点分十进制记法（dotted decimal notation）**，当记为二进制时，每八位间空格隔开。<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200214070955556.png" alt="image-20200214070955556" style="zoom:50%;" />

2. **常用的三种类别的IP地址**

   + **A类地址**

     + 网络号字段占1个字节，只有7位可供使用，第1位固定为0。
     + 可指派网络为2^7^-2个，网络号字段全0为保留地址，意为“本网络”去掉一个本网络（全0），去掉一个环回地址（127.0.0.1）
     + 环回地址不会出现在网络上，本地测试用。
     + 整个A类地址空间共有2^31^个地址。

   + **B类地址**

     + 网络号字段占2个字节，只有14位可供分配，前两位为10
     + 网络号字段后段14位无论怎样取值也不可能出现**使整个2字节的网络号字段**成为全0或全1。
     + B类网络地址128.0.0.0是不指派的，可指派的B类最小网络地址是128.1.0.0，因此B类网络可指派数为2^14^-1，即16383。
     + B类地址的每一个网络上的最大主机数是**2^16^-2**，即65536-2=65534。
     + 整个B类地址空间共约有2^30^个地址，占整个IP地址空间的25%。

   + **C类地址**

     + 网络号字段占3个字节，只有21位可供分配，前三位为110
     + C类网络地址192.0.0.0也是不指派的，可指派的最小C类地址为192.0.1.0
     + 因此C类地址可指派的网络地址总数是2^21^-1，即2097151。
     + 每一个C类地址的最大主机数是2^8^-2，即254。
     + 整个C类地址空间共约有2^29^个地址，占整个IP地址的12.5%。

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200221061655659.png" alt="image-20200221061655659" style="zoom:50%;" />

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200221061727144.png" alt="image-20200221061727144" style="zoom:50%;" />

   + IP地址具有以下一些重要特点：

     1. **每一个IP地址都由网络号和主机号两部分组成。**
        + 分等级的地址结构
        + 路由器仅根据目的主机所连接的网络号来转发分组，不考虑主机号，减小了路由表所占的存储空间以及查找路由表的时间
     2. **实际上IP地址是标志一台主机（或路由器）和一条链路的接口**
        + 当一台主机连接在两个网络上时，该主机就必须同时拥有两个相应的IP地址，网络号必须不同，这种主机称为**多归属主机（multihomed host）**
     3. **用转发器或网桥连接起来的若干个局域网仍为一个网络**
     4. **在IP地址中，所有分配到网络号的网络都是平等的**
        + 不论大小网络，只要分配了网络号

   + 注意：当两个路由器直接相连时，在连线两端的接口处，可以分配也可以不分配IP地址，若分配地址则这段连线就构成了一种只包含一段线路的特殊“网络”。但未节省IP资源，对这种仅由一段连线构成的特殊“网络”，现在也常常不分配IP地址。通常把这样的特殊网络叫做 **无编号网络（unnumbered network）或无名网络（anonymous network）**。

### 4.2.3 IP地址与硬件地址

+ 区别：

  + 硬件地址用于**数据链路层**与**物理层**，是焊上去的。

  + IP地址用于**网络层**和**以上各层使用**的地址，是一种逻辑地址。

  + MAC帧包含IP部分，即MAC外层，IP内层，剥去MAC才能看到IP

    ![image-20200221071826902](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200221071826902.png)

    ![image-20200221071938673](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200221071938673.png)

+ 强调以下几点：

  + 在IP层抽象的互联网上只能看到IP数据报
  + 虽然IP数据报首部有源站IP地址，但路由器只根据**目的站的IP地址的网络号**进行路由选择。
  + 在局域网的链路层，只能看见MAC帧。
  + 尽管互连的网络的硬件地址体系各不同，但IP层抽象的互联网却屏蔽了下层这些很复杂的细节，只需要上层讨论，下层实现。

### 4.2.4 地址解析协议ARP(Address Resolution Protocol)

+ 用于解决知道某机器的IP地址需要找出相应的硬件地址。

+ 由于IP协议使用了ARP协议，因此通常就把ARP协议划归网络层。但由于它从网络层获取IP以得到MAC地址，因此也有划归在数据链路层，二者都有理由。

+ **ARP协议要点**

  + IP地址与MAC地址不存在简单的映射关系。为解决此问题，在主机ARP高速缓存中存放一个**IP地址到硬件地址的映射表**，而且该表可动态更新（新增或删除）。

  + 每台主机设有一个**ARP高速缓存（ARP cache）**，存储本局域网上的各主机和路由器的IP地址到硬件地址的映射表。

    <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200222110732607.png" alt="image-20200222110732607" style="zoom:50%;" />

    <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200222110812094.png" alt="image-20200222110812094" style="zoom:50%;" />

    <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200222111159102.png" alt="image-20200222111159102" style="zoom:50%;" />

  + 目前看来ARP是用于同一局域网内的。

  + 保存映射关系至高速缓存中使得网络压力大大减小。

  + ARP对保存在高速缓存中的每一个映射地址项目都设置生存时间**TTL（Time to Live）**，例如十到二十分钟。超时则删除。

  + 当不同局域网内的主机间通信时，发送方先将数据报的IP地址解析至路由器以便将其发送给路由器，路由器从转发表找出下一跳路由器并发送，最终路由器间接转发给目的主机。

  + 从IP地址到硬件地址的解析是自动进行的，主机的用户对这种解析过程一无所知。只要主机间通信，就会使用ARP协议。

+ **ARP的四种典型情况**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200222112746413.png" alt="image-20200222112746413" style="zoom:50%;" />

  1. 发送方是主机，要把 IP 数据报发送到本网络上的另一个主机，**即H~1~发给H~2~**。这时用 ARP 找到目的主机的硬件地址。

  2. 发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机，**即H~1~发给H~4~**。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。

  3. 发送方是路由器，要把 IP 数据报转发到本网络上的一个主机，**即R~1~发给H~1~**。这时用 ARP 找到目的主机的硬件地址。

  4. 发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机，**即R~1~发给H~4~**。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。

+ **为什么有了硬件地址还需要IP地址呢？？**

  + 硬件地址格式各不相同，**网络异构性**使得通信必须进行非常复杂的地址转换工作。
  + IP地址使得异构网络像在同一个网络内进行通信。

### 4.2.5 IP数据报的格式

+ 在TCP/IP标准中，各种数据格式常以32位（4bytes）为单位来描述。

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200222113930712.png" alt="image-20200222113930712" style="zoom:50%;" />

+ 一个IP数据报由首部和数据部分组成。
+ 首部的前一部分是**固定长度**，共20字节，在首部的固定部分后面是一些**可选字段**，其长度可变。

1. **IP数据报首部的固定部分中的各字段**
   1. **版本**
      + 占4位
      + IP协议的版本
      + 通信双方使用的IP协议的版本必须一致
   2. **首部长度**
      + 占4位，最大0xF
      + 单位是32位，即若0xF则15个32位字长，即60字节
      + 最长60字节，希望用户尽量减少开销，但有时可能不用
      + 最常用的首部长度是20字节，不使用任何选项
   3. **区分服务（Differentiated Service）**
      + 占8位
      + 用来获取更好的服务，旧标准中叫 **服务类型**
      + 只有区分服务时使用，一般都不使用此字段
   4. **总长度**
      + 占16位
      + 总长度指首部和数据之和的长度，单位为字节
      + 数据报的最大长度为2^16^-1=65535字节，很少遇到这么长的
      + 数据链路层协议都规定了一个数据帧中的数据字段的最大长度，称为**最大传送单元MTU（Maximum Transfer Unit）**，当一个IP数据报封装成链路层帧时，次数据报总长度（即首部加上数据部分）一定不能超过下面的数据链路层所规定的MTU值。必须把过长数据报分片处理
      + 数据报越短路由器转发越快
      + IP协议规定，在互联网中的所有主机和路由器必须能接受长度不超过512+60+4=576字节的数据报
      + 在进行分片时，数据报首部中的“总长度”字段指分片后每一个分片的首部长度与该分片的数据长度的总和
   5. **标识**
      + 占16位
      + IP软件在存储器中维持一个计数器，每产生一个数据报，计数器就加一，但标识不是序号，因为IP是 **无连接服务**，数据报不存在按序接受的问题。
      + 标识用于保证各同批的分片的正确重装
   6. **标志(flag)**
      + 占3位，目前只有2位有意义
      + 最低位记为**MF(More Fragment)**，MF=1表示后面还有分片，MF=0表示表示这已是若干数据报片中的最后一个。
      + 中间位记为**DF(Don't Fragment)**，意思为不能分片，只有当DF=0时才允许分片。
   7. **片偏移**

      + 占13位
      + 分片后各分片在原分组中的位置
      + 片偏移以8个字节为偏移单位，也就是说，除最后一个数据报片外，每个分片长度一定是8字节（64字节）的整数倍
   8. **生存时间**
      + 占8位
      + TTL（Time to Live）
      + 本来以秒为单位，每次经过一个路由器就把TTL减去数据报在路由器所消耗掉的一段时间。若消耗时间小于1秒，则减去1。当TTL变为0时就丢弃此数据报。
      + 随着技术进步，传输时间缩短，后来将TTL单位由秒改为跳数，经过一个路由器就减1。
   9. **协议**
      + 占8位
      + 指出此数据报携带的是何种协议，以便使目的主机IP层知道该将数据部分上交给哪个协议进行处理。
   10. **首部检验和**
       + 占16位
       + **只检验数据报首部，但不包括数据部分。**
       + 不采用复杂的CRC校验码而是：将首部分为许多16位字的序列，并把检验和字段置零，发送方将这些序列以反码算术运算，把所有相加后的和的反码记于检验和字段；接收方收到数据报后全部使用反码算术运算相加一次，正确则结果为0，有差错则丢弃。
   11. **源地址**
       + 占32位
   12. **目的地址**
       + 占32位
2. **IP数据报首部的可变部分**
   + 长度可变，1位到40位不等
   + 有些选项需要多个字节，选项间不需分隔符，直接拼起来，最后用全0填充至字节整数倍

### 4.2.6 IP层转发分组的流程

+ 对于一条路由最主要的是以下两个信息：

  <center>(目的网络地址，下一跳地址)</center>

+ 根据目的网络地址来确定下一跳路由器，可得出以下结果：	

  1. IP数据报**最终**一定可以找到目的主机所在的目的网络上的路由器
  2. 只有到达最后一个路由器时，才试图向目的主机进行直接交付

+ 虽然互联网的所有分组转发都是 **基于目的主机所在的网络**，但大多数情况下允许 **特定主机路由**的特例。

+ 路由器还可采用默认路由以减小路由表所占用的空间和搜索时间。

+ **下一跳路由器的IP地址由本路由器得出，并使用ARP得出MAC地址，实现下一跳的寻址。**

+ **分组转发算法：**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200229101145776.png" alt="image-20200229101145776" style="zoom:50%;" />

+ 路由表并不指明到某个网络的完整路径，他是由分步寻找最合适的方向和下一跳路由转发数据报。

## 4.3 划分子网与构造超网

### 4.3.1 划分子网

1. 从两级IP到三级IP

   + 早期IP地址设计不够合理

     + **IP地址空间的利用率有时很低**
     + 给每一个物理网络分配一个网络号会使得**路由表变得太大**而使网络性能变坏
     + **两级IP地址不够灵活**

   + 为解决上述问题，1985年起增加“**子网号字段**“，叫做**划分子网（subnetting）**或 **子网寻址**或 **子网路由选择。**

   + **划分子网基本思路：**

     1. 一个拥有许多物理网络的单位，可将所属的物理网络划分为若干个子网（subnet），纯属内部的行为，外部无法获知，对外仍表现为一个网络。

     2. 划分方法是从网络的主机号借用若干位作为子网号，主机号也就相应减少了相同的位数。记法：

        <center> IP地址 ::= {<网络号>,<子网号>,<主机号>}</center>

     3. 接收数据报时先由网络号与子网号找到相应网络再由主机号找目的主机

        <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200229103137496.png" alt="image-20200229103137496" style="zoom:50%;" />

     + **划分子网只是将主机号进行了再划分，并不影响网络号**

2. **子网掩码**

   + 由于从IP数据报的首部无法看出源主机或目的主机所连接的网络是否进行了子网的划分，因此使用子网掩码（subnet mask）

   + 使用规定的子网掩码与IP地址进行与操作则可得出相应的网络地址。

   + **子网掩码是一个网络或一个子网的重要属性**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200229104947186.png" alt="image-20200229104947186" style="zoom:50%;" />

   + 在采用固定长度子网时，所划分的所有子网掩码都是相同的

   + 子网号位数不能为0，1，15，16（原因主要是考虑回环地址与广播地址）

   + 之前全1和全0的子网号不能使用，随着CIDR无分类域间路由选择广泛应用，现在都能用了

   + **划分子网增加了灵活性，减少了能够连接在网络上的主机数**

   + 同样的IP地址和不同的子网掩码可以得出相同的网络地址，但不同的掩码效果不同

### 4.3.2 使用子网时分组的转发

+ 在划分子网的情况下，分组转发的算法必须做相应的改动

+ 使用子网划分后，路由表必须包含：

  1. **目的网络地址**
  2. **子网掩码**
  3. **下一跳地址**

+ 在划分子网情况下，路由器转发分组的算法如下：

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200229111057887.png" alt="image-20200229111057887" style="zoom:50%;" />

### 4.3.3 无分类编址CIDR（构造超网）

1. **网络前缀**

   + IPv4还是不够用， 通过 **无分类编址**方法解决不够用的问题

   + 使用 **变长子网掩码VLSM（Variable Length Subnet Mask）**可进一步提高IP地址资源利用率。在此基础上得到 **无分类编址方法**，即**无分类域间路由选择CIDR（Classless Inter-Domain Routing）**
   + CIDR两个主要特点：
     + 消除了传统的A类、B类、C类地址以及划分子网的概念
       + 将IP地址划分为 **网络前缀**和 **主机号**两部分。
       + 从三级编址回到了两级编址。
       + **IP地址 ::= {<网络前缀>,<主机号>}**
       + 还使用**斜线记法（slash notation）**，称为CIDR记法，即在IP地址后面加上斜线，再写上网络前缀所占的位数。
     + CIDR把网络前缀都相同的连续的IP地址组成一个“**CIDR地址块**”，只要知道地址块中的一个地址，就可以知道这个地址块中的起始地址。
       + 例如：128.14.35.7/20
       + 地址掩码中连1的长度就是网络前缀的长度
       + **CIDR不使用子网是指CIDR并没有在32位地址中指明若干位作为子网字段，但是分配到一个CIDR地址块的单位还是可以自行划分子网。**
   + 由于一个CIDR地址块中又很多地址，所以路由表中利用CIDR地址块来查找目的网络，这种地址的聚合常称为**路由聚合（route aggregation）**，也称为构造超网（supernetting）。
   + CIDR记法多样，例如10/10，00001010 00*，**超网的IP记法注重网络号，主机号可任意。**
   + 构造超网，使用CIDR的一个好处就是可以灵活有效地分配IPv4地址空间。
   + 构造超网并未加长网络前缀，而三级结构的IP地址中，划分子网使得网络前缀边长，主机数减少。

2. **最长前缀匹配（longest-prefix matching）**

   + 得到不止一个下一跳匹配结果时，选择从匹配结果中具有最长网络前缀的路由。
   + **又称最长匹配或最佳匹配。**
   + 将报头中的目的地址与路由地址中的掩码相与，得到的地址与路由地址相同情况下选最长匹配项目转发。

3. **使用二叉线索查找路由表**

   + 唯一前缀指在表中所有的IP地址中，该前缀是唯一的。即最短的区别该网络的前缀。
   + 查找时按照唯一前缀的从左向右顺序进行查找。
   + 为了进一步提高二叉线索的查找速度，广泛应用许多压缩方法，但都值得。

## 4.4 网际控制报文协议 ICMP

+ 位更有效转发IP数据报和提高交付成功机会，在网际层使用了 **网际控制报文协议ICMP（Internet Control Message Protocol）。**
+ 报文格式：<img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200301152340681.png" alt="image-20200301152340681" style="zoom:50%;" />

### 4.4.1 ICMP 报文的种类

+ **ICMP差错报告报文** & **ICMP询问报文**

+ <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200301152618954.png" alt="image-20200301152618954" style="zoom:50%;" />

  + **终点不可达**：路由器或主机不能交付数据报时就像源点发送终点不可达报文。

  + **时间超过**：

    + 路由器收到生存时间为0的数据报时，丢弃该数据报并向源点发送时间超过报文。

    + 终点在预先规定时间内不能收到一个数据报的全部数据报片时，就丢弃收到的数据报片并向源点发送时间超过报文

  + **参数问题**：当路由器或主机收到的数据报首部中又字段的值不正确时，丢弃该数据报并向源点发送参数问题报文。

  + **改变路由（重定向）**：路由器把改变路由保温发送给主机，让主机知道下次应该将数据报发送给另外的路由器。

  + **注意：一些情况下不应发送ICMP差错报告报文。**

    <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200301153523463.png" alt="image-20200301153523463" style="zoom:50%;" />

  + 常用的ICMP询问报文有两种：

    + **回送请求和回答**：ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。
    + **时间戳请求和回答**：ICMP时间戳请求报文是请某台主机或路由器回答当前的日期和时间。在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。时间戳请求与回答可用于时钟同步和时间测量。

### 4.4.2 ICMP的应用举例

+ 一个重要应用就是**分组网间探测PING（Packet InterNet Groper）**，ping不通过运输层的TCP和UDP。
+ 另一个是traceroute(UNIX中)，用于跟踪一个分组从源点到终点的路径，原理是利用ICMP时间超过差错报告报文，不断增加TTL并发出，得到每一跳路由器的时间超过差错报告报文，最终到达目的主机。

## 4.5 互联网的路由选择协议

讨论路由表中的路由是怎样得出的

### 4.5.1 有关路由选择协议的几个基本概念

1. **理想的路由算法**

   + **正确且完整**：一定能到达目的网络和目的主机
   + **计算上应简单**：不增加太多额外开销
   + **适应通信量与网络拓扑的变化**：**自适应性、稳健性**
   + **稳定性**：收敛于可接受解
   + **公平的**：对所有用户平等（除少数高优先级用户）
   + **最佳的**：找出最好的路由，平均时延最小，网络吞吐量最大，即相对某特定要求下得出较为合理的选择

   + **若从路由算法能否随网络通信量或拓扑自适应地进行调整变化来划分**：
     + 静态路由选择策略
     + 动态路由选择测策略

2. **分层次的路由选择协议**

   + 互联网采用的路由选择协议主要是**自适应的（即动态的）、分布式路由选择协议**，原因有：
     + 互联网规模庞大，单个路由器无法全部存储所有网络的到达方式
     + 许多单位不愿外界了解内部网络结构，但依旧希望联网
   + 因此将互联网划分为许多小的**自治系统AS(autonomous system)**
   + 一个AS对其他AS表现出一个单一和一致的路由选择策略
   + 目前一个ISP是一个自治系统，互联网把路由选择协议划分为
     + **内部网关协议 IGP(Interior Gateway Protocol)**：多种协议，如RIP、OSPF等
       + 一个自治系统内部使用路由选择协议，与互联网中的其他自治系统选用什么路由选择协议无关。
       + 这类路由选择协议使用最多，如RIP与OSPF
     + **外部网关协议 EGP(External Gateway Protocol)**：目前使用BGP
       + 自治系统间的协议
       + 使用最多的是BGP 4
     + 自治系统间路由选择也叫**域间路由选择(interdomain routing)**，自治系统内部的路由选择叫做**域内路由选择(intradomain routing)**。
   + EGP在RFC文档中指一个旧协议
   + 较大的自治系统还可以将所有网络再进行一次划分。

### 4.5.2 内部网关协议 RIP

1. 工作原理

   + RIP(Routing Information Protocol)是最先广泛使用的协议，中文路由信息协议
   + **RIP是一种分布式的基于距离向量的路由选择协议**
   + 最大优点——**简单**
   + RIP协议要求网络中每一个路由器维护从它到其他每一个目的网络的距离记录（**得到一组距离，即距离向量**）
   + RIP中的距离：
     + 一个路由器到**直接连接**的网络的距离定义为1
     + 一个路由器到**非直接连接**的网络的距离定义为**所经过路由器数**加1
   + RIP协议的距离也称为**跳数**，好的路由跳数少，看作距离短
   + RIP允许一条路径最多只能包含15个路由器，**距离达16时看作不可达**，由此看出RIP只适用于小型互联网
   + RIP不能在两个网络间使用多条路由，RIP**选择一条最少路由的路由，但不一定是最快，即使有最快，也要选最短**
   + **RIP协议的特点：**
     1. **仅和相邻路由器交换信息**，协议规定不相邻的路由器不交换信息
     2. 交换的内容是 **当前本路由器所知道的全部信息，即当时自己的路由表**——“我到本自治系统中各网络的最短距离
     3. **按固定时间间隔交换路由信息**，当网络拓扑发生变化，路由器也及时向相邻路由器通告拓扑变化后的路由信息
   + **路由器刚开始工作时，路由表是空的**，虽然每个路由器只进行小范围的路由信息交换，但若干次更新后所有路由器最终知道本自治系统中任何一个网络的最短距离和下一跳路由器的地址
   + ”收敛“是RIP协议的一个特征
   + <font color=blue>**RIP的特点！！互相发消息最后大家都知道了自己到各个网络的最短距离！！**</font>

2. **距离向量算法**

   + 对每个相邻路由器发来的RIP报文进行以下步骤：（算法基础为Bellman-Ford算法）

     1. 对地址为X的相邻路由器发来的RIP报文，先修改此报文中的所有项目：把”下一跳“字段中的地址都改为X，并把所有”距离“字段的值加1，即：到目的网络N，距离是d，下一跳路由器是X

     2. 对修改后的RIP报文中的每一个项目，进行以下步骤：

        + 若原来的路由表没有目的网络则添加该项目至路由表

        + 否则

          + 若收到的项目中距离d小于路由表中的距离，则进行更新

          + 否则什么都不做

     3. 若三分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即把距离置为16

     4. 返回

   + **注意：有向大更新的情况，即同一路由器的新路由信息比之前跳数多，可能有某路由器断开情况。**

3. **RIP协议的报文格式**

   + RIP2可以支持**变长子网掩码**和**无分类域间路由选择CIDR**

     <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200303223148848.png" alt="image-20200303223148848" style="zoom:50%;" />

   + 使用UDP端口520

   + 必为0为了对齐

   + **地址族标识符（地址类别）**用来标志所使用的地址协议

   + **路由标记**填入**自治系统号ASN(Autonomous System Number)**

   + 其他看图

   + 一个RIP报文最多可包括25个路由，因而RIP报文最大长度是4+20×25=504字节，超过再用一个RIP报文

   + RIP2还具有简单的鉴别功能

+ RIP存在的问题：**当网络出现故障时，需要较长时间才能将此信息传送到所有的路由器**，但是人家就是有最好的优点——**实现简单、开销较小**

  <img src="C:\Users\Jason Xu\AppData\Roaming\Typora\typora-user-images\image-20200303224235427.png" alt="image-20200303224235427" style="zoom:50%;" />

### 4.5.3 内部网关协议OSPF

1. **OSPF协议的基本特点**
   + **开放最短路径优先OSPF(Open Shortest Path First)**
   
   + 原理简单实现复杂
   
   + **开放**
   
   + **最短路径算法DijkstraSPF**
   
   + 其他路由选择协议其实也是最短路径优先
   
   + 最主要特征：**链路状态协议(Link State Protocol)**
   
   + 与RIP相比OSPF三个要点均不同：
     + 向本AS中所有路由器发送信息，使用洪泛法(flooding)
     + 发送的信息就是与本路由器 **相邻的所有路由器的链路状态**，但这只是路由器所知道的部分信息
       + 即发送的是本路由器都**和哪些路由器相邻**以及**该链路的度量**
       + OSPF使用这个度量表示费用、距离、时延、带宽等
       + 有时称度量为**代价**
     + 只有链路状态发生变化时，才会向所有路由器泛洪
     
   + 由于路由器间频繁交换链路状态信息，因此所有路由器最终能建立一个**链路状态数据库(link-state database)**，是**全网的拓扑结构图**，全网范围内该数据库保持一致，称为**链路状态数据库的同步**
   
   + <font color=blue>RIP是近光灯，OSPF是远光灯</font>
   
   + **OSPF更新过程收敛更快**
   
   + 为使OSPF能用于规模很大的网络，OSPF将一个AS再划分若干个小范围，叫**区域**，划分区域可将链路状态信息的范围局限于一个区域，而非整个AS，减少了整个网络的通信流量
   
   + OSPF使用**层次结构的区域划分**
     + 上层区域叫做**主干区域**
     + **区域边界路由器**用于概括其他区域来的信息
     
   + OSPF不用UDP用IP数据报传送（IP数据报首部协议字段为89），构成的数据报很短，可减少路由信息的通信量。
   
   + OSPF分组使用24字节固定长度首部，分组数据部分可是五种类型分组的一种，各字段含义如下：
     1. 版本
     2. 类型
     3. 分组长度
     4. 路由器标识符
     5. 区域标识符
     6. 检验和
     7. 鉴别类型
     8. 鉴别
     
     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200305230613557.png" alt="image-20200305230613557" style="zoom:50%;" />
     
   + OSPF的其他一些特点
   
     1. OSPF允许**管理源给每条路由指派不同的代价**。
        + 利用不同的代价区分不同业务对时延敏感的程度
     2. 如果到同一个目的网络又多条相同代价的路径，那么可以**将通信量分配给这几条路径**。
        + 服务器负载均衡？
     3. 所有在**OSPF路由器间交换的分组都具有鉴别的功能**
        + 保证了仅在可信赖的路由器之间交换链路状态信息
     4. OSPF**支持可变长度的子网划分和无分类的编址CIDR**
     5. 由于网络中的链路状态可能经常发生变化，OSPF让**每个链路都带上一个32位序号**，序号越大状态越新。
   
2. OSPF的五种分组类型

   1. **问候(Hello)**

      用来发现和维持邻站可达性

   2. **数据库描述符(Database Description)**

      向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息

   3. **链路状态请求(Link State Request)**

      向对方请求发送某些链路状态项目的详细信息

   4. **链路状态更新(Link State Update)**

      洪泛法全网更新链路状态

   5. **链路状态确认(Link State Acknowledgement)**

      对链路更新分组的确认

   + OSPF规定每十秒两相邻路由器就要交换一次问候分组

   + 若40秒对方不理你，你就把他设置成不可达，数据库里删掉，让他再不理你

   + 两个同步的路由器叫做“**完全邻接的(fully adjacent)**“路由器

   + **当一个路由器开始工作只能通过问候分组得知有哪些相邻的路由器在工作，以及将数据发送给相邻路由器的代价，OSPF让每个路由器用数据库描述分组和相邻路由器交换本数据库中已有的链路状态，得到摘要后我这个路由器就知道我不知道哪些路由器的状态了，然后我再给对方发一个”告诉我某某某的状态信息，我要更新一下“对方再发过来特定的几个，就减轻了网络负担。**

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200305235950317.png" alt="image-20200305235950317" style="zoom:50%;" />

   + 网络运行中只要有一个路由器的链路发生变化，该路由器就要使用更新分组，用洪泛法向全网更新状态。<font color=grey>能否多次改变路由器状态进行路由器间的DoS攻击？</font>

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306000245636.png" alt="image-20200306000245636" style="zoom:50%;" />

   + 为保证链路状态数据库与全网的状态保持一致，OSPF规定每隔一段时间要刷新一次数据库中的链路状态
   + 互联网**规模很大**时，**OSPF协议比RIP协议好很多**。而且没有坏消息传得慢的问题
   + 对于多点接入的局域网，OSPF采用指定的路由器的方法减少广播信息量

### 4.5.4 外部网关协议BGP

+ 边界网关协议BGP
+ BGP4经常简写为BGP
+ 不同AS间路由选择不使用RIP或OSPF等内部网关协议的原因是各AS间 **有情感色彩**，关系更加复杂
+ 内部网关协议只考虑如何有效地在自治域内发送接收数据，而AS间的通信需要考虑多方面因素
  1. **互联网规模太大，AS之间路由选择困难**
     + 各AS运行自己的内部路由选择协议，路径度量标准不一，开销评定标准不同，计算出有意义的代价不太可能。
     + 合理的做法是在各AS间交换**可达性**信息，”到达目的网络N可经过AS~1~，AS~2~，……
  2. **自治系统AS之间的路由选择必须考虑有关策略**
     + 由于网络差异较大，最短距离可能并不合适
     + 有的路径代价太高或不安全
     + 政治、安全、经济等方面因素
     + 使用这些策略是为了找出较好路径而非最优路径

+ 边界网关协议BGP采用**路径向量(path vector)路由选择协议**

+ 配置BGP时，每个AS要选择一个路由器作为该AS的**BGP发言人**

+ **BGP发言人往往是BGP边界路由器，但也可以不是边界路由器**

+ 一个BGP发言人与其他AS的BGP发言人要交换路由信息，就要先建立TCP连接（端口179），然后在此连接上交换BGP报文以建立**BGP会话(session)**，交换路由信息，使用TCP连接交换路由信息的两个BGP发言人彼此成为对方的**邻站(neightbour)**或**对等站(peer)**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306004456939.png" alt="image-20200306004456939" style="zoom:40%;" />  ----<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306004602331.png" alt="image-20200306004602331" style="zoom:40%;" />

+ 各AS间建立好连接后构造出各自连通图，为树形结构，不存在回路（向量的体现）

+ BGP协议交换路由新的的节点数量级是自治系统个数的量级，要比自治系统中的网络数少很多

+ 要在许多AS间寻找一条较好路径，就要寻找正确的BGP发言人（或边界路由器）

+ BGP支持**无分类域间路由选择CIDR**，所以BGP路由表包括**目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的自治系统序列**。因此容易避免兜圈子路由。

+ 收到其他BGP发言人的路径通知要检查自己是否在其中，如果在则不采用否则兜圈子

+ BGP刚运行需要交换整个BGP路由表，但之后只需要发生变化时更新有变化部分。

+ RFC4271中规定的BGP-4的四种报文

  1. OPEN（打开）报文

     与相邻BGP发言人建立关系，使通信初始化

  2. UPDATE（更新）报文

     通告某一路由信息，以及列出要撤销的多条路由

  3. KEEPALIVE（保活）报文

     周期性证实邻站连通性

  4. NOTIFICATION（通知）报文

     用来发送检测到的差错

  + 若一开始与邻站商谈时发送的OPEN报文得到对方BGP发言人的KEEPALIVE回应，则邻站关系建立，并且定期发送只有19字节长的KEEPALIVE报文保活，网络开销并不大
  + UPDATE报文是BGP报文的核心内容
    + 一条增加的路由信息
    + 撤销多条路由信息

+ BGP可解决RIP的坏消息传得慢问题，BGP发言人可以通过多个邻站得到路由信息，因此易选出新的路由

+ BGP各报文格式见书P166

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306011238374.png" alt="image-20200306011238374" style="zoom:50%;" />

### 4.5.5 路由器的构成

1. **路由器的结构**

   + 多个输入端口与多个输出端口的专用计算机，任务是转发分组

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306021636571.png" alt="image-20200306021636571" style="zoom:80%;" />

   + 整个路由器结构可划分为两大部分：**路由选择部分**与**分组转发部分**

     + **路由选择部分**

       + 也叫控制部分
       + 核心构件：路由选择处理机，任务是根据所选定的路由选择协议构造出路由表，维护路由表。

     + **分组转发部分**

       + 三部分组成：
         1. **交换结构**
            + 又称为交换组织
            + 作用：根据**转发表(forwarding table)对**分组进行处理
            + 将某输入端口进入的分组从一个合适的输出端口发送出去
         2. **一组输入端口**
         3. **一组输出端口**

       + 转发与路由选择有区别，转发表中包含从要到达的目的网络到输出端口和某些MAC地址信息的映射；路由选择是指由目的IP地址得到下一跳的方向的过程。
       + 讨论路由选择原理时合起来简称路由表

   + 最理想的情况时输入端口的处理速率能够跟上线路把分组传送到路由器的速率，这种速率称为**线速(line speed | wire speed)**，速率约每秒百万分组。

   + 当一个分组正在查转发表，后面又紧跟着在此端口收到另一个分组，则会产生**排队时延**。

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306022820737.png" alt="image-20200306022820737" style="zoom:50%;" />

   + 若分组处理的速率赶不上分组进入队列的速率，则会产生没有存储空间被丢弃的情况

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306022929781.png" alt="image-20200306022929781" style="zoom:50%;" />

2. **交换结构**

   + 交换结构把分组从一个输入端口转移到某个合适的输出端口。

   + 三种常用的交换方法：<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306023135452.png" alt="image-20200306023135452" style="zoom:50%;" />
   + **最早使用CPU作为路由器的路由选择处理机，输入输出端口与I/O设备相同，利用中断机制通知路由选择处理机，然后分组从输入端口复制到存储器中，路由器处理机从分组首部提取目的地址，查找路由表，再将分组复制到合适的输出端口的缓存中**
   + 若存储器的带宽（读或写）为每秒M个分组，那么路由器的交换速率一定小于M/2，因为读写花费时间数量级相同
   + 许多现代路由器通过存储器进行交换
   + 总线结构到达相应端口则发出，不需路由选择处理机的干预
   + **互联网络(interconnection network)**中，若某垂直总线正被其他转发占用，则需要在输入端口排队。

## 4.6 IPv6

+ 仍**支持无连接的传送**，但将协议数据单元PDU称为分组，而非IPv4数据报

+ IPv6引进的主要变化有：

  1. **更大的地址空间**：在可预见的未来不会用完
  2. **扩展的地址层次结构**。由于地址空间大，因此可划分为多个层次，更灵活
  3. **灵活的首部格式**：IPv6与IPv4并不兼容，但提供更多可选扩展首部，提供更多功能，还可提高路由器的处理效率
  4. **改进的选项**：IPv6允许数据报包含选项的控制信息，可包含一些新的选项，但首部长度固定，选项放在首部的可变部分
  5. **允许协议继续扩充**：IPv4就不支持
  6. **支持即插即用**：IPv6不需要DHCP
  7. **支持资源预分配**：IPv6支持实时视像等要求保证一定的带宽和时延的应用
  8. **IPv6首部改为8字节对齐**：原来的IPv4首部是4字节对齐

+ IPv6数据报由两大部分组成

  + **基本首部(base header)**
  + **有效载荷(payload)**
    + 有效载荷也称**净负荷**
    + 有效载荷允许有0个或多个**扩展首部(extension header)**
    + **所有的扩展首部都不属于IPv6数据报首部**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306153537194.png" alt="image-20200306153537194" style="zoom:50%;" />

+ IPv6相较于IPv4对首部中的某些字段进行了如下更改
  + 取消了首部长度字段，因为首部长度固定（40字节）
  + 取消了服务类型字段，因为优先级和流标号字段实现了服务类型字段的功能
  + 取消了总长度字段，改用有效载荷长度字段
  + 取消了标识、标志和片偏移字段，因为这些功能已包含在分片扩展首部中
  + 把TTL字段改称跳数限制字段，作用相同
  + 取消协议字段，改用下一个首部字段
  + 取消了检验和字段，加快路由器处理数据报速度。因为运输层的UDP有错就丢，TCP不对重传，可精简
  + 取消了选项字段而使用扩展首部来实现选项功能
+ 取消不必要的功能后IPv6首部字段数只有8个，但长度由20变为40字节<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306154244030.png" alt="image-20200306154244030" style="zoom:50%;" />
+ 各字段的作用
  1. **版本(version)**
     + 占4位
     + 指明协议版本，IPv6是6
  2. **通信量类(traffic class)**
     + 占8位
     + 区分不同IPv6数据包的类别或优先级
     + 正在实验
  3. **流标号(flow label)**
     + 占20位
     + IPv6提出流的抽象概念，**流指互联网络上从特定源点到特定终点（单播或广播）的一些列数据报（如视频音频传输），而在这个流所经过的路径上的路由器都保证指明的服务质量**
     + 传统的电子邮件或非实时数据流标号没用，把它置0
  4. **有效载荷长度(payload length)**
     + 占16位
     + 指明IPv6数据报基本首部外的字节数
     + 最大值65535字节（64KB）
  5. **下一个首部(next header)**
     + 占8位
     + 相当于IPv4的协议字段或可选字段
     + 当IPv6数据报无扩展首部时，下一个首部字段的作用和IPv4的协议字段一样，指出了基本首部后的数据应该交付IP层上面的哪一个高层协议，例如TCP或UDP
     + 出现扩展首部时，下一个首部字段的值就标识后面第一个扩展首部的类型
  6. **跳数限制(hop limit)**
     + 最大限制为255跳
     + 防止一直存在
  7. **源地址(source address)**
     + 占128位
  8. **目的地址(destination address)**
     + 占128位
+ **关于扩展首部**
  + IPv4需要在每一个路由器都检查所有扩展首部，降低了转发速率
  + IPv6将检查扩展首部的工作只交给首尾的主机处理
  + RFC 2460定义了以下六种扩展首部
    1. 逐跳选项
    2. 路由选择
    3. 分片
    4. 鉴别
    5. 封装安全有效载荷
    6. 目的站选项
  + 每个扩展首部由若干字段组成，长度不同，**但所有扩展首部的第一个字段都是8位的下一个首部字段**

### 4.6.2 IPv6的地址

+ 一个IPv6数据包的目的地址可以是以下三种基本类型地址之一

  + **单播(unicast)**：传统的点对点通信
  + **多播(multicast)**：多播是一点对多点的通信，数据报发送到一组计算机中的每一个。IPv6没有采用广播的术语，只是将广播看作多播的特例
  + **任播(anycast)**：任播的终点是一组计算机，但数据报只交付其中一个，通常是最近的那个

+ IPv6把实现IPv6的主机和路由器均称**结点**。

+ 一个节点可能有多个与链路相连的接口

+ 128位的IPv6地址使用**冒号十六进制记法(colon hexadecimal notation)**，简写(colon hex)

+ **零压缩(zero compression)**：一连串连续的零可以为一对冒号所取代

  FF05:0:0:0:0:0:0:B3 可压缩为 FF05::B3

+ **注意：在任一地址中零压缩只能使用一次，**<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306162608944.png" alt="image-20200306162608944" style="zoom:50%;" />

+ 后面的网络前缀指二进制数的位数而非十六进制

+ 零只能压缩，不能省略

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306162930179.png" alt="image-20200306162930179" style="zoom:50%;" />

+ **未指明地址**：16字节全0，缩写为::，只用于还未配置到标准IP地址时的源地址使用，不可作为目的地址

+ **环回地址**：IPv6的环回地址是::1

+ **多播地址**：功能与IPv4的一样，这类地址占IPv6地址总数的1/256

+ **本地链路单播地址(Link-Local Unicast Address)**：有些单位的网络使用TCP/IP协议，但并没有连接到互联网上，可使用此类地址进行局域网内通信。

+ **全球单播地址**：使用最多的部分，分段结构类似IPv4的思想，更加灵活，都可使用。

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306163628221.png" alt="image-20200306163628221" style="zoom:50%;" />

### 4.6.3 从IPv4向IPv6过渡

+ 只能采取逐步演进的方法过渡，同时需要新安装的IPv6系统能向后兼容，即IPv6系统必须能够接收和转发IPv4分组，并且能够为IPv4分组选择路由

+ **两种过渡策略**

  1. **双协议栈**

     + 双协议主机在和IPv6主机通信时采用IPv6地址，而和IPv4主机通信则采用IPv4地址

     + 使用域名系统DNS知道是IPv4还是IPv6地址

     + IPv6->IPv4->IPv4->IPv6时IPv6首部中的某些字段无法恢复

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306164310835.png" alt="image-20200306164310835" style="zoom:50%;" />

  2. **隧道技术**

     + IPv6数据报要进入IPv4网络时，把IPv6数据报封装为IPv4数据报，使得整个IPv6数据报变为IPv4的数据部分

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306164522914.png" alt="image-20200306164522914" style="zoom:50%;" />

### 4.6.4 ICMPv6

+ IPv6也不保证可靠交付，因此需要ICMP协议来反馈一些差错信息

+ 新版本为ICMPv6，比ICMPv4复杂得多

+ **地址解析协议ARP和网际组管理协议IGMP的功能已被合并至ICMPv6**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306164846490.png" alt="image-20200306164846490" style="zoom:50%;" />

+ ICMPv6面向报文，利用报文来报告差错，

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306165340676.png" alt="image-20200306165340676" style="zoom:65%;" />

## 4.7 IP多播

### 4.7.1 IP多播的基本概念

+ **多播减轻了多次单播的需求和网络资源耗费的问题**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306165739895.png" alt="image-20200306165739895" style="zoom:35%;" /><img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306165824099.png" alt="image-20200306165824099" style="zoom:35%;" />

+ 多播地址只用于目的地址，不用于源地址

### 4.7.2 在局域网上进行硬件多播

+ IP地址与硬件地址的映射不是唯一的，收到多播数据的主机还要在IP层利用软件进行过滤，把不是主机接收的数据报丢弃

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306171109986.png" alt="image-20200306171109986" style="zoom:50%;" />

### 4.7.3 网际组管理协议IGMP和多播路由选择协议

1. **IP多播需要两种协议**

   + 当发出组播时为知道多播组的成员信息就要利用一个协议——**网际组管理协议IGMP(Internet Group Management Protocol)**<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306171543273.png" alt="image-20200306171543273" style="zoom:60%;" />

   + 该图强调了ICMP的**本地使用范围**

   + IGMP不知道IP多播组包含的成员数，也不知道这些成员分布在哪些网络上，IGMP是让连接在本地局域网上的多播路由器知道本局域网上是否有主机（严格讲是主机上的某进程）参加或退出某个多播组

   + 与其他多播路由器协同工作以便把多播数据报用最小代价传送还需要使用**多播路由选择协议**

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200306172228458.png" alt="image-20200306172228458" style="zoom:50%;" />

   + **多播路由选择协议比单播路由选择协议复杂得多**
     + 多播转发必须**动态适应**多播组成员的变化（网络拓扑并未改变）
     + 多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的目的地址，而是还要考虑这个多播数据报从什么地方来和要到什么地方去
     + 多播数据报可以由没有加入多播组的主机发出，也可以通过没有组成员接入的网络
   
2. **网际组管理协议IGMP**

   + 和网际控制报文协议ICMP相似，IGMP采用IP报文传递其报文，但他也向IP提供服务，我们不把IGMP看成是一个单独的协议，而是属于整个网际协议IP的一个组成部分。
   + 概念上讲，IGMP的工作分为两个部分：
     1. 第一阶段：**处理新加入的主机或多播组。**当某台主机加入新的多播组时，该主机应向多播组的多播地址发送一个IGMP报文，声明自己要称为改组的成员。本地多播路由器收到IGMP报文后，还要利用多播路由选择协议把这种组成员关系转发给互联网上的其他多播路由器。
     2. 第二阶段：**组成员关系是动态的。**本地多播路由器周期性地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。只要有一台主机对某个组响应，那么多播路由器就认为这个组是活跃的。但一个组在经过几次探询后仍然没有一个主机相应，多播路由器就认为本网络上的主机已经都离开了这个组，因此也就不在把这个组的成员关系转发给其他的多播路由器。

   + IGMP设计仔细，**避免了增大网络开销**。IGMP采用的一些具体措施有：
     1. 在主机与多播路由器之间的所有通信都是使用IP多播
     2. 多播路由器在探询组成员关系时，只需对所有组发送一个请求信息的询问报文而非一个一个发
     3. 当同一个网络上链接有几个多播路由器时，他们能够迅速有效地选择其中一个来探询主机的成员关系
     4. 在IGMP地询问报文中有一个数值N，它指明一个最长响应时间
     5. 同一组内地的每一台主机都要监听响应只要有本组的其他主机发送了响应，自己就可以不再发送响应了*（他怎么知道别人发过了？）*
   + 多播路由器不需详细记录组成员关系的准确记录，只需知道是否在局域网上至少有一台主机在多播组中，因为在局域网内的组成员转发数据报使用的是硬件多播。
   + 如果一台主机上的多个进程加入了某个多播组，那么他只接收一个副本，并在本地复制，向每个需要的进程发送副本。
   + 多播数据报的发送者和接收者都不知道多播组的成员有多少，以及这些成员哪些是主机。只知道：这有个组，组里还有人，发给这个组就行了。

3. **多播路由选择协议**

   + 尚未标准化
   + 多播路由选择的根本就是要找出以源主机位根节点的**多播转发树**。在多播转发数上，每一个多播路由器向树的叶节点方向转发收到的多播数据报。
   + 对于不同的多播组对应于不同的多播转发树。同一个多播组，对不同的源点也会有不同的多播转发树。
   
   1. **洪泛与剪除**
   
      + 适用于较小的多播组，且所有组成员接入的局域网也是邻接的
   
      + 为避免兜圈子，采用了**反向路径广播RPB(Reverse Path Broadcasting)**的策略
   
        + 要点是：每个路由器在收到一个多播数据报时，先检查数据报是否是从源点经最短路径传送来的，这种检查很容易，只要从本路由器寻找到源点的最短路径上的第一个路由器是否就是刚才把多播数据报送来的路由器。若是，就向所有其他方向转发刚才收到的多播数据报，否则就丢弃而不转发。最短有重复则选IP最小的接收。
   
          <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307174804604.png" alt="image-20200307174804604" style="zoom:50%;" />
   
      + 如果在多播转发树上的某个路由器发现他的下游树枝已经没有该多播组的成员，就把他和下游树枝一起**剪除**
   
   2. **隧道技术(tunneling)**
   
      + 隧道技术用于多播组的位置在地理上很分散的情况
   
      + 用于多播路由器间由不支持多播的路由器连通的情况
   
      + 方案是：源多播路由器对多播数据报再次封装，加上普通数据包的首部，使之成为向单一目的站发送的**单播(unicast)**数据报，然后通过**隧道(tunnel)**从源到目的多播路由器
   
        <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307175848942.png" alt="image-20200307175848942" style="zoom:50%;" />
   
   3. **基于核心发现的技术**
   
      + 对于每一个多播组G指定一个**核心路由器**，给出他的单播地址，核心路由器再构建出之前的转发树
      + 目前没有全网范围使用的多播路由选择协议
      + 建议使用的路由选择协议
        + **距离向量多播路由选择协议DVMRP(Distance Vector Multicast Routing Protocol)**是互联网上使用的第一个多播路由选择协议
        + **基于核心的转发树CBT(Core Based Tree)**，使用核心路由器作为转发树的根节点。一个大的AS可划分为几个区域，每个区域选择一个核心路由器
        + **开发最短通路优先的多播扩展MOSPF(Multicast extensions to OSPF)**使用多播链路状态路由选择创建出基于源点的多播转发树
        + **协议无关多播——稀疏方式 PIM-SM（Protocol Independent Multicast-Sparse Mode)**还是构成多播转发树，采用单播数据报来和远程路由器联系，并不特定单播数据报方式，此协议适用于组成员非常分散的情况
        + **协议无关多播——密集方式 PIM-DM(Protocol Independent Multicast-Dense Mode)**此协议适用于组成员分布非常集中的情况，例如组成员都在一个机构内。泛洪方式转发数据报
      + 总体看来，密集适用泛洪，稀疏使用核心建树

## 4.8 虚拟专用网VPN和网络地址转换NAT

### 4.8.1 虚拟专用网VPN

+ 仅在机构内部使用的计算机就可以由本机构自行分配IP地址。

+ 让这些计算机使用仅在本机后有效的IP地址（**本地地址**）而不需向互联网管理机构申请唯一IP，节约了IP资源

+ **一些专用地址(private address)**，只用于机构内部通信，不用于和互联网上的主机通信。

+ **互联网中的所有路由器对目的地址是专用地址的数据报一律不进行转发**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307205944899.png" alt="image-20200307205944899" style="zoom:50%;" />

+ 采用上述专用IP地址的互联网络称为**专用互联网**或**本地互联网**，更简单些叫做**专用网**。
+ 专用IP地址也可叫**可重用地址(reusable address)**
+ 当机构的许多部门分布广泛，一般使用两种方法接入公司内网
  1. 租用电信公司的通信线路为本机构使用，价格昂贵
  2. 利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为**虚拟专用网VPN(Virtual Private Network)**

+ VPN需要加密通信

+ 一个机构要构建自己的VPN就必须为它的每一个场所购买专门的硬件和软件并进行配置，使每一个场所的VPN系统都知道其他场所的地址

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307212715679.png" alt="image-20200307212715679" style="zoom:50%;" />

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307212800090.png" alt="image-20200307212800090" style="zoom:50%;" />

+ 在每个场所A或B内部的通信量都不经过互联网
+ 当路由器发现有报文必须通过互联网才能到局域网内的情况，则先将其加密，重新加上数据报首部，封装成为在互联网上发送的外部数据报
+ 由场所A和B的内部网络所构成的虚拟专用网VPN又称为**内联网(internet 或 intranet VPN)**，表示场所A和B都属于同一个机构
+ 又是一个VPN需要有某些**外部机构**（如合作伙伴）参加进来，这样的VPN就称为**外联网(extranet VPN)**
+ 还有一种**远程接入VPN(remote access VPN)**满足临时出差的需求

### 4.8.2 网络地址转换NAT

+ 需要在专用网连接到互联网上的路由器上安装NAT软件，装有NAT软件的路由器叫做NAT路由器

+ 至少有一个有效的外部全球IP地址，当使用本地地址的主机和外界通信时，要在NAT路由器上将本地地址转换为全球IP地址才能和互联网连接

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307221114267.png" alt="image-20200307221114267" style="zoom:50%;" />

+ NAT路由器有多少个全球IP地址就可以同时有多少台主机接入互联网

+ 通过NAT路由器的通信必须由专用网内的主机发起，外部发起并不知道内部的信息

+ 普通NAT：

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307223031072.png" alt="image-20200307223031072" style="zoom:50%;" />

+ 使用端口号的NAT也叫做**网络地址于端口号转换 NAPT(Network Address and Port Translation)**，而不使用端口号的NAT就叫做传统的NAT

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307223107788.png" alt="image-20200307223107788" style="zoom:50%;" />

+ 有批评NAPT的声音指出它并未严格按照层次关系，但其已成为重要构件。

## 4.9 多协议标记变换MPLS

+ **MPLS (MultiProtocol Label Switching)**
+ 多协议表示在MPLS的上层可以采用多种协议
+ MPLS利用面向连接技术，使每个分组携带一个叫做**标记(label)**的小整数，当分组到达交换机时，交换机读取分组的标记，并用标记值检索分组转发表，这样就比查找路由表来转发分组要快得多
+ 人们经常把MPLS与**异步传递方式ATM (Asynchronous Transfer Mode)**联系起来，仅因为都采用面向连接的工作方式
+ MPLS具有三方面特点：
  1. 支持面向连接的服务质量
  2. 支持流量工程，平衡网络负载
  3. 有效地支持虚拟专用网VPN

### 4.9.1 MPLS工作原理

1. **基本工作过程**

   + MPLS的重要特点就是给每个IP数据报打上固定长度的标记，他自己就好记了，**然后对打上标记的IP数据报用硬件进行转发**，大大加快IP数据报转发过程

   + 硬件技术对打上标记的IP数据报进行转发就称为**标记交换**。“交换”从侧面表明不上升至第三层网络层进行查找转发表，**根据标记在第二层（链路层）用硬件进行转发**。

   + MPLS使用多层链路协议，如PPP、以太网、ATM、帧中继等

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200307225245111.png" alt="image-20200307225245111" style="zoom:50%;" />

   + MPLS域(MPLS domain)指该域中有许多彼此相邻的路由器且这些路由器支持MPLS技术，它们称为**标记交换路由器LSR (Label Switching Router)**，同时具有标记交换和路由选择的功能
   
   + 标记交换加快转发速度，有了路由选择功能才能构造转发表
   
   + MPLS基本工作过程：
     1. **自动寻路阶段：**
        + 即 **标记交换路径LSP (Label Switched Path)**
        + MPLS域中各LSR使用专门的**标记分配协议LDP(Label Distribution Protocol)**交换报文，并找出和特定标记相对应的路径。此过程与路由表构造过程类似
        + 注意MPLS面向连接，第一个LSR就根据初始标记确定整个标记的交换路径，相当于一条虚连接
     2. **起名字阶段**：
        + 当一个IP数据报进入MPLS域时，MPLS入口节点(ingress node)就给他打一个标签，实际是插入一个MPLS首部，并按转发表转发给下一个LSR
        + 之后的所有LSR都按照标记进行转发
        + 给IP数据报打标记的过程叫做**分类(classification)**
        + 严格的**第三层（网络层）分类**只是用了IP首部中的字段，如源IP地址与目的IP地址等；大多数运营商实现了**第四层（运输层）分类**（除IP外还检查TCP与UDP首部中的协议端口号）；有的运营商则实现了**第五层（应用层）分类**（更进一步查看数据报内部并考虑有效载荷）
     3. **给下一个路由器传名字**：
        + 因为互联网的规模，全网全局统一标记很困难，只有相邻路由器间标记才有效，因此LSR要收到标记数据报后更换为它与下一跳的标记，即将**入标记**更换为**出标记**，称为**标记对换(label swapping)**。
        + 感觉有点像端口转发的思想
     4. **离开MPLS域阶段**：
        + 当IP数据报离开MPLS域时，MPLS**出口结点(egress node)**就把MPLS的标记去除，把IP数据报交付非MPLS的主机或路由器，之后进行普通转发
     
   + 上述由入口LSR确定进入MPLS域以后的转发路径称为**显式路由选择(explicit routing)**，与逐跳路由选择区别很大
   
2. **转发等价类FEC**

   + **FEC(Forwarding Equivalence Class)**

   + **意义：按照同样方式对待的IP数据报的集合**

     + 表示从同样接口转发到同样的下一跳地址

   + FEC例子：

     1. 目的IP地址与某一个特定的IP地址的前缀匹配的IP数据报
     2. 所有源地址与目的地址都相同的IP数据报
     3. 具有某种服务质量需求的IP数据报

   + 可以利用FEC来负载平衡

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308133829698.png" alt="image-20200308133829698" style="zoom:50%;" />

### 4.9.2 MPLS首部的位置与格式

+ MPLS首部在第二层和第三层之间，位于IP数据报外以太帧之内
+ MPLS首部包括四个字段：
  1. 标记值
     + 占20位
  2. 试验
     + 占3位
     + 保留用于试验
  3. 栈S
     + 占1位
     + 有标记栈时使用
  4. 生存时间TTL
     + 占8位
     + 防止MPLS**在MPLS域内**兜圈子

# Chapter 5 运输层

+ **重要内容**
  1. 运输层为相互通信的应用进程提供逻辑通信
  2. 端口与套接字
  3. 无连接UDP的特点
  4. 面向无连接的TCP的特点
  5. 在不可靠网络上实现可靠传输的工作原理，停止等待协议和ARQ协议
  6. TCP的滑动窗口、流量控制、拥塞控制和连接管理

## 5.1 运输层协议概述

### 5.1.1 进程之间的通信

+ **运输层向他上面的应用层提供通信服务**，是面向通信的最高层，面向用户功能中的最低层

+ 网络核心部分中的路由器在转发分组时都只用到下三层的功能

+ IP层来说，通信两端是两台主机，但真正通信的是**两台主机内的两个进程**

+ **端到端的通信是应用进程之间的通信**

+ 运输层的一个重要功能是：**复用(multiplexing)和分用(demultiplexing)**，指两台主机间可有多个进程同时相互交换信息

+ **运输层提供应用进程间的逻辑通信**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308135947003.png" alt="image-20200308135947003" style="zoom:50%;" />

+ ”逻辑通信“的意思是：从应用层来看，只要把应用层报文交给下面的运输层，运输层就可以把报文传送到对方的运输层，看起来是水平传送的，意思也就是领导才不管你怎么干的，你能把消息送到就行，送不到你就完蛋了

+ **网络层为主机间提供逻辑通信，而运输层为应用进程间提供端到端的逻辑通信**

+ 运输层还要对收到的报文进行**差错检测**

+ 根据不同的需求，运输层需要两种不同的协议——

  + **面向连接的TCP协议**
  + **无连接的UDP协议**

+ **运输层向高层用户屏蔽了下面网络核心的细节**，使得应用进程只是感觉在通过一条端到端的逻辑通信信道平行传输数据

  + 当运输层**采用面向连接的TCP协议时，尽管下面的网络是不可靠的（只提供尽最大努力交付），但相当于一条全双工的可靠信道**
  + 当运输层**采用无连接的UDP协议时，这种逻辑通信信道依旧是一条不可靠信道**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308140834100.png" alt="image-20200308140834100" style="zoom:50%;" />

### 5.1.2 运输层的两个主要协议

+ TCP/IP运输层的两个主要协议都是互联网的正式标准，即：

  + **用户数据报协议 UDP (User Datagram Protocol) [RFC 768]**
  + **传输控制协议 TCP (Transmission Control Protocol) [RFC 793]**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308141204056.png" alt="image-20200308141204056" style="zoom:50%;" />

+ 两个对等运输实体在通信时传送的数据单位叫做**运输协议数据单元 TPDU (Transport Protocol Data Unit)**

+ 在TCP/IP体系中，分别称为**TCP报文段(segment)**或**UDP用户数据报**

+ **UDP传送数据前不需建立连接**

+ **UDP不提供可靠交付，但某些情况下最有效**

+ TCP提供面向连接的服务。传送前建立，传送结束释放。

+ TCP不提供多播或广播服务

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\0074F06A986A889E67F29BA37451F213.jpg" alt="img" style="zoom:40%;" />

### 5.1.3 运输层的端口

+ 不同操作系统下的进程号格式等不同，所以在运输层使用**协议端口号(protocol port number)**来进行进程间的数据交付

+ 虽然通信的终点是应用进程，但只要把所传送的报文交到目的主机的某个合适的端口，剩下的交付目的进程的工作就由TCP与UDP完成

+ **这里的协议栈层间的抽象的协议端口是软件端口，与路由器的硬件端口概念不同**

+ 硬件端口是**不同硬件设备**进行交互的接口，软件端口是**应用层各种协议进程与运输实体进行层间交互的一种地址**

+ UDP与TCP首部中都包含**源端口**与**目的端口**

+ TCP/IP的运输层用一个16位端口号来标志一个端口，**端口号只具有本地意义**，只为了标明**本计算机内的某进程在和运输层交互时的层间接口**，在互联网中的不同计算机间，相同端口号并不意味着相同进程

+ 两个计算机要通信不止要知道IP地址，还要知道对方的端口号

+ 互联网上的计算机通信采用C/S方式，客户发起通信请求时必须先知道对方服务器的IP地址与端口号。listening at....

+ 运输层端口号分为两大类：

  1. **服务器端使用的端口号**

     1. [**熟知端口号(well-known port number)**](https://www.iana.org)或**系统端口号**

        + 数值为0~1023

        <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308143541958.png" alt="image-20200308143541958" style="zoom:50%;" />

     2. **登记端口号**
        + 数值为1024~49151
        + 为其他应用程序使用，使用这类端口需要登记，防止重复

  2. **客户端使用的端口号**

     + 数值为49152~65535
     + 仅在客户进程运行时才动态选择，因此也叫**短暂端口号**

## 5.2 用户数据报协议UDP

### 5.2.1 UDP概述

+ UDP在IP数据报服务上增加了复用和分用功能以及差错检测的功能

+ UDP主要的特点有：

  1. **无连接**

     + 减少了开销和发送数据之前的时延

  2. **尽最大努力交付**

     + 不保证可靠交付
     + 主机不需维持复杂连接状态表

  3. **面向报文**

     + 发送方的UDP对应用程序脚下拉的报文，在添加首部后向下交付IP层。

     + UDP一次交付一个完整的报文

     + 应用程序必须选择合适大小的报文，若太长，UDP交给IP层后IP层还要分片，降低效率；若太短，IP数据报首部相对长度太大，降低IP层效率

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308145736226.png" alt="image-20200308145736226" style="zoom:50%;" />

  4. **没有拥塞控制**

     + 适合源主机不断发送的情况，不会降低源主机的发送速率

  5. **支持一对一、一对多、多对一、多对多**

  6. **首部开销小**

     + 只有8个字节

+ 不使用拥塞控制可能会在大量源主机同时发送报文时造成拥塞，导致大家都不能服务，后果更严重

+ 一些UDP实时应用可在不影响应用实时性的前提下增加一些提高可靠性的措施，如采用前向纠错或重传已丢失报文来减少数据丢失

### 5.3.3 UDP的首部格式

+ UDP包含两个字段：数据字段与首部字段

+ 首部字段只有8字节，四个字段，**每个字段长度都是两个字节**：

  1. **源端口**
     + 方便对方回信，不需要时可设0
  2. **目的端口**
     + 终点交付报文时必须使用
  3. **长度**
     + UDP用户数据报长度，最小8，仅含首部情况
  4. **检验和**
     + 检测数据报是否传输有错，有错就丢弃

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308150429504.png" alt="image-20200308150429504" style="zoom:50%;" />

+ 运输层从IP层收到数据报时就根据目的端口把UDP数据报通过相应端口上交对应应用进程

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200308150611663.png" alt="image-20200308150611663" style="zoom:50%;" />

+ 如果端口错误则丢弃并由网际控制报文协议ICMP发送”**端口不可达**“给发送方
+ 虽然UDP用到了端口号，但由于UDP通信是无连接的，所以不需要使用套接字建立连接
+ （TCP间的通信必须要在两个套接字之间建立连接）
+ UDP用户数据报中检验和的计算方法有些特殊，计算检验和时要在UDP用户数据报前增加12个字节的伪首部，只用于检验，不向下传也不向上递交
+ **UDP检验和是把首部和数据部分一起检验**
+ 检验方法与IP数据报首部检验和方法类似，发送方检验和位置填0，接收方反码相加，全1则正确，错误则丢弃

## 5.3 传输控制协议TCP概述

### 5.3.1 TCP最主要的特点

1. **面向连接的传输层协议**，使用TCP必须先建立连接，传输后必须释放已建立的TCP连接

2. 每一条TCP都只能有两个**端点(endpoint)**，每条TCP连接**只能是点对点的**

3. **TCP提供可靠交付服务**，通过TCP连接传送的数据，无差错、不丢失、不重复、按序到达

4. TCP提供**全双工通信**，TCP有缓冲区，发送或接收时都先放在缓冲区，方便的时候再传输

5. **面向字节流**。

   + 流指的是流入到进程或从进程流出的字节序列。

   + TCP把应用程序交下来的数据仅仅看成是一连串的**无结构字节流**。

   + TCP不保证接收方应用程序与发送方应用程序交流的数据块有对应大小关系。但接收方收到的字节流必须和发送方应用程序发出的字节流完全一样

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309134540165.png" alt="image-20200309134540165" style="zoom:50%;" />

   + TCP连接是一条虚连接，逻辑链接，而非物理连接
   + TCP并不关心进程一次把多长的TCP塞入TCP缓存，而是根据对方给出的窗口值和当前网络拥塞程度来决定一个报文段应该包含多少个字节。而UDP报文长度由应用进程给出。

### 5.3.2 TCP的连接

+ TCP把**连接**作为**最基本的抽象**

+ TCP的许多特性都基于连接的基本特性

+ TCP连接的两个端点是**套接字(socket)或插口**

+ 端口号**拼接到(concatenated with)**IP地址就构成了套接字

  <center>套接字 socket = (IP 地址 : 端口号)</center>

+ **每条TCP连接唯一被通信两端的两个端点，即两个套接字所确定：**

  <center>TCP连接 ::= {socket~1~, socket~2~} = {(IP~1~: port~1~), (IP~2~: port~2~)}</center>

+ 同一IP可有多个不同的TCP连接，一个端口也可以出现在多个不同的TCP连接中

+ socket有很多含义，不搞混的最好办法就是不记其他的含义

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309140753102.png" alt="image-20200309140753102" style="zoom:25%;" />

## 5.4 可靠传输的工作原理

+ 讲一讲怎样能通过不可靠的员工干成可靠的事业
+ 理想的传输条件有以下两特点：
  + 传输信道不产生差错
  + 不管发送方以多快的速度发送数据，接收方总来得及处理收到的数据

### 5.4.1 停止等待协议

+ 停止等待就是发送完一个分组就停止发送，等待对方确认，收到确认后再发送下一个分组

1. **无差错情况**

   <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309145820516.png" alt="image-20200309145820516" style="zoom:50%;" />

2. **出现差错**

   <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309145909173.png" alt="image-20200309145909173" style="zoom:50%;" />

   + A只要发送完过一段时间没收到确认，则**超时重传**，每发完一个分组就设置一个**超时计时器**。
   + **注意三点：**
     1. A发完一个分组后必须**暂时保留已发送的分组的副本**，收到相应的分组确认后才能清除暂时保留的副本
     2. 分组和确认分组都必须进行**编号**
     3. **超时计时器设置的重传时间应比数据在分组传输的平均往返时间更长一点**
        + 重传时间的设定受性能、资源、经过的网络、时延大小、拥塞情况等多方面因素制约

3. **确认丢失和确认迟到**

   <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309150632027.png" alt="image-20200309150632027" style="zoom:50%;" />

   + 当B的确认丢失，A重传一次，B采取：
     1. **丢弃重复分组M1**，不向上层交付
     2. **向A发送确认**
   + 当B的确认迟到，A还是重传，B采取：
     + **丢弃重复分组M1**，不向上层交付
   + 使用这种确认与重传机制可在不可靠的传输网络上实现可靠通信
   + 上述可靠传输协议常称为**自动重传请求ARQ(Automatic Repeat reQuest)

4. **信道利用率**

   <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309151317326.png" alt="image-20200309151317326" style="zoom:50%;" />

   + T~D~是发送分组所需时间，等于分组长度除以数据率

   + 信道利用率低，一发一报太慢了，那么采用**流水线传输**

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309151717691.png" alt="image-20200309151717691" style="zoom:50%;" />

   + 使用**连续ARQ协议**和**滑动窗口协议**

### 5.4.2 连续ARQ协议

+ 滑动窗口协议虽然复杂，但是是TCP协议的精髓所在

+ <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309152012032.png" alt="image-20200309152012032" style="zoom:50%;" />
  + 图b表示发送方收到了对第1个分组的确认，向前移动1个分组位置，若已经发送了前5个分组，那么可以发送窗口内的第6个分组了
  + 接收方一般采用**累计确认**的方式，接收方在收到几个分组后，**对按序到达的最后一个分组发送确认**，表示此分组之前的所有分组都已经正确收到了
  + **优点：易实现，即使确认丢失也不必重传**
  + **缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息**

## 5.5 TCP报文段的首部格式

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200309222952353.png" alt="image-20200309222952353" style="zoom:50%;" />

各字段意义：

1. **源端口**和**目的端口**
   + 各占2个字节
   + TCP的分用功能也是通过端口实现的
2. **序号**
   + 占4个字节
   + 序号范围是[0, 2^32^-1]，共4294967296个序号
   + TCP是面向字节流的，TCP连接中传送的字节流中每一个字节都按顺序编号
   + 首部中的序号字段值则指的是**本报文段**所发送的数据的第一个字节的序号
   + 也叫做“**报文段序号**”
3. **确认号**
   + 占4个字节
   + **期望收到对方下一个报文段的第一个数据字节的序号**
     + 若确认号=N，到序号N-1为止的所有数据都以正确收到
4. **数据偏移**
   + 占4位
   + 单位是32位字
   +  指出TCP报文段的数据起始处距离TCP报文段的起始处有多远
   + 字段实际上指出TCP报文段的首部长度
5. **保留**
   + 占6位
   + 有6个控制位，用来说明本报文段性质
6. **紧急URG(URGent)**
   + 当URG=1时，表明紧急指针字段有效，告诉系统此报文段中有紧急数据，应该尽快传送，（相当于高优先级数据）
     + 当URG置1时，发送应用进程就告诉发送方的TCP有紧急数据要传送，于是发送方TCP就把紧急数据插入到本报文段数据的最前面，而在紧急数据后面的数据仍是普通数据。这时与**紧急指针(Urgent Pointer**字段配合使用
7. **确认ACK(ACKnowledgement)**
   + 仅当ACK=1时确认号字段才有效
   + 当ACK=0时，确认号无效
   + **TCP规定建立连接后所有传送的报文都置ACK为1**
8. **推送PSH(PuSH)**
   + 希望能立即收到对方响应
   + 发送方TCP置PSH为1，立即创建一个报文段发送出去
   + 接收方TCP收到PSH=1报文段，**尽快**将此报文向上**推给**应用进程而**不等缓存装满再交付**
9. **复位RST(ReSeT)**
   + 当RST=1，表明出现严重差错要释放连接，再重新建立运输连接
   + RST置1还用来拒绝非法报文或拒绝打开一个链接
   + 重建位或重置位
10. **同步SYN(SYNchronization)**
    + 在**连接建立时**用来同步序号
    + SYN=1而ACK=0时，表明是一个连接请求报文段
11. **终止FIN(FINis)**
    + 用来释放一个连接
    + 当FIN=1，表明此报文段的发送方数据已发送完毕，要求释放运输连接
12. **窗口**
    + 占2字节
    + 窗口值是[0,2^16^-1]
    + 窗口指发送本报文段的一方的**接收窗口**
    + 窗口值告诉对方从本报文段首部中的确认号算起，接收方目前允许对方发送的数据量
    + **窗口值作为接收方让发送方设置其发送窗口的依据**
    + 经常动态变化
13. **检验和**
    + 占2字节
    + 检验和字段检验的范围包括**首部和数据**两部分
    + TCP协议号为6
14. **紧急指针**
    + 占2字节
    + 紧急指针仅在URG=1时才有意义，指出本报文段中的紧急数据的字节数（紧急数据结束后就是普通数据）
    + 指出了紧急数据的末尾在报文段的位置
    + 窗口为0时也可以发送紧急数据
15. **选项**
    + 长度可变，最长达40字节
    + 无选项时TCP首部长度是20字节
    + 最后填充字段为凑齐TCP首部至4字节整数倍

+ 最初只规定了一种选项——**最大报文段长度MSS(Maximum Segment Size)**

  + MSS指**每一个**TCP报文段中的**数据字段的最大长度**
  + MSS = TCP报文段长度 - 该TCP报文首部长度
  + MSS值可以影响运输层与网络层的效率(TCP层效率与IP层效率)，最好设置得尽量大且在IP层不分片

+ 随互联网发展又添加了**窗口扩大选项**、**时间戳选项**、**选择确认选项**等

+ **窗口扩大选项**

  + 占3字节
  + 一个字节表示**移位值S**，新窗口值为TCP首部中得窗口位数从16增大到(16+S)，允许最大移位值为14
  + 也可在TCP建立连接时协商
  + 当不再需要扩大窗口时可发送S=0的选项使窗口恢复16位

+ **时间戳**

  + 占10字节

  + 最主要的字段是**时间戳值**字段（4字节）和**时间戳回送回答**字段（4字节）

  + 功能：

    + 用来计算RTT往返时间，接收方复制发送方的时间戳字段值至时间戳回送回答字段

    + 用于处理TCP序号超过2^32^的情况，称**防止序号绕回PAWS(Protect Against Wrapped Sequence numbers)**
      + 可用于区分新到的报文段和迟到很久的报文段，防止同序号的混淆

## 5.6 TCP可靠传输的实现

+ 基于**假定数据传输只在一个方向进行**，便于理解，双方向原理相同

### 5.6.1 以字节为单位的滑动窗口

+ TCP的滑动窗口是以字节为单位的

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200311214025144.png" alt="image-20200311214025144" style="zoom:50%;" />

+ 凡是发送方发送后未收到接收方的确认序号，则暂存这组数据，接收方的确认序号之前的报文可以删除

+ 窗口越大可能获得的传输效率越高

+ A的发送窗口一定不能超过B的接收窗口数值

+ 发送方的窗口大小还要收到当时网络拥塞程度的制约

+ 发送窗口的**后沿**有两种情况

  1. **不动**：没收到新的确认
  2. **前移**：收到了新的确认

  + 发送窗口后沿不可能向后移动，因为不能撤销发送报文

+ 发送窗口的**前沿**通常是不断向前移动，但也有可能不动，分别对应：

  1. 没有收到新的确认，对方通知的窗口大小也不变
  2. 收到新的确认但对方通知的窗口缩小了，使得发送窗口前沿正好不动

+ 发送窗口前沿也有可能**向后收缩**——对方通知窗口缩小

  + **但TCP标准强烈不赞成这么做**，因为可能发送方在收到这个通知以前就发送了窗口中的许多数据，再收缩窗口不让发数据就可能产生一些错误

+ <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312000431850.png" alt="image-20200312000431850" style="zoom:50%;" />

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312000403631.png" alt="image-20200312000403631" style="zoom:50%;" />

  + A的发送窗口满，可用窗口减小到0时，必须停止发送

  + 窗口与缓存的关系：

    <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312001810526.png" alt="image-20200312001810526" style="zoom:30%;" /><img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312001810526.png" alt="image-20200312001810526" style="zoom:30%;" />
    1. 缓存空间和序号空间都有限，且都循环使用
    2. 实际上缓存或窗口中的字节数时非常大的

  + **发送缓存用来暂时存放**：

    1. 发送应用程序传送给发送方TCP准备发送的数据
    2. TCP已发送出但尚未收到的确认的数据

    + 发送应用程序必须控制写入缓存的速率，不能太快，否则发送缓存就没有存放数据的空间

  + **接收缓存用来暂时存放**：

    1. 按序到达、尚未被接受应用程序读取的数据
    2. 未按序到达的数据

    + 如果收到的分组被检测出有差错，则丢弃

  + **强调三点：**

    1. 虽然A的发送窗口是根据B的接收窗口设置的，但在同一时刻因为网络传输时间滞后的原因，A的发送窗口并不总是和B的接收窗口一样大，发送方还可根据网络当时的拥塞情况适当减小自己的发送窗口数值
    2. 对于不按序到达的数据应如何处理TCP并未明确规定。TCP通常对不按序到达的数据先临时存放在接收窗口中，等字节流所缺少的字节收到后，再**按序交付上层的应用程序**
    3. TCP要求接收方必须有**累积确认**的功能，这样可以减小传输开销。
       + 接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便**捎带**上
       + 注意：
         1. 接收方不应过分推迟发送确认，否则会导致发送方不必要的重传，TCP规定时间不应超0.5s
         2. 捎带确认并不经常发生，因为大多数应用程序很少同时在两个方向上发送数据

  + **TCP通信是全双工通信，通信中每方都在发送和接收报文段**

### 5.6.2 超时重传时间的选择

+ 重传时间的选择是TCP最复杂问题之一

+ 如果设置超时重传时间太长——引起很多不必要重传，增大网络负荷

+ 如果设置超时重传时间太短——使网络空闲时间增大，降低传输效率

+ TCP采用一种自适应算法，利用**报文段的往返时间RTT**，TCP保留RTT一个**加权平均往返时间RTT~s~**(又称**平滑的往返时间**)，S表示Smoothed。**第一次**测量到RTT样本时，RTT~s~值就取为所测量到的RTT样本值。之后递推：

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312004131035.png" alt="image-20200312004131035" style="zoom:50%;" />

  + 上式 0 ≤ α＜1：
    + 若α很接近0，RTT值更新较慢
    + 若α很接近1，RTT值更新较快
    + 推荐α为1/8，即0.125

+ 超时计时器设置的**超时重传时间RTO(Retransmission Time-Out)**应略大于上述RTT~s~，建议下式计算RTO：

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312004608085.png" alt="image-20200312004608085" style="zoom:50%;" />

  + RTT~D~是RTT的**偏差**的加权平均值，它与RTT~s~和新的RTT样本之差有关。
  + 第一次测量时RTT~D~值取为测量到的RTT样本值的一半。
  + 利用下式计算加权平均的RTT~s~：<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312005011608.png" alt="image-20200312005011608" style="zoom:50%;" />
  + β是小于1的系数，推荐1/4，0.25

+ 正确判断迟到的确认报文对确定加权平均RTT~s~

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312005215003.png" alt="image-20200312005215003" style="zoom:50%;" />

+ **Karn算法：**
  
  + 计算加权平均RTT~S~时，只要报文段重传了，就不采用其往返时间样本。得出的RTT~S~和RTO较准确
+ **修正后的Karn算法：**
  + 报文每重传一次，就把超时重传时间RTO增大一些。
  + 一般取2倍。不再发生报文段重传时，计算超时重传时间

### 5.6.3 选择确认SACK

+ **选择确认(Selective ACK)的工作原理**
  + 利用指针记录断开块的断层边界信息，便于发送方有目的补发
  + 左边界指出字节块的第一个字节序号，右边界减1才是字节块中的最后一个序号
+ TCP首部无字段可提供上述字节块边界信息
+ 建立TCP连接时要在TCP首部选项加上”允许SACK“选项
+ 若使用选择确认，确认号字段用法不变，多加了报告不连续的字节块的边界的内容
+ 首部选项的长度最多40字节，所以选项中最多只能指明4个字节块的边界信息
  + 4个字节块的8个边界，使用32个字节描述
  + 1个字节指明SACK选项
  + 1个字节指明这个选项要占多少字节
+ SACK文档没指明怎样响应SACK，所以大多数实现所有未被确认的数据块

## 5.7 TCP的流量控制

### 5.7.1 利用滑动窗口实现流量控制

+ **流量控制(flow control)**就是让**发送方的发送速率不要太快，要让接收方来得及接收**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312010416054.png" alt="image-20200312010416054" style="zoom:50%;" />

+ **发送方的发送窗口不能超过接收方给出的接收窗口的数值**
+ **TCP窗口单位是字节，不是报文段**
+ ACK——确认位ACK，ack——确认字段的值
+ 使发送方暂停发送的状态将持续到主机B重新发出一个新的窗口值为止
+ 只有在ACK=1时确认号字段才有意义
+ 为防止死锁，TCP为每一个连接设有一个**持续计时器(persistence timer)**。只要TCP一方收到对方的零窗口通知，就启动持续计时器。若持续计时器设置的时间到期，就发送一个零窗口**探测报文段（仅携带1字节数据）**，对方在确认这个探测报文段时给出现在的窗口值，若窗口仍为0则重置持续计时器，若不为零则打破死锁。

### 5.7.2 TCP的传输效率

+ 应用进程把数据传送到TCP发送缓存后，剩下的发送任务就由TCP控制。可用不同的机制来控制TCP报文段发送的时机
  1. 机制一
     + TCP维持一个变量，它等于**最大报文段长度MSS**，只要缓存到达MSS则组装成一个TCP报文段发送出去
  2. 机制二
     + 由发送方的应用程序指明要求发送报文段，即TCP支持的**推送(push)**操作
  3. 机制三
     + 发送方的一个计时器期限到了，这时发送当前缓存数据（长度不超MSS）
+ 线路带宽并不富裕时，1字节花费一大堆报文的效率不高，因此应适当推迟发挥确认报文，并尽量使用捎带确认方法
+ **Nagle算法：**
  + 当发送方收到对第一个数据字符的确认后，再把发送缓存中的所有数据组装成一个报文段发送出去，同时继续对随后到达的数据进行缓存。只有再收到对前一个报文段的确认后才继续发送下一个报文段。
  + 当数据到达较快而网速较慢时，此方法明显减少所用网络带宽
  + 算法还规定，当到达的数据以达到发送窗口大小的一半或已达到报文段的最大长度时，就立即发送一个报文段，这样做可有效提高网络吞吐量
+ **糊涂窗口综合征：**
  + 一次只从接收缓存中读取1个字节（这样就使接收缓存空间仅腾出1个字节），然后向发送方发送确认，并把窗口设置为1个字节（但发送的数据报是40字节长）
  + 解决方法可以是**让接收方等一段时间**，使得或者接收缓存已有足够空间容纳一个最长的报文段，或**等到接收缓存已有一半空闲的空间**，只要出现二者之一，接收方就发出确认报文，并向发送方通知当前的窗口大小。
  + 发送方也不要发送太小的报文段，而是把数据积累成足够大的报文段，或达到接收方缓存的空间的一半大小

## 5.8 TCP的拥塞控制

### 5.8.1 拥塞控制的一般原理

+ 计算机网络中的链路容量（带宽）、交换结点中的缓存和处理机等，都是网络的资源。
+ 在某段时间，若对网络中某资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏。
+ Σ对资源的需求 > 可用资源 就会导致网络拥塞
+ 若网络中有许多资源同时呈现供应不足，网络性能会明显变坏，整个网络的吞吐量将随输入负荷的增大而下降

+ **网络拥塞往往是多方面因素引起的，单方面优化可能会转移瓶颈，甚至造成全局恶化**
  + 缓存空间不足
  + 处理机处理速度太慢
  + 拥塞常常趋于恶化
  + ……
+ **拥塞控制与流量控制**
  + **拥塞控制**：防止过多数据注入网络，这样可使网络中的路由器或链路不致过载
    + **拥塞控制的前提是网络能够承受现有的网络负荷**
    + 拥塞控制是一个**全局性的过程**，涉及有关多方因素
  + **流量控制**：往往是指点对点通信量的控制，是个端到端的问题
    + 流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收
+ 拥塞控制和流量控制之所以会弄混，因为一些拥塞控制算法是向发送端发送控制报文，并告诉发送端，网络已出麻烦，必须放慢发送速率。这点又和流量控制相似
+ 进行拥塞控制需要付出代价
+ <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200312013633493.png" alt="image-20200312013633493" style="zoom:50%;" />
  + 横坐标：**提供的负载(offered load)**
    + 也称**输入负载**或**网络负载**。
  + 纵坐标：**吞吐量(throughput)**
  + 具有理想拥塞控制的网络，在吞吐量饱和之前，网络吞吐量应等于提供的负载，故吞吐量曲线是45°的斜线
  + 当提供的负载超过某一限度时，由于网络资源受限，吞吐量不在增长而保持为水平线，即吞吐量达到饱和
  + 随着提供的负载的增大，网络吞吐量的增长速率逐渐减小，也就是说，再网络吞吐量还未达到饱和时，就已经有一部分的输入分组被丢弃了。
  + 当网络的吞吐量明显小于理想吞吐量时，网络就进入了轻度拥塞的状态。
  + 当提供的负载达到某一数值时，网络的吞吐量反而随提供的负载的增大而下降，**这时网络就进入了拥塞状态。**
  + 当提供的负载继续增大到某一数值时，网络的吞吐量就下降到零，网络已无法工作，**构成死锁。**
  + 寻找拥塞控制的方案无非是寻找使不等式不再成立的条件：
    + 增大网络的某些可用资源
    + 减少一些用户对某些资源的需求
    + 必须考虑到该措施所带来的其他影响
  + 拥塞控制是动态的问题
  + **分组的丢失时网络发生拥塞的征兆，而非原因**，许多情况下甚至是拥塞控制机制本身引起网络性能恶化甚至发生死锁
  + 拥塞控制从大方面看分为**开环控制**和**闭环控制**
    + **开环控制**
      + 设计网络时先将有关发生拥塞的因素考虑周到，力求不产生拥塞。
      + 整个系统运行起来不能中途改正
    + **闭环控制**
      + 基于反馈环路的概念
      + 几种措施：
        1. 检测网络系统以便检测到拥塞在何时、何处发生
        2. 吧拥塞发生的信息传送到可采取行动的地方
        3. 调整网络系统的运行以解决出现的问题
  + 有很多方法可检测网络拥塞，一些指标如下：
    + 由于缺少缓存空间而被丢弃的分组的百分数
    + 平均队列长度
    + 超时重传的分组
    + 平均分组时延
    + 分组时延的标准差
    + 这些指标上升都标志拥塞的增长
  + 一般在检测到拥塞发生时，要将拥塞发生的信息传送到产生分组的源站，**但是通知拥塞发生的分组同样会使网络更加拥塞**
    + 在路由器转发的分组中保留一个比特或字段，用该比特或字段的值表示是否产生拥塞
    + 也可由一些主机或路由器周期性地发出探测分组，询问拥塞是否发生

### 5.8.2 TCP的拥塞控制方法

+ **四种拥塞控制的算法：**
  + **慢开始(slow-start)**
  + **拥塞避免(congestion avoidance)**
  + **快重传(fast retransmit)**
  + **快恢复(fast recovery)**
+ **假定：**
  1. 数据时单方向传送的，对方只传送确认报文
  2. 接收方总是有足够大的缓存空间，因而发送窗口的大小由网络的拥塞程度来决定

1. **满开始和拥塞避免**

   + **又称基于窗口的拥塞控制**

   + 发送方维持一个**拥塞窗口cwnd(congestion window)**的状态变量

     + 拥塞窗口的大小取决于网络的拥塞程度，并且动态变化
     + **发送方让自己的发送窗口等于拥塞窗口**

   + 发送方控制拥塞窗口的原则是：

     + 只要网络没有出现拥塞，拥塞窗口就可以在再大一点点，以便发出更多分组，提高网络利用率
     + 只要网络出现拥塞或有可能出现拥塞，就必须把拥塞窗口减小一些，以减少注入到网络中的分组数，以便缓解网络出现的拥塞

   + 只要发送方没有按时收到应当到达的确认报文，就可猜想网络可能出现了拥塞。

   + **判断网络拥塞的依据就是出现了超时**，因为丢弃分组的概率远小于1%

   + ***慢开始算法：***

     + **由小到大逐渐增大拥塞窗口数值**

     + 旧规定是：刚开始发送报文时，先把初始拥塞窗口cwnd设置为1至2个发送方的最大报文段SMSS(Sender Maximum Segment Size)的数值

     + 新规定是：初始拥塞窗口cwnd设置为不超过2至4个SMSS的数值

       + 若SMSS>2190字节：设置初始拥塞窗口 cwnd = 2 × SMSS 字节，且**不得超过2个报文段**
       + 若SMSS>1095字节：设置初始拥塞窗口 cwnd = 3 × SMSS 字节，且**不得超过3个报文段**
       + 若SMSS≤1095字节：设置初始拥塞窗口 cwnd = 4 × SMSS 字节，且**不得超过4个报文段**

     + 慢开始规定，没收到一个**对新报文段的确认**后，可把拥塞窗口增加最多一个SMSS的数值，即

       <center>拥塞窗口 cwnd 每次的增加量 = min (N,SMSS)</center>

     + N —— 原先未被确认、现在被刚收到的确认报文段所确认的字节数

     + 这样的方法逐步增大发送方的拥塞窗口cwnd，可以使分组注入到网络的速率更加合理

     + 发送方没收到一个对新报文段的确认（不计重传）就使发送方的拥塞窗口+1，**没经过一个传输轮次(transmission round)，拥塞窗口cwnd就加倍**

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313205738107.png" alt="image-20200313205738107" style="zoom:50%;" />

     + 一个传输轮次所经历的时间其实就是往返时间RTT
     + 慢开始的慢并不是指cwnd增长速率慢，而是指在TCP开始发送报文段时先设置cwnd=1，使得发送方在开始时只发送一个报文段，再逐渐增大（**就是在边缘试探是否能发大量报文**）
     + TCP实际运行中，发送方只要收到一个对新报文段的确认，其拥塞窗口cwnd就立即+1，并可以立即发送新的报文段，而不需要等这个轮次中的所有确认都收到后再发送新的报文段

   + 为了防止拥塞窗口cwnd的指数级增长过大引起网络拥塞，还需设置一个**慢开始门限ssthresh**状态变量，用法如下：

     + 当 cwnd < ssthresh时，使用慢开始算法
     + 当 cwnd > ssthresh时，停止使用慢开始算法而改用拥塞避免算法
     + 当 cwnd = ssthresh 时，即可使用慢开始算法，也可使用拥塞避免算法

   + **拥塞避免算法：**

     + 思路：让拥塞窗口cwnd缓慢增大，即没经过一个往返时间RTT就把发送方的拥塞窗口cwnd加1，而不是慢开始阶段那样加倍增长。

     + 在拥塞避免阶段，拥塞窗口cwnd**按现行规律缓慢增长**，比慢开始算法的拥塞窗口增长速率缓慢得多

     + ”拥塞避免“并非完全能够避免了拥塞，它将拥塞窗口控制为按线性规律增长，**使网络比较不容易出现拥塞**

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313210931091.png" alt="image-20200313210931091" style="zoom:50%;" />

     + ssthresh在网络拥塞时调整为 ssthresh = cwnd / 2 = 12，同时设置cwnd = 1，进入慢开始

   + **发送方一连收到三个对同一个报文的重复确认（3-ACK）的情况是个别报文丢失但并未发生网络拥塞，采取*快重传算法*让对方尽早知道发生了个别报文段的丢失。**

     + 快重传算法首先要求接收方不要等待自己发送数据时才进行稍待确认，而是要立即发送确认，及时收到了失序的报文段也要立即发出对已收到的报文段的重复确认
     + 接收方**必须立即发送对丢失报文前一报文的重复确认**，发送方只要一连收到3个重复确认，就知道接收方确实没有收到报文段，应当**立即重传**（快重传），这样不会超时，发送方也就不会认为出现网络拥塞。
     + 快重传可使整个网络吞吐量提高20%

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313212345625.png" alt="image-20200313212345625" style="zoom:50%;" />

     + 发送方知道只是丢失个别报文段时，不启动慢开始，而是执行快恢复算法，发送方调整门限值ssthresh = cwnd / 2 = 8
     + 也有的快恢复实现是把快恢复开始时的拥塞窗口cwnd值再增大一些（增大3个报文段的长度），即等于新的ssthresh+3×MSS，因为网络中不是堆积了分组而是减少了3个分组。因此可适当把拥塞窗口扩大些

   + 拥塞避免阶段，拥塞窗口是按照线性规律增大的，常称为**加法增大AI(Additive Increase)**，一旦出现超时或3个重复的确认，就要把门限值设置为当前拥塞窗口的一半，并大大减小拥塞窗口的数值，称”**乘法减小MD(Multiplicative Decrease**”，合体称AIMD算法

   + **拥塞控制流程图：**

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313213527679.png" alt="image-20200313213527679" style="zoom:50%;" />

   + 现实中接收方的缓存空间总有限，接收方根据自己的接受能力设定了接收方窗口rwnd，并把这个窗口值写入TCP首部中的窗口字段，传送给发送方。

   + **接收方窗口又称为通知窗口(advertised window)，**从接收方对发送方的流量控制角度考虑，**发送方的发送窗口一定不能超过对方给出的接收方窗口值rwnd**

     <center>发送方窗口的上限值 = min [rwnd,cwnd]</center>

   + rwnd 和 cwnd 中数值较小的一个，控制了发送方发送数据的速率

### 5.8.3 主动队列管理AQM

+ 网络层的策略对TCP拥塞控制影响最大的就是路由器的分组丢弃策略
+ 路由器的队列通常都是按照FIFO规则处理，当队列已满时排不上队的就被丢弃——**尾部丢弃策略(tail-drop policy)**
+ 可能会将包含TCP报文的IP数据报丢弃，而IP数据报若为复用情况，则会造成许多TCP连接在**同一时间**突然进入慢开始，称为**全局同步(globa syncronization)**
+ 为避免发生网络中的全局同步现象，提出**主动队列管理AQM(Active Queue Management)**，大概意思是路由器主动管理队列，依据概率随机让几个报文丢失以防出现队列满的情况，牺牲几个TCP保证全局正常运行
+ AQM有不同的实现方法
  + 随机早期检测RED(Random Early Detection)/Random Early Drop/Random Early Discard
+ 实现RED时需要路由器维持两个参数，队列长度的**最小门限**和**最大门限**
+ 每当一个分组到达，RED按照规定的算法先计算当前的平均队列长度
  1. 若平均队列长度小于最小门限，排队
  2. 若平均队列长度超过最大门限，丢弃
  3. 处于两门限之间，按某一丢弃概率p丢弃(体现了丢弃分组的随机性)
+ RED不是等到已经发生网络拥塞后才把所有在队列尾部的分组全部丢弃，而是在检测到网络拥塞的**早期征兆**时就以一定概率p丢弃个别的分组，让拥塞控制只在个别TCP连接上进行，因而避免全局性的拥塞控制造成全局同步
+ 最难处理部分为**丢弃概率的选择**，p不是常数，对每个到达的分组，都必须计算丢弃概率p的数值
+ 多年证明RED使用效果不理想，但AQM还是必要的，目前还在实验阶段

## 5.9 TCP的运输连接管理

+ TCP是面向连接的协议。
+ 运输连接是用来传送TCP报文的。TCP运输连接的建立和释放是每一次面向连接的通信中必不可少的过程。
+ 运输连接就有三个阶段
  1. 连接建立
  2. 数据传送
  3. 连接释放
+ TCP连接建立过程中要解决三个问题：
  1. 要使每一方能够确知对方的存在
  2. 要允许双方协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量等）
  3. 能够对运输实体资源进行分配
+ TCP连接的建立采用C/S模式，主动发起的是客户，被动建立连接的是服务器。

### 5.9.1 TCP的连接建立

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313220348586.png" alt="image-20200313220348586" style="zoom:50%;" />

+ A主动打开连接，B被动打开连接
+ B的TCP服务器进程先创建**传输控制块TCB**，准备接收连接请求，然后处于LISTEN状态
+ A的TCP服务器进程先创建**传输控制块TCB**，打算建立TCP连接时向B发送连接请求报文段，首部中同步位SYN = 1，同时选择一个初始序号seq = x，TCP规定SYN报文段不能携带数据，但**要消耗一个序号**，这时服务器进入SYN-SENT
+ B收到连接请求报文段后
  + 同意建立连接则向A发送确认，把SYN=1，ACK=1，ack=x+1，为自己选择一个初始序号y，这个报文不能携带数据但同样**消耗一个序号**，TCP服务器进程进入SYN-RCVD
+ TCP客户进程收到B的确认后，向B给出确认，确认报文段的ACK=1，确认号ack = y + 1，自己序号seq=x+1。TCP标准规定，ACK报文段可以携带数据，**如果不携带数据则不消耗序号**，这种情况，下一个数据报文段的序号仍是seq=x+1，TCP连接建立，进入ESTABLISHED状态
+ B收到A的确认后，也进入ESTABLISHED状态
+ 服务器发给客户的报文可拆为确认报文与同步报文，四报文握手效果相同
+ 客户最后发一次确认时为了防止已失效的连接请求让服务器突然以为自己建立了连接

### 5.9.2 TCP的连接释放

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313222436490.png" alt="image-20200313222436490" style="zoom:50%;" />

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313222717971.png" alt="image-20200313222717971" style="zoom:50%;" />

+ 除**时间等待计时器(2MSL)**外，TCP还设有一个**保活计时器(keepalive timer)**，服务器每收到一次客户数据，就重新设置保活计时器，时间设置通常两小时，若两小时未收到客户数据，服务器就发送一个探测报文段，以后每隔75秒发送一次，若一连发送10个探测报文段后仍无客户响应，服务器就认为客户端出了故障，接着关闭连接

+ 四报文握手中，如果A在TIME-WAIT状态不等一段时间，而是发送完ACK报文段后立即释放连接，那么久无法收到B重传的FIN+ACK报文段，因而也不会再发送一个确认报文段，这样B就无法按照正常步骤进入CLOSED状态

### 5.9.3 TCP的有限状态机

+ **粗实线箭头**表示对**进程**的**正常变迁**
+ **粗虚线箭头**表示对**服务器**进程的**正常变迁**

+ **细线箭头**表示**异常变迁**

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200313223024598.png" alt="image-20200313223024598" style="zoom:67%;" />

# Chapter 6 应用层

+ 应用程序间的不同协议要通过应用程序自己之间通信和协同工作来完成
+ 应用层的具体内容就是精确定义这些通信规则
  +  应用进程交换的报文类型，如请求报文和响应报文
  + 各种报文类型语法，如报文中的各个字段及其详细描述
  + 字段的含义，包含在字段中的信息的含义
  + 进程何时、如何发送报文，以及对报文进行响应的规则
+ 应用层协议有的公开，有的不公开
+ 万维网的应用层协议是**HTTP(Hyper Text Transforming Protocol)**，它定义了在万维网浏览器和万维网服务器之间传送的报文类型、格式和序列等规则
+ 而万维网浏览器如何显示一个万维网页面，万维网服务器是用多线程还是多进程实现，都不是HTTP定义的内容
+ 应用层许多协议都是基于C/S服务模式，即使P2P对等通信方式，实际上也是一种特殊的客户服务器方式
+ **客户是发起服务请求方，服务器是服务提供方**

## 6.1 域名系统DNS

### 6.1.1 域名系统概述

+ **域名系统DNS(Domain Name System)**是互联网使用的命名系统，用来把便于人们使用的机器名字转换为IP地址
+ “域名系统”很明确地指明这种系统是用在互联网络中的
+ 域名系统DNS能够把互联网上的主机名字转换为IP地址
+ 整个互联网可以只使用一个域名服务器，但互联网规模太大，服务效果会很不理想所以此方法不可取
+ 1983年互联网就开始采用层次树状结构的命名方法，并使用分布式的**域名系统DNS**
+ 互联网的域名系统DNS被设计成为一个联机分布式数据库系统，并采用C/S方式，DNS使大多数名字都在本地进行**解析(rersolve)**，仅少量解析需要在互联网上通信，因此DNS系统的效率很高。
+ 由于DNS使分布式系统，即使单个计算机出了故障，也不会妨碍整个DNS系统的正常运行。
+ 域名到IP地址的解析是由分布在互联网上的许多**域名服务器程序**共同完成的，常把运行域名服务器程序的机器称为域名服务器
+ 域名到IP地址的解析过程的要点：
  + 当某应用进程需要把主机名解析为IP地址，该应用进程就调用**解析程序(resolver)**，并成为DNS的一个客户，把带解析的域名放在DNS请求报文中，以UDP用户数据报方式发给本地域名服务器。
  + 本地域名服务器在查找域名后，把对应的IP地址放在回答报文中返回。
  + 应用进程获得目的主机的IP地址后即可进行通信
  + 若本地域名服务器不能回答该请求。则此域名服务器就成了DNS中的另一个客户，向其他域名服务器发出查寻请求

### 6.1.2 互联网的域名结构

+ 早期的互联网使用了非等级的名字空间，优点是名字简短，随着万维网发展，逐渐不便于管理，后来采用层次树状结构的命名方法
+ 任何一个连接在互联网上的主机或路由器，都有一个唯一的层次结构名字——**域名(domain)**
+ 域还可以划分子域，还可多层划分子域，形成顶级域、二级域、三极域……
+ 每个域名都由**标号(label)**序列组成，各标号之间用.隔开
+ DNS规定域名中标号都由英文字母与数字组成，**每个标号不超过63个字符**，**不区分大小写**，除连字符-外不能使用其他标点符号。
+ **级别最低的域名在最左边，级别最高在最右边**

+ **多个标号组成的完整域名总共不超过255个字符**
+ DNS既不规定一个域名需要包含多少个下级域名，也不规定每一级域名代表什么含义
+ 各级域名由其上一级域名管理机构，而最高的顶级域名由ICANN管理
+ 这种方法可使每个域名在整个互联网范围内唯一并且查找机制设计容易
+ **域名只是逻辑概念，不代表计算机所在物理地点**

+ 顶级域名TLD(Top Level Domain)

+ 原先的顶级域名共分三大类：

  1. **国家顶级域名 nTLD**，如中国cn，美国us，英国uk等
  2. **通用顶级域名 gTLD**，如公司com，教育org，网络服务net等
  3. **基础结构域名(infrastructure domain)**，这种顶级域名只有arpa，用于反向域名解析，因此称为**反向域名**

+ 批准新顶级域名后，任何公司机构都有权向ICANN申请新的顶级域

+ 新顶级域名使得企业有了显著、强烈的标志特征

+ 我国把二级域名划分为“**类别域名**“和“**行政区域名**“

  1. **类别域名7个：**

     ac——科研，com——工商金融等企业，edu——中国教育机构，gov——中国政府机构，mil——中国国防机构，net——互连网络服务的机构，org——非盈利性组织

  2. **行政区域名34个：**

     例如：bg——北京，js——江苏

+ 域名树的树叶就是单台计算机的名字，不能继续往下划分

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200315165013583.png" alt="image-20200315165013583" style="zoom:50%;" />

+ 域名必须唯一
+ 互联网的名字空间是按照机构的组织来划分的，与物理网络无关，与子网无关

### 6.1.3 域名服务器

+ 一个服务器所负责管辖的（或有权限的）范围叫**区（zone）**

+ 每个区设置相应的**权限域名服务器(authoritative name server)**，用来保存该区中的所有主机的域名到IP地址的映射

+ DNS服务器的管辖范围不是以”域“为单位，而是以”区“为单位

+ **区可能等于或小于域，但一定不能大于域**，**区是域的子集**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200315165639068.png" alt="image-20200315165639068" style="zoom:50%;" />

+ 每一个域名服务器都能进行部分域名到IP地址的解析。某个DNS服务器不能进行域名到IP地址的转换时，就设法找互联网上别的域名服务器进行解析

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200315170113388.png" alt="image-20200315170113388" style="zoom:50%;" />

+ 互联网上的DNS域名服务器也是按照层次安排的，每个域名服务器都只对域名体系中的一部分进行管辖。根据域名服务器所起作用将域名服务器划分四类：

  1. **根域名服务器(root name server)**
     + 根域名服务器是最高层次的域名服务器，也是最重要的域名服务器
     + 所有根域名服务器都知道所有顶级域名服务器的域名和IP地址
     + 不管哪个本地域名服务器，若要对互联网上任何一个域名进行解析，只要自己无法解析，就首先求助根域名服务器，问他该去哪找映射记录
     + 若所有根域名服务器瘫痪，整个互联网中的DNS系统便无法工作
     + 600个左右的根域名服务器只使用了13个不同IP地址的域名：
       + a.rootservers.net
       + b.rootservers.net
       + ……
       + m.rootservers.net
     + 在互联网中是由13套装置构成这13组根域名服务器，每套装置在很多地点安装根域名服务器，但都使用一个域名。大多在美国，全世界分布
     + 为提供更可靠服务，每个地点的根域名服务器往往由多台机器组成，甚至有保密
     + **根域名服务器采用了任播技术(anycast)**
     + DNS客户向某根域名服务器IP地址发出查询报文时，互联网上的路由器能找到最近的根域名服务器，加快DNS查询进程，合理利用网络资源
     + 北美1/375w，亚洲1/2000w
     + 许多情况下根域名服务器不直接把待查询域名直接转换IP，而是指出下一步要去哪查
  2. **顶级域名服务器（TLD服务器）**
     + 这些域名服务器负责管理在该顶级域名服务器注册的所有二级域名，收到DNS查询请求时，给出响应回答
  3. **权限域名服务器**
     + 负责一个区的域名服务器
  4. **本地域名服务器(local name server)**
     + 当一台主机发出DNS请求时，这个查询报文就发送给本地域名服务器
     + 首选DNS服务器和备用DNS服务器的IP地址可编辑
     + 当所查询的主机也属于同一个本地ISP时，该本地域名服务器立即就能将查询的主机名转换为它的IP地址，而不需要在询问其他域名服务器

+ 物理冗余方面有**主域名服务器(master name server)**，**辅助域名服务器(secondary name server)**

  + 主域名服务器定期把数据复制到辅助域名服务器中，而更改数据只能在主域名服务器中进行，保证数据一致性

+ **域名解析过程：**

  1. **主机**向**本地域名服务器**的查询一般都是采用**递归查询**

     + 你问我，我不知道，我帮你问去

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200315172712559.png" alt="image-20200315172712559" style="zoom:50%;" />

  2. **本地域名服务器**向**根域名服务器**的查询通常采用**迭代查询(iterative query)**

     + 你问我，我不帮你问，你问那个谁去

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200315172639710.png" alt="image-20200315172639710" style="zoom:50%;" />

+ 为提高DNS查询效率，就爱年轻根域名服务器的负荷和减少互联网上的DNS查询报文数量，在域名服务器中广泛地使用了**高速缓存**，用来存放最近查询过的域名以及从何处获得域名映射信息的记录
+ **可以直接把高速缓存中存放的上次查询结果告诉用户**

+ 本地域名服务器也可以不向根域名服务器进行查询，而是直接向之前解析过的相同顶级域名服务器发送查询请求报文

+ 名字到地址的绑定并不经常改变，为保持高速缓存中的内容正确，域名服务器应为每项内容设置计时器并处理超过合理时间的项，**增加此时间可减少网络开销，减少此时间可提高域名转换的准确性**
+ 本地域名服务器中需要高速缓存，主机中也需要
+ 许多主机在启动时从本地域名服务器下载名字和地址的全部数据库，维护存放自己最近使用的域名的高速缓存，并且只在从缓存中找不到名字时才使用域名服务器

## 6.2 文件传送协议

### 6.2.1 FTP概述

+ **文件传送协议FTP(File Transfer Protocol)**
+ 提供交互式访问，允许客户指明文件的类型与格式，并允许文件具有存取权限
+ FTP屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件
+ 基于TCP的FTP与基于UDP的TFTP都是文件共享协议中的一大类——**复制整个文件**
  + 若要存取一个文件，就必须先获得一个本地的文件副本，若要修改文件只能修改副本，然后将副本传回原节点

+ 文件共享协议中的另一大类是——**联机访问(on-line access)**
  + 联机访问意味着允许多个程序同时对一个文件进行存取。
  + 使用户可以用**远地文件作为输入和输出来运行任何应用程序**，而操作系统中的文件系统则提供对共享文件的**透明存取**。
  + 透明存取的优点是：将原来用于处理本地文件的应用程序用来处理远地文件时，不需要对该应用程序做明显改动。
+ 属于文件共享协议的还有——**网络文件系统NFS(Network File System)**

### 6.2.2 FTP的基本工作原理

+ 传送文件很难，因为文件系统多达百种，差别很大，问题有：

  + 计算机存储数据格式不同
  + 文件目录结构和文件明名的规定不同
  + 对于相同的文件存取功能，操作系统使用的命令不同
  + 访问控制方法不同

+ 文件传送协议FTP只提供文件传送的一些基本服务，使用TCP可靠的运输服务，主要要减少或消除不同操作系统下处理文件的不兼容性

+ FTP使用C/S方式，一个FTP服务器进程可同时为多个客户进程提供服务。

+ FTP服务器进程由**两大部分**组成：

  + **主进程**：负责接收新请求，大堂经理
  + 若干**从属进程**：负责处理单个请求，店小二

+ **主进程工作步骤：**

  1. 打开熟知端口（21），使客户进程能够连接上
  2. 等待客户进程发出连接请求
  3. 启动从属进程处理客户进程发来的请求
     + 从属进程对客户进程的请求处理完毕后即终止
     + 从属进程在运行期间根据需要还可能创建其他一些子进程
  4. 回到等待状态，继续接受其他客户进程发来的请求。
     + 主进程与从属进程的处理是并发进行的

+ 服务器端有两个从属进程

  + 控制进程
  + 数据传送进程

+ 文件传输时，FTP客户与服务器间要建立两个并行的TCP连接：

  + “**控制连接**”
    + FTP客户所发出的传送请求，通过控制连接发送给服务器端的控制进程，不用来传送文件
  + “**数据连接**”
    + 接收到客户端的FTP请求后，创建“**数据传送进程**”和“**数据连接**，用于传输文件

+ 由于FTP使用了一个分离的控制连接，因此FTP的控制信息是**带外(out of band)**传送的

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200316151550653.png" alt="image-20200316151550653" style="zoom:50%;" />

+ 客户进程发出建立连接请求后，寻找服务器进程的熟知端口21，同时告诉服务器自己的另一个端口用于传送文件，FTP使用两个不同的端口号所以数据连接与控制连接不会产生混乱
+ **NFS允许应用进程打开一个远地文件，并能在该文件的某一个特定位置上开始读写数据**，适用于对大文件的部分修改编辑

### 6.2.3 简单文件传送协议TFTP

+ TCP/IP协议族中还有一个**简单文件传送协议TFTP(Trivial File Transfer Protocol)**
+ **TFTP需要有自己的差错改正措施，因为它是基于UDP的**
+ TFTP只支持文件传输而不支持交互
+ TFTP的主要优点有两个：
  1. TFTP可用于UDP环境
  2. TFTP代码所占内存较小，增加灵活性、减少了开销
+ TFTP主要特点：
  1. 每次传送的数据报文有512字节数据，最后一次不足512字节作为结尾，若整除512则加一个空包
  2. 数据报文按序编号，从1开始
  3. 支持ASCII码或二进制传送
  4. 可对文件进行读或写
  5. 使用很简单的首部
+ **TFTP的工作很像停止等待协议，发送完一个文件块后等对方确认，确认时应指明所确认的块编号**

## 6.3 远程终端协议TELNET

+ 用户用TELNET就可在其所在地通过TCP连接注册（即登录）到远地的另一台主机上
+ **TELNET又称为终端仿真协议**
+ TELNET能够适应许多计算机和操作系统的差异
+ **网络虚拟终端NVT(Network Virtual Terminal)**
+ 客户软件把用户的击键和命令转换为NVT格式，送交服务器，服务器软件再把收到的命令和数据从NVT转化为远地系统所需的格式，**可双向翻译、转换数据格式**
+ NVT还定义了两字符的CR-LF为标准的行结束控制符
+ 可商定使用更多的终端功能，协商的双方是平等的

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200316143622316.png" alt="image-20200316143622316" style="zoom:50%;" />

## 6.4 万维网WWW

### 6.4.1 万维网概述

+ 万维网WWW(World Wide Web)并非某种特殊的计算机网络，**是一个大规模的、联机式的信息储藏所**

+ 万维网用链接的方法能非常方便地从互联网上的一个站点访问另一个站点（“**链接到另一个站点**“），从而主动按需获取丰富信息

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200316144056341.png" alt="image-20200316144056341" style="zoom:50%;" />

+ 万维网的出现使得网站数按指数规律增长
+ 万维网是一个分布式的**超媒体(hypermedia)系统**，它是**超文本(hypertext)**系统的扩充
+ 超媒体与超文本的区别是文档内容不同。超文本文档仅包含文本信息，而超媒体文档还包含其他表示方式的信息，如图像、图形、声音、动画以及视频图像等
+ 这些文档之间的链接可进行一致性检查
+ 一个非分布式超媒体系统能够保证所有的链接都是有效的和一致的
+ 每台主机上的文档都独立进行管理，增加、修改、删除或重命名都不用或不能通知互联网上成千上万的节点，因此万维网文档间的链接经常会不一致，链接就会失效
+ **客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档**
+ 在一个客户程序主窗口上显示出的万维网文档称为页面
+ 万维网必须解决的问题：
  1. 怎样标志分布整个互联网上的万维网文档
     + **统一资源定位符URL(Uniform Resource Locator)标志万维网上的各种文档，使得互联网范围内有唯一的标识符URL**
  2. 用什么样的协议来实现万维网上的各种链接
     + **超文本传送协议HTTP(HyperText Transfer Protocol)**
  3. 怎样使不同作者创作的不同风格的万维网文档，都能在互联网上的各种主机上显示出来，同时使用户清楚地知道在什么地方存在着链接
     + **超文本标记语言HTML(HyperText Markup Language)**
  4. 怎样使用户能够很方便地找到所需的信息
     + 使用搜索工具

### 6.4.2 统一资源定位符URL

1. **URL的格式**

   + **统一资源定位符URL**

   + 用于表示从互联网上得到的资源位置和访问这些资源的方法

   + URL给资源的位置提供一种抽象的识别方法，并用这种方法给资源定位。只要能够对资源定位，系统就可以对资源进行各种操作

   + URL相当于一个文件名在网络范围的扩展

   + URL是与互联网相连的机器上的任何可访问对象的一个指针

   + URL还指出读取某个对象时所使用的协议

   + 一般形式：

     <center><协议>://<主机>:<端口>/<路径></center>

   + 最常用的协议就是http（超文本传送协议HTTP），其次是ftp（文件传送协议FTP）
   + 有些浏览器为了方便用户，在输入URL时，可把最前面的”http://“甚至把主机名最前面的”www“省略，然后浏览器替用户把省略的字符添加上。

2. **使用HTTP的URL**

   + HTTP的URL一般形式是：

     <center>http://<主机>:<端口>/<路径></center>

   + HTTP的默认端口号是80，通常可省略。若再省略文件的<路径>项，则URL就指到互联网上的某个**主页(home page)**

   + 更复杂的路径是指向层次结构的从属页面：

     <center>http://www.tsinghua.edu.cn/chn/yxsz/index.htm</center>

   + 后缀htm（有时可写为html）表示这是一个用超文本标记语言HTML写出的文件
   + URL的<协议>和<主机>部分，字母不分大小写，但<路径>有时要区分大小写

### 6.4.3 超文本传送协议HTTP

1. **HTTP的操作过程**

   + 从层次的角度看，HTTP是**面向事务的(transactionoriented)**应用层协议，它是万维网上能够可靠地交换文本（包括文本、声音、图像等各多媒体文件）的重要基础

   <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200316162701179.png" alt="image-20200316162701179" style="zoom:50%;" />

   + 浏览器和万维网客户是同义词

   + 一旦监听到连接建立请求并建立了TCP连接之后，浏览器就向万维网服务器发出浏览某个页面的请求，服务器接着就返回所请求得页面作为响应。最后TCP连接被释放

   + 用户浏览页面的方法有两种：

     1. 在浏览器的地址窗口中键入所要找的页面URL
     2. 另一种方法是在某一个页面中用鼠标点击一个可选部分，这时浏览器会自动在互联网上找到索要链接的页面

   + HTTP使用了面向连接的TCP作为运输层协议，保证了数据的可靠传输。

   + **HTTP协议本身是无连接的**

   + HTTP协议是**无状态的(stateless)**，即同一个客户第二次访问同一个服务器上的页面时，服务器的响应与第一次被访问时的相同，因为服务器不记得曾经访问过的客户，也不记得为该客户曾经服务过多少次

   + 用户在点击鼠标链接某个万维网文档时，HTTP协议首先要和服务器建立TCP连接。这需要三次握手当建立TCP连接的三报文握手。**当建立TCP连接的三报文握手的前两部分完成后（即经过一个RTT后），万维网客户就把HTTP请求报文，作为建立TCP连接的三报文握手中的第三个报文的数据，发送给万维网服务器。服务器收到HTTP请求报文后，就把所请求文档作为响应报文返回给客户**

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200316164135957.png" alt="image-20200316164135957" style="zoom:50%;" />

   + HTTP/1.0的主要缺点就是每请求一个文档就要花费两倍RTT开销
   
   + 万维网客户和服务器每一次建立新的TCP连接都要分配缓存和变量，因此使用并行TCP连接可以缩短响应时间
   
   + HTTP/1.1协议使用**持续连接(persistent connection)**较好解决该问题
   
     + 万维网服务器在发送响应后仍然在一段时间内保持这条连接，使同一个客户和该服务器可以继续在这条连接上传送后续的HTTP请求报文和响应报文
     + 不局限于传送同一个页面上的文档，只要这些文档都在同一个服务器就可
   
   + HTTP/1.1协议的持续连接有两种工作方式：
   
     1. **非流水线方式(without pipelining)**
   
        特点：
   
        + 客户在收到前一个响应后才能发出下一个请求
        + TCP连接建立后，客户每访问一次对象都要用去一个往返时间RTT，比非持续链接用去2倍RTT开销节省了一个RTT时间
   
        缺点：
   
        + 服务器发送完一个对象后TCP连接处于空闲状态，浪费了服务器资源
   
     2. **流水线方式(with pipelining)**
   
        特点：
   
        + 客户在收到HTTP的响应报文前就能够接着发送新的请求报文，服务器可连续发回响应报文
        + 客户访问所有的对象只需花费一个RTT时间
        + 流水线工作方式使TCP连接中的空闲时间减少，提高了下载文档的效率
   
2. **代理服务器**

   + **代理服务器(proxy server)**

   + 是一种网络实体，又称为**万维网高速缓存(Web Cache)**

   + 代理服务器把最近的一些请求和响应暂存在本地磁盘中，新请求到达时，若代理服务器发现这个请求与暂时存放的请求相同，就返回暂存的响应，而不需URL地址再去互联网访问该资源

   + 代理服务器可在客户端或服务器端工作，也可在中间系统上工作

   + 校园网使用代理服务器的情况步骤：

     1. 请求互联网服务时，先和校园网代理服务器建立TCP连接，并向代理服务器发出HTTP请求报文
     2. 若代理服务器已经存放了所请求的对象，代理服务器就把这个对象放入HTTP响应报文中返回给计算机的浏览器
     3. 否则，代理服务器就代表发出请求的用户浏览器，与互联网上的**源点服务器(origin server)**建立TCP连接，发送HTTP请求报文
     4. 源点服务器把所请求的对象放在HTTP响应报文中返回给校园网的代理服务器
     5. 代理服务器收到这个对象后，先复制在自己的本地存储器中，然后再把这个对象放在HTTP响应报文中，通过已建立的TCP连接，返回给请求该对象的浏览器

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200317084350156.png" alt="image-20200317084350156" style="zoom:50%;" />

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200317084425904.png" alt="image-20200317084425904" style="zoom:50%;" />

3. **HTTP的报文结构**

   + HTTP有两类报文：
     1. 请求报文——从客户向服务器发送请求报文
     2. 响应报文——从服务器到客户的回答

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200320112755258.png" alt="image-20200320112755258" style="zoom:50%;" /> <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200320113016146.png" alt="image-20200320113016146" style="zoom:50%;" />

+ HTTP是**面向文本的(text-oriented)**，因此在报文中的每一个字段都是一些ASCII码串，因而各个字段的长度都是不确定的
+ HTTP请求报文和响应报文都是由三个部分组成的
  1. **开始行**
     + 用于区分是请求报文还是响应报文。
  2. **首部行**
     + 用来说明浏览器、服务器或报文主体的一些信息。
  3. **实体主体(entity body)**
     + 在请求报文中一般不用这个字段，而在响应报文中也不一定有这个字段
+ 请求报文的第一行“请求行”只有三个内容，即**方法，请求资源的URL**，以及HTTP的**版本**。
+ “方法”就是对所请求的对象进行的**操作**，这些方法实际上也就是一些命令
+ 请求报文的类型是由它所采用的方法决定的

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200320120242752.png" alt="image-20200320120242752" style="zoom:50%;" />

+ HTTP的请求报文的开始行（请求行）的格式

  <center>GET http://www.xyz.edu.cn/dir/index.htm HTTP/1.1</center>

+ 完整的HTTP请求报文的例子：
  + GET /dir/index.htm HTTP/1.1
  + Host: www.xyz.edu.cn
  + Connection: close
  + User-Agent: Mozilla/5.0
  + Accept-Language: cn
+ HTTP响应报文的主要特点
  + 每个请求报文发出都能收到一个响应报文。响应报文的第一行就是状态行
  + 状态行包括：HTTP版本，状态码，解释状态码的简单短语
  + **状态码**分为5大类，5大类的状态码都是以不同的数字开头
    + 1xx表示通知信息，如请求收到了或正在进行处理
    + 2xx表示成功，如接受或知道了
    + 3xx表示重定向，如要完成请求还必须采取进一步的行动
    + 4xx表示客户的差错，如请求中有错误或不能完成
    + 5xx表示服务器的差错，如服务器失效无法完成请求
    + 例如：202 Accepted，400 Bad Request，404 Not Found
+ 若请求的网页已经转移到另一新地址，则响应的状态和一个首部行就是下面的形式
  + HTTP/1.1 301 Moved Permanently
  + Location: http://www.xyz.edu/ee/index.html

4. **在服务器上存放用户的信息**

   + HTTP可以使用Cookie

   + Cookie表示在HTTP服务器和客户之间传递的状态信息

   + 当用户A浏览某个使用Cookie的网站时，该网站的服务器就为A产生一个唯一的识别码，并以此作为索引在服务器的后端数据库中产生一个项目。接着在给A的HTTP响应报文中添加了一个叫做Set-cookie的首部行。这里的”首部字段名“就是”Set-cookie"，而后面的“值”就是赋予该用户的“识别码”，例如：

     Set-cookie: 31d4d96e407aad42

   + 当A收到这个响应时，其浏览器就在它管理的特定Cookie文件中去除这个网站的识别码，并放到HTTP请求报文的Cookie首部行中：

     Cookie: 31d4d96e407aad42

   + 服务器不需要知道这个用户的真实姓名以及其他的信息。但服务器能够知道用户31d4d96e407aad42在什么时间访问了哪些页面，以及访问这些页面的顺序
     
     + 如果A在几天后再次访问此网站，那么他的浏览器会在其HTTP请求报文中继续使用首部行Cookie: 31d4d96e407aad42.
   + 用户可根据自己的情况对IE浏览器进行必要的设置

### 6.4.4 万维网的文档

1. **超文本标记语言HTML**

   + **超文本标记语言HTML (HyberText Markup Language)**就是一种制作万维网页面的标准语言，它消除了不同计算机之间信息交流的障碍。
   + HTML**并不是应用层的协议，它只是万维网浏览器使用的一种语言**
   + HTML定义了许多用于排版的命令，即“标签(tag)”
   + 仅当HTML文档是以.html或.htm为后缀时，浏览器才对这样的HTML文档的各种标签进行解释。如果HTML文档改为以.txt为其后缀，则HTML解释程序就不对标签进行解释，而浏览器只能看见原来的文本文件
   + 并非所有浏览器都支持所有的HTML标签。若某个浏览器不支持某个HTML标签，则浏览器将忽略此标签，但在一对不能识别的标签之间的文本仍然会被显示出来
   + HTML允许在万维网页面插入图像
   + HTML还规定了链接的设置方法，每个连接都有一个**起点**和**终点**
     + 链接的终点可以是其他网站上的页面。这种链接方式叫做**远程链接**，这时必须在HTML文档中指明链接到的网站的URL。有时链接可以指向本计算机中的某一个文件或本文件中的某处，这叫做**本地链接**。这时必须在HTML文档中指明链接的路径
   + XML(Extensible Markup Language)是**可扩展标记语言**，它和HTML很相似。但XML的设计宗旨是传输数据，而不是显示数据(HTML是为了在浏览器上显示数据)
   + 另一种语言XHTML(Extensible HTML)是**可扩展超文本标记语言**
   + CSS(Cascading Style Sheets)是**层叠样式表**
     + CSS与HTML的区别是：
       + HTML用于结构化内容，而CSS则用于格式化结构化内容
   + 现在所有浏览器都支持CSS

2. **动态万维网文档**

   + 静态文档（static document)

   + 静态文档的最大优点是简单，但静态文档在创作完毕后就存放在万维网服务器中，在被用户浏览的过程中内容不会改变。由于这种文档的内容不会改变，因此用户对静态文档的每次读取所得到的返回结果都是相同的

   + 变化频繁的文档不适用于做成静态文档

   + **动态文档(dynamic document)**是指文档的内容是在浏览器访问万维网服务器时才由应用程序动态创建的

   + 由于对浏览器每次请求的响应都是临时生成的，因此用户通过动态文档所看到的内容是不断变化的。动态文档的主要优点是具有报告当前最新信息的能力

   + 动态文档和静态文档之间的主要差别体现在服务器一端，因为生成方法不同

     + 浏览器角度看，这两种文档并无差别
     + 动态文档和静态文档内容遵循HTML所规定格式，浏览器仅根据屏幕上内容无法判定服务器送来的是哪一种文档，只有开发者才知道

   + 要实现动态文档就必须在以下两个方面对万维网服务器的功能进行扩充：

     1. 应增加另一应用程序，用来处理浏览器发来的数据，并创建动态文档
     2. 应增加一个机制，用来使万维网服务器将浏览器发来的数据传送给这个应用程序，万维网服务器能够解释这个应用程序的输出，并向浏览器返回HTML文档

   + **通用网关接口CGI(Common Gateway Interface)**

     + CGI是一种标准，定义了动态文档应如何创建，输入数据应如何提供给应用程序，以及输出结果应如何使用
     + 万维网服务器中新增加的应用程序叫做CGI程序
     + 有人称CGI程序为**网关程序**
     + 应弄清是指CGI标准，还是CGI程序

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200320150310083.png" alt="image-20200320150310083" style="zoom:50%;" />

     + CGI程序的正式名字是**CGI脚本(script)**
       + **“脚本“**指的是一个程序，它被另一个程序（解释程序）而不是计算机的处理机来解释或执行
       + 一个脚本运行起来比一般编译程序要慢，因为它的每一条指令要先被另一个程序来处理而不是直接被指令处理器来处理。脚本不一定是一个独立的程序，它可以是一个动态装入的库，甚至是服务器的一个子程序

3. **活动万维网文档**

   + 有两种技术可用于浏览器屏幕显示的连续更新。一种技术称为**服务器推送(server push)**，这种技术是将所有的工作都交给服务器。服务器不断地运行与动态文档相关联的应用程序，定期更新信息，并发送更新过的文档

   + 很大的缺点：

     + 服务器要运行许多服务器推送程序。将造成过多的服务器开销
     + 服务器推送技术要求服务器为每一个浏览器客户维持一个不释放的TCP连接，TCP连接的数目增加，每个连接所能分配到的网络带宽就下降，这就导致网络传输时延的增大

   + 另一种提供屏幕连续更新的技术是**活动文档(active document)**

     + 把所有工作都转移给浏览器端
     + 返回一段活动文档程序副本，使该程序副本在浏览器端运行
     + 从传送角度看，浏览器和服务器都把活动文档看成是静态文档
     + 活动文档本身并不包括其运行所需的全部软件，大部分支持软件是事先存放在浏览器中的

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200320151929681.png" alt="image-20200320151929681" style="zoom:50%;" />

   + 在Java技术中使用了一个新的名词”**小应用程序(applet)**“来描述活动文档程序

### 6.4.5 万维网的信息检索系统

1. **全文检索搜索与分类目录搜索**
   + 在万维网中用来进行搜索的工具叫做**搜索引擎(search engine)**
   + 大体划分为两大类：
     + **全文检索搜索引擎**
       + 全文检索搜索引擎是一种纯技术型的检索工具
       + 用户在查询时只要输入关键词，就从**已经建立**的**索引数据库**里进行查询，因此很有可能查到已过期信息
       + 建立这种索引数据库的网站必须定期对已建立的数据库进行更新维护
     + **分类目录搜索引擎**
       + 分类目录搜索引擎并不采集网站任何信息
       + 利用各网站向搜索引擎提交网站信息时填写的关键词和网站描述等信息，经人工审核编辑后，如果认为符合网站登录的条件，则输入到分类目录的数据库中，供网上用户查询
       + 分类目录搜索也叫做分类网站搜索
       + 分类目录的好处就是用户可根据网站设计好的目录有针对性地主机查询所需要的信息，查询时不需要使用关键词，只需要按照分类，因而查询的准确性较好
   + **搜索引擎网站本身并没有直接存储这些信息**
   + 目前出现了**垂直搜索引擎(Vertical Search Engine)**，他针对某一特定领域、特定人群或某一特定需求提供搜索服务
   + **元搜索引擎(Meta Search Engine)**，它把用户提交的检索请求发送到多个独立的搜索引擎上去搜索，并把检索结果集中统一处理，以统一格式提供给用户，因此是搜索引擎之上的搜索引擎。元搜索引擎的查全率和查准率都比较高
2. **Google搜索技术的特点**
   + 核心技术是PageRank，译为网页排名，它对搜索出来的结果按重要性进行排序
   + 传统的搜索引擎往往检查关键字在网页上出现的频率
   + 检查整个网络链接的结构，并确定哪些网页重要性最高
   + 使用迭代方法解决二维矩阵的巨大计算量，先算出各个网页的第一次迭代排名，再根据第一次迭代排名算出第二次排名，保证了网页排名的估计值能够收敛到排名的真实值

### 6.4.6 博客和微博

1. **博客**
   + **万维网日志(weblog)**
   + 也译为部落格
   + 博客实现了网民不仅是互联网上的内容的消费者，而且还是互联网上的**内容的生产者**
   + 博客与网站的区别
     + 个人网站成本高
     + 网站需要懂HTML语言和网页制作等相关技术
     + 博客门槛低
2. **微博**
   + **微型博客(microblog)**，**微博客**
   + 政务微博具有“传递信息、沟通上下、解决问题”的功能特点

### 6.4.7 社交网站

+ **社交网站SNS(Social Networking Site)**
+ 2004年**脸书(Facebook)**
+ 2006年**推特(Twitter)**
+ **领英(LinkedIn)**
+ **微信**异于其他的社交软件的特性就是只能在确定的朋友圈中交换信息

## 6.5 电子邮件

### 6.5.1 电子邮件概述

+ 实时通信的电话有两个严重缺点

  1. 电话通信的主叫和被叫双方必须同时在场
  2. 有些电话常常不必要地打断被叫者地工作或休息

+ **电子邮件(e-mail)**是互联网上使用最多的和最受用户欢迎的一种应用

+ 电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中收件人**邮箱(mail box)**，具有传递迅速和费用低廉优点

+ **简单邮件传送协议SMTP(Simple Mail Transfer Protocol)**和**互联网文本报文格式**

+ 一个电子邮件系统具有**三个主要的组成构件**：

  + **用户代理**
  + **邮件服务器**
  + **邮件发送协议(SMTP)**和**邮件读取协议(POP3)**，POP3是邮局协议(Post Office Protocol)

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200321133439819.png" alt="image-20200321133439819" style="zoom:50%;" />

  + **用户代理UA(User Agent)**就是用户与电子邮件系统的接口，在大多数情况下它就是运行在用户电脑中的一个程序，因此用户代理又称为**电子邮件客户端软件**

    1. **撰写**
       + 给用户提供编辑信件的环境
    2. **显示**
       + 能方便地在计算机屏幕上显示出来信
    3. **处理**
       + 包括发送邮件和接收邮件
    4. **通信**
       + 发信人在撰写完邮件后，要利用邮件发送协议发送到用户所使用的邮件服务器。收件人在接收邮件时，要使用邮件读取协议从本地邮件服务器接收邮件
       + 邮件服务器需要使用**两种不同的协议**
         + 用于用户代理向邮件服务器发送邮件或在邮件服务器之间发送邮件，如SMTP
         + 用于用户代理从邮件服务器读取**邮件**，如**邮局协议POP3**
       + 邮件服务器必须能够同时充当客户和服务器

  + **计算机之间发送与接收电子邮件的几个重要步骤**

    1. 发件人调用计算机中的用户代理撰写和编辑要发送的邮件
    2. 发件人点击屏幕上的“发送邮件"按钮
       + 用户代理把邮件用SMTP协议发给发送方邮件服务器，用户代理充当SMTP客户，而发送方邮件服务器充当SMTP服务器
    3. SMTP服务器收到用户代理发来的邮件后，就把邮件临时存放在邮件缓存队列中，等待发送到接收方的邮件接收器
    4. 发送方邮件服务器的SMTP客户与接收方邮件服务器的SMTP服务器建立TCP连接，然后就把邮件缓存队列中的邮件依次发送出去
       + **邮件不会在互联网中的某个中间邮件服务器落地**
       + 如果SMTP客户还有一些邮件要发送到同一个邮件服务器，那么可以在原来已建立的TCP连接上重复发送
    5. 运行在接收方邮件服务器中的SMTP服务器进程收到邮件后，把邮件放入收件人的用户邮箱中，等待收件人进行读取
    6. 收件人在打算收信时，就运行计算机中的用户代理，使用POP3（或IMAP）协议读取发送给自己的邮件

  + 两种不同的通信方式：

    + **推(push)**：SMTP客户把邮件”推”给SMTP服务器
    + **拉(pull)**：POP3客户把邮件从POP3服务器“拉”过来

  + Foxmail中使用一种“特快专递”服务。这种服务就是从发件人的用户代理直接利用SMTP把邮件发送到接收方邮件服务器

  + TCP/IP体系的电子邮件系统规定**电子邮件地址(e-mail address)**的格式如下：

    <center>用户名 @ 邮件服务器的域名</center>

### 6.5.2 简单邮件传送协议SMTP

+ SMTP规定了在两个互相通信的SMTP进程之间应如何交换信息。
+ SMTP使用客户服务器方式
  + 发送邮件的SMTP进程就是SMTP客户
  + 负责接收邮件的SMTP进程就是SMTP服务器
+ SMTP通信三个阶段
  1. **连接建立**
     + 发件人的邮件送到发送方邮件服务器的邮件缓存后，SMTP客户每隔一定时间对邮件缓存扫描一次。发现有邮件，就使用SMTP的熟知端口号码25与接收方邮件服务器的SMTP服务器建立TCP连接
     + **SMTP不使用中间的邮件服务器**
     + 当接收方邮件服务器出故障而不能工作时，发送方邮件服务器只能等待一段时间后再尝试和该邮件服务器建立TCP连接，而不能找一个中间的邮件服务器建立TCP连接
  2. **邮件传送**
     + 邮件的传送从MAIL命令开始。MAIL命令后面又发件人的地址
     + 下面跟一个或多个RCPT命令，取决于把同一个邮件发送给一个或多个收件人，其格式为RCPT TO:<收件人地址>
     + RCPT命令的作用是：先弄清接收方系统是否已做好接收邮件的准备，然后才发送邮件。
     + 虽然SMTP使用TCP连接试图使邮件的传送可靠，但“发送成功”并不等于“收件人读取了这个邮件”
  3. **连接释放**
     + 邮件发送完毕后，SMTP客户应发送QUIT命令。
+ 使用电子邮件的用户看不见以上这些过程
+ SMTP存在着一些缺点
+ 发送电子邮件不需要经过鉴别
+ 在FROM命令后面的地址可以任意填写
+ SMTP传送的邮件是明文，不利于保密
+ 为了解决上述问题，出现了**扩充的SMTP(Extend SMTP)**

### 6.5.3 电子邮件的信息格式

+ 一个电子邮件分为**信封**和**内容**两大部分
+ **首部被规定，主体自由撰写**
+ “To:"后面填入一个或多个**收件人的电子邮件地址**
+ "Subject:"是邮件的**主题**
+ "Cc:"是**抄送**，意思是留下一个“**复写副本**”
+ "From:"表示**发件人的电子邮件**
+ “Date:"表示**发信日期**
+ "Reply-To:"对方回信所用的地址

### 6.5.4 邮件读取协议POP3和IMAP

+ 常用的邮件读取协议有两个
  + **第三版本邮局协议POP3**
  + **网际报文存取协议IMAP(Internet Message Access Protocol)**
+ POP3协议的一个特点就是只要用户从POP3服务器读取了邮件，POP3服务器就把该邮件删除
+ POP3进行了一些补充防止误删等，其中包括让用户能够事先设置邮件读取后仍然在POP3服务器中存放的时间
+ 另一个读取邮件的协议是网际报文存取协议IMAP，它比POP3复杂得多。IMAP和POP都按客户服务器方式工作，但他们有很大差别，用户在自己的计算机上就可以操纵邮件服务器的邮箱，就像在本地操纵一样，因此IMAP是一个联机协议
+ IMAP的缺点是如果用户没有将邮件复制到自己的计算机上，则邮件一直存放在IMAP服务器上，要想查阅自己的邮件，必须先上网
+ **发件人的用户代理向发送方邮件服务器发送邮件，以及发送方邮件服务器向接收方邮件服务器发送邮件，都是使用SMTP协议。而POP3或IMAP则是用户代理从接收方邮件服务器上读取邮件所使用的协议**

### 6.5.5 基于万维网的电子邮件

+ 20世纪90年代中期，Hotmail推出了基于万维网的电子邮件(Webmail)
+ 使用万维网电子邮件不需要在计算机中再安装用户代理软件
+ 用户在浏览器中浏览各种信息时使用HTTP协议。
  + 浏览器和互联网上的邮件服务器传送邮件使用HTTP协议
  + 各邮件服务器间传送邮件时，仍然使用SMTP协议

### 6.5.6 通用互联网邮件扩充MIME

+ SMTP有以下缺点：
  + 不能传送可执行文件或其他二进制文件
  + 限于传送7位的ASCII码
  + 服务器会拒绝超过一定长度的邮件
  + 某些SMTP的实现并没有完全按照SMTP互联网标准，常见问题：
    + 回车、换行的删除和增加
    + 超过76各字符时的处理：截断或自动换行
    + 后面多余空格的删除
    + 将制表符转换为若干个空格
+ 提出**通用互联网邮件扩充MIME**

1. **MIME概述**

+ 没有改动或取代SMTP，使用原来的邮件格式，增加了邮件主体的结构，并定义传送非ASCII码的规则

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200324214559187.png" alt="image-20200324214559187" style="zoom:50%;" />

+ **MIME主要包括以下三部分内容：**

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200324214651161.png" alt="image-20200324214651161" style="zoom:50%;" />

+ **MIME增加的5个新邮件首部的名称及意义：**

  + **MIME-Version**：标志MIME的版本。现在的版本号是1.0。若无此行，则为英文文本。

  * **Content-Description**：这是可读字符串，说明此邮件是什么。和邮件的主题差不多。
  * **Content-Id**：邮件的唯一标识符
  * **Content-Transfer-Encoding**：在传送时是如何编码的
  * **Content-Type**：说明邮件主体的数据类型和子类型

2. **内容传送编码**

   + 三种常用的内容传送编码(Content-Transfer-Encoding)
     + 最简单的编码就是7位ASCII码，每行不超过1000个字符
       + 实际8位，首位一直是0，用于加强检错
     + 另一种编码称quoted-printable，适用于所传数据只有少量的非ASCII码，例如汉字
       + 开销200%
     + 任意二进制文件可用BASE64编码
       + 开销25%

3. **内容类型**

   + MIME标准规定Content-Type说明必须含有两个标识符，内容**类型(type)**和**子类型(subtype)**，中间"/"分开

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200324215910190.png" alt="image-20200324215910190" style="zoom:50%;" />

   + **multipart很有用，使增加了相当大的灵活性**
     1. mixed 子类型允许单个报文含有多个相互独立的子报文，每个子报文可有自己的类型和编码
     2. alternative子类型允许单个报文含有同一数据的多种表示
     3. parallel子类型允许单个报文含有可同时显示的各个子部分（视频、音频）
     4. digest子类型允许单个报文含有一组其他的报文

## 6.6 动态主机配置协议DHCP

+ 在协议软件中给这些参数赋值的动作叫做协议配置
+ 连接到互联网的计算机的协议软件需要配置的项目包括：
  1. IP地址
  2. 子网掩码
  3. 默认路由器的IP地址
  4. 域名服务器的IP地址
+ 需要连接到互联网的计算机，必须对IP地址等项目进行协议配置
+ 互联网现在广泛使用的是**动态主机配置协议DHCP(Dynamic Host Configuration Protocol)**，提供新的**即插即用联网(plug-and-play networking)**
+ DHCP对运行客户软件和服务器软件的计算机都适用。当运行客户软件的计算机移至一个新网络时，就可使用DHCP获取其配置信息而不需要手工干预
+ DHCP给运行服务器软件而位置固定的计算机指派一个永久地址，而当这计算机重新启动时其地址不变
  + DHCP采用C/S方式，需要IP地址的主机在启动时就向DHCP服务器广播发送**发现报文(DHCPDISCOVER)**，这时该主机就成为DHCP客户。
  + 发送广播报文是因为不知道DHCP服务器在什么地方，因此要发现DHCP服务器的IP地址。
  + 这台主机目前还没有自己的IP地址，因此它将IP数据报的源IP地址设为全0。这样在本地网络上的所有主机都能够收到这个广播报文，但只有DHCP服务器才对此广播报文进行回答。
  + DHCP服务器先在其数据库中查找该计算机的配置信息。若找到则返回找到的信息。若找不到，则从服务器的IP地址池(address pool)中取一个地址分配给该计算机。
  + DHCP服务器的回答报文叫做**提供报文(DHCPOFFER)**，表示“提供”了IP地址等配置信息

+ 每个网络至少有一个**DHCP中继代理(relay agent)**，当DHCP中继代理收到主机A以**广播**形式发送的发现报文后，就以**单播**方式向DHCP服务器转发此报文，并等待其回答。收到DHCP服务器回答的提供报文后，DHCP中继代理再把此提供报文发回给主机A

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200325171719641.png" alt="image-20200325171719641" style="zoom:50%;" />

+ DHCP服务器分配给DHCP客户的IP地址是临时的，因此DHCP客户只能在一段有限的时间内使用这个分配到的IP地址

+ DHCP协议称这段时间为**租用期(lease period)**，但并没有具体规定租用期应取为多长或至少多长由DHCP服务器自己决定

+ 租用期用4字节的二进制数字表示，单位是秒。因此可供选择的租用期范围从1秒到136年。DHCP客户也可在自己发送的报文中提出对租期的要求

+ DHCP详细工作过程：

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200325172623337.png" alt="image-20200325172623337" style="zoom:50%;" />

  1. DHCP服务器被动打开UDP端口67，等待客户端发来的报文
  2. DHCP客户从UDP端口68发送DHCP发现报文
  3. 收到DHCP发现报文的DHCP服务器都发出DHCP提供报文，因此DHCP客户可能收到多个DHCP提供报文
  4. DHCP客户从几个DHCP服务器中选择其中一个，并向所选择的DHCP服务器发送DHCP请求报文
  5. 被选择的DHCP服务器发送确认报文DHCPACK，从这时起，DHCP客户就可以使用这个IP地址，状态称为**已绑定状态**
     + DHCP客户现在要根据服务器提供的租用期T设置两个计时器T~1~和T~2~，它们的超时时间分别是0.5T和0.875T，当超时时间到了就要请求更新租用期
  6. 租用期过了一半，DHCP发送请求报文DHCPREQUEST要求更新租用期
  7. DHCP服务器若同意，则发回确认报文DHCPACK。DHCP客户得到了新的租用期，重新设置计时器
  8. DHCP服务器若不同意，则发回否认报文DHCPNACK，这时DHCP客户必须立刻停使用原来的IP地址，而必须重新申请IP地址
  9. DHCP客户可以随时提前终止服务器所提供的租用期，这时只需要向DHCP服务器发送释放报文DHCPRELEASE即可

+ DHCP很适合于经常移动位置的计算机

## 6.7 简单网络管理协议SNMP

### 6.7.1 网络管理的基本概念

+ 网络管理包括对硬件、软件和人力的使用、综合与协调，以便对网络资源进行监视、测试、配置、分析、评价和控制，这样就能以合理的价格满足网络的一些需求，如实时运行性能、服务质量等。**网络管理常简称为网管**

+ 网络管理并不是指对网络进行行政上的管理

+ 网络是一个非常复杂的分布式系统

+ **管理站**又称为**管理器**，是整个网络管理系统的核心，它通常是个有着良好图形界面的高性能工作站，并由网络管理员直接操作和控制。所有向被管设备发送的命令都是从管理站发出的。

+ 管理站的所在部门也常称为**网络运行中心NOC(Network Operations Center)**

+ 管理站中的关键构建是**管理程序**

+ 管理程序在运行时就成为**管理进程**

+ 管理站（硬件）或管理程序（软件）都可称为**管理者(manager)**或**管理器**，所以这里的manager不是指人而是指机器或软件。网络管理员(administrator)才是指人

+ 大型网络往往实行多级管理

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200325180542520.png" alt="image-20200325180542520" style="zoom:50%;" />

+ 在被管网络中有很多的**被管设备**，如主机、路由器、打印机等

+ 每个悲观设备可能有很多**被管对象**

+ 被管对象可以是被管设备中的某个硬件，也可以是某些硬件或软件。被管设备设备有时可称为**网络元素**或简称为**网元**。在被管设备中也会有一些**不能被管的对象**

+ 在每个被管设备中都要运行一个程序以便和管理站中的管理程序进行通信。这些运行着的程序叫做**网络管理代理程序**，或简称为**代理(agent)**

+ **网络管理协议**简称**网关协议**

+ **简单网络管理协议SNMP(Simple Network Management Protocol)**中的管理程序和代理程序按C/S服务器方式工作

+ 管理程序运行**SNMP客户程序**，而代理程序运行**SNMP服务器程序**

+ 网络管理有一个基本原理：

  **若要管理某个对象，就必然会给该对象添加一些软件或硬件，但这种“添加”对原有对象的影响必须尽量小些**

+ SNMP最重要的指导思想就是**要尽可能简单**

+ SNMP基本功能包括监视网络性能、检测分析网络差错和配置网络设备等

+ 在网络正常工作时，SNMP可实现统计、配置和测试等功能

+ 网络故障时，可实现各种差错检测和恢复功能

+ SNMPv3成为标准且最大改进就是安全特性

+ **委托代理(proxy agent)**，委托代理能够提供如协议转换和过滤操作等功能对被管对象进行管理

+ SNMP的网络管理由3部分组成：

  + SNMP本身
  + 管理信息结构SMI(Structure of Management Information)
  + 管理信息库MIB(Management Information Base)

+ SNMP定义了管理站和代理之间所交换的分组格式

+ SMI定义了命名对象和定义对象类型（包括范围和长度）的**通用规则**，以及把对象和对象的值进行**编码的规则**

+ MIB在被管理的实体中创建了命名对象，并规定了其类型

+ SMI建立规则，MIB对变量进行说明，而SNMP完成网关动作

### 6.7.2 管理信息结构SMI

+ **管理信息结构SMI**是SNMP的重要组成部分，功能有三个：
  1. 被管对象应怎样命名
  2. 用来存储被管对象的数据类型有哪些
  3. 在网络上传送的管理数据应如何编码

1. **被管对象的命名**

   + 所有的被管对象都必须处在**对象命名树(object naming tree)**上

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200325183830133.png" alt="image-20200325183830133" style="zoom:50%;" />

2. **被管对象的数据类型**
   + SMI使用基本的**抽象语法记法1**来定义数据类型，但又增加了一些新的定义
   + 任何数据都具有两种重要的属性，即**值(value)**与**类型(type)**
   + SMI把数据类型分为两大类：**简单类型**和**结构化类型**
   + SMI定义了两种结构化数据类型，即**sequence**（类似struct)和**sequence of**(类似array)
   
3. **编码方法**

   + **基本编码规则BER(Basic Encoding Rule)**指明了每种数据的类型和值

   + 需要三个字段表示：

     + 类型
     + 长度
     + 值

   + **所有数据元素都表示为T-L-V三个字段组成的序列**

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200326114818836.png" alt="image-20200326114818836" style="zoom:50%;" />

     + **T字段(Tag)定义数据的类型**

       + T字段又叫**标记字段**，占1字节

       + T字段又再分为以下三个子字段：

         1. **类别（2位）**
            + 通用类（00）
            + 应用类（01）
            + 上下文类（10）
            + 专用类（11）
         2. **格式（1位）**
            + 简单数据类型（0）
            + 结构化数据类型（1）

         3. **编号（5位）**
            + 用来标志不同的数据类型
            + 编号范围一般为0~30
            + 编号大于30时，T字段扩展为多个字节

     + **L字段(Length)定义V字段的长度**

       + L字段又叫**长度字段**（单字节或多字节）
       + 当L字段为单字节时，最高位为0，后7位定义V字段的长度
       + 当L字段为多个字节时，最高位为1，而后面的7位定义后续字节的字节数，所有后续字节并置起来的二进制整数定义V字段的长度

       <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200326120216160.png" alt="image-20200326120216160" style="zoom:50%;" />

     + **V字段(Value)定义数据的值**

### 6.7.3 管理信息库MIB

+ 所谓“**管理信息**“就是指在互联网的网管框架中**被管对象的集合**

+ 被管对象必须维持可供管理程序读写的若干控制和状态信息

+ 这些被管对象构成了一个虚拟的信息存储器，所以才称为**管理信息库MIB**

+ 管理程序就使用MIB中这些信息的**值**对网络进行管理。只有在MIB中的对象才是SNMP所能够管理的

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200326122415400.png" alt="image-20200326122415400" style="zoom:50%;" />

+ MIB的意义
  1. 在节点IP下面有个名为ipInReceives的MIB变量，表示收到的IP数据报数
  2. 当SNMP在报文中使用MIB变量时，对于简单类型的变量，后缀0指具有该名字的变量的实例
  3. 请注意，对于分配给一个MIB变量的数值或后缀是完全没有办法进行推算的，必须查找已发布的标准

### 6.7.4 SNMP的协议数据单元和报文

+ SNMP的操作只有两种基本的管理功能：
  + **读**操作：用Get报文来检测各被管对象的状况
  + **写**操作：用Set报文来改变各被管对象的状况
  
+ SNMP的这些功能通过**周期性发送探询信息**来实现

+ 探询的好处：

  + 可使系统相对简单
  + 能限制通过网络所产生的管理信息的通信量

+ 探询的缺点：

  + 探寻管理协议不够灵活
  + 所管理的设备数目不能太多
  + 开销很大

+ SNMP不是完全的探询协议，允许不经过询问就能发送某些信息，称为**陷阱(trap)**，表示它能够捕捉“事件”，但这种陷阱信息的参数是受限制的

+ 当被管对象的代理检测到有时间发生时，就检查门限值，代理只向管理进程报告达到某些门限值的事件（叫做**过滤**）

  + 严重事件发生时才发送陷阱
  + 陷阱信息很简单且所需字节数很少

+ SNMP使用无连接的UDP，因此在网络上传送SNMP报文的开销很小，且SNMP使用UDP的方法有些特殊

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200326165719022.png" alt="image-20200326165719022" style="zoom:50%;" />

+ **一个SNMP报文共由4个部分组成：**

  1. **版本**

  2. **首部**
     + 报文标识(message identification)
     + 最大报文长度
     + 报文标志(message flag)
     + 安全参数用来产生报文摘要
  3. **数据部分**

+ PDU的格式都是相同的，即由**PDU类型**、**请求ID**、**差错状态**、**差错索引**、**变量绑定**组成

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200326171119523.png" alt="image-20200326171119523" style="zoom:50%;" />

  + **请求标识符(request ID)**
    
    + 管理进程设置的4字节整数值
  + **差错状态(error status)**
    + 请求报文中，这个字段是0
    + 响应时填入0~18中的一个数字
  + **差错索引(error index)**
  
  + 请求报文中此字段是0
  
  + **变量绑定(variable-bindings)**

    <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200326172254316.png" alt="image-20200326172254316" style="zoom:50%;" />
  
    

## 6.8 应用进程跨越网络的通信

### 6.8.1 系统调用和应用编程接口

+ 多数操作系统使用**系统调用(system call)**的机制在应用程序和操作系统之间传递控制权

+ 系统调用接口实际上就是应用进程的控制权和操作系统的控制权进行转换的一个接口

+ 由于应用程序在使用系统调用之前要编写一些程序，特别是需要设置系统调用中的许多参数，因此这种系统调用接口又称为**应用编程接口API(Application Programming Interface)**

+ **套接字接口(socket interface)（或插口接口）**

+ 微软的套接字接口API为Windows Socket，简称winsock，AT&T的套接字API是TLI(Transport Layer Interface)

+ 现在套接字已成为计算机操作系统内核的一部分

+ 在套接字以上的进程受应用程序控制，套接字以下的运输层协议软件则是通过套接字与操作系统交互

+ 应用进程需要使用网络通信时，必须首先发出socket系统调用，请求操作系统为其**创建**一个套接字，请求操作系统把网络通信所需要的一些系统资源分配给该应用进程

+ 操作系统为这些资源的总和用一个叫做**套接字描述符(socket descriptor)**的号码来表示，然后把这个套接字描述符**返回**给应用进程

+ 套接字是应用进程为了获得网络通信服务而与操作系统进行交互时使用的一种机制

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328112442574.png" alt="image-20200328112442574" style="zoom:50%;" />

### 6.8.2 几种常用的系统调用

1. **连接建立阶段**
   + 当套接字被创建后，它的端口号和IP地址都是空的，因此应用进程要调用bind（绑定）来指明套接字的本地地址（本地端口号和本地IP地址）
   
   + 在服务器端调用bind时就是把熟知端口号和本地IP地址填写到已创建的套接字中，称**把本地地址绑定到套接字**
   
   + 服务器在调用bind后，还必须调用listen（收听）把套接字设置为**被动方式**，以便随时接受客户的服务请求
   
   + UDP服务器由于只提供无连接服务，不使用listen系统调用
   
   + 服务器紧接着调用accept（接受），以便把远地客户进程发来的连接请求提取出来
   
   + 调用accept要完成的动作较多，因为一个服务器必须能够同时处理多个连接
   
   + 主服务器进程M（就是通常所说的服务器进程）一调用accept，就为每个新的连接请求创建一个新的套接字，并把这个新创建的套接字的标识符返回给发起连接的客户方。与此同时，主服务器还要创建一个从属服务器进程，来处理新建立的连接
   
   + 在已建立的连接上从属服务器进程就是用这个新创建的套接字传送和接收数据。数据通信结束后从属服务器进程就关闭这个新创建的套接字，同时这个从属服务器也被撤销
   
     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328112508867.png" alt="image-20200328112508867" style="zoom:50%;" />
   
   + 主服务器进程用原来的套接字接受连接请求，而从属服务器进程用新创建的套接字和相应的客户建立连接并可进行双向传送数据
   
2. **数据传送阶段**

   + 客户和服务器都在TCP连接上使用send系统调用传送数据，使用recv系统调用接收数据
   + 调用send需要三个变量：数据要发往的套接字描述符、要发送的数据的地址以及数据的长度
   + 调用recv需要三个变量：要使用的套接字描述符、缓存的地址以及缓存空间的长度

3. **连接释放阶段**

   + 一旦客户或服务器结束使用套接字，就把套接字撤销。这时调用close释放连接和撤销套接字

   + UDP服务器由于只提供无连接服务，因此不使用listen和accept系统调用

     <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328143353018.png" alt="image-20200328143353018" style="zoom:50%;" />

## 6.9 P2P应用

+ P2P应用就是指具有P2P体系结构的网络应用。所谓P2P体系结构就是在这样的网络应用中，没有或只有极少数的固定服务器，而绝大多数的交互都是使用对等方式（P2P方式）进行的
+ P2P应用的范围很广，例如，文件分发、实时音频或视频会议、数据库系统、网络服务支持
+ P2P文件分发不需要使用集中式的媒体服务器，而所有音频/视频文件都是在普通互联网用户之间传输的
+ P2P文件分发方式解决了集中式媒体服务器可能出现的瓶颈问题

### 6.9.1 具有集中目录服务器的P2P工作方式

+ 最早使用P2P工作方式的是Napster
+ Napster的出现使MP3成为网络音乐事实上的标准
+ 这个目录服务器起着索引的作用，使用者只要查找目录服务器，就可知道应从何处下载所要的MP3文件
+ Napster的文件传输是分散的，但文件的定位则是集中的C/S方式
+ 流程P312
+ <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328172054812.png" alt="image-20200328172054812" style="zoom:50%;" />

### 6.9.2 具有全分布式结构的P2P文件共享程序

+ Gnutella 是一种采用全分布方法定位内容的P2P文件共享应用程序

+ Gnutella与Napster最大区别就是不使用集中式的目录服务器进行查询，而是使用**有限范围的洪泛查询**

+ 使用分散定位和分散传输技术，如KaZaA、电骡eMule，比特洪流BT(Bit Torrent)

+ BT:

  + BT把参与某个文件分发的所有对等方的集合称为一个**洪流(torrent)**，BT把对等方下载文件的数据单元称为文件块

  + **基本机制：**

    + 每一个洪流都有一个基础设施结点，叫做**追踪器(tracker)**。当一个对等方加入洪流时，必须向追踪器**登记（注册）**，并周期性通知追踪器它仍在洪流中，追踪器因而就跟踪了洪流中的对等方。一个洪流中可以拥有少到几个多到几百或几千个对等方

    + 当一个新的对等方A加入洪流时，追踪器就随机地从参与的对等方集合中选择若干个，并把这些对等方的IP地址告诉A，于是A就和这些对等方建立了TCP连接。我们称所有与A建立了TCP连接的对等方为**相邻对等方**（neighboring peers)，这些相邻对等方的数目是动态变化的，有的不久就离开了，但又有新加入进来的

    + 利用实际网络上面的一个更加简洁的覆盖网络，这个覆盖网络忽略了实际网络的许多细节，使问题的讨论更加方便，在覆盖网络中，A的三个相邻对等方就看得很清楚，然而在实际网络中，则反映不出这几个对等方的相邻关系

    + 任何时刻，每个对等方可能只拥有某文件的一个文件块子集，而不同的对等方所拥有的文件块子集也不会完全相同。对等方A将通过TCP连接周期性地向其相邻对等方索取它们拥有的文件快列表。根据收到的文件块列表，A就知道了应当请求哪一个相邻对等方把哪些自己缺少的文件块发送过来

      <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328174805852.png" alt="image-20200328174805852" style="zoom:50%;" />

    + 由于P2P对等用户的数量非常多，因此，从不同对等方获得不同的数据块，然后组装成整个文件，一般要比仅从一个地方下载整个文件要快很多

    + Question1：哪些文件块是首先需要向其相邻对等方请求的？
      + 使用**最稀有的优先(rarest fisrt)**
      + A首先应当请求副本最少的文件块（最稀有的），否则一旦拥有最稀有文件块的对等方推出了洪流，就会影响A对所缺文件块的收集
    + Question2：在很多向A请求文件块的相邻对等方中，A应当向哪些相邻对等方发送所请求的文件块？
      + 凡当前有以最高数据率向A传送文件快的某相邻对等方，A就优先把所请求的文件块传送给该相邻对等方
      + A持续测量从其相邻对等方接收数据率的速率，并确定速率最高的4个相邻对等方，这4个对等方叫做**已疏通的**或**无障碍的(unlocked)**对等方。更重要的是，每隔30秒，A要随机地找一个另外的相邻对等方B，并向其发送文件块

### 6.9.3 P2P文件分发的分析

+ 从互联网传送数据到主机，叫做**下载(download)**，从主机向互联网传送，称为**上传(upload)**或**上载**

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328182425235.png" alt="image-20200328182425235" style="zoom:50%;" />

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328182448316.png" alt="image-20200328182448316" style="zoom:50%;" />

<img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328182549811.png" alt="image-20200328182549811" style="zoom:50%;" />

### 6.9.4 在P2P对等方中搜索对象

+ 利用散列函数定位对等方

+ 比较好的方法是设法构建一种分布式数据库，以进行对等方及其资源的定位

+ 存储在数据库中的信息只有两个部分：

  + 要查找的**资源名K**。也可称为**关键字**
  + 存放该对象的**结点的IP地址N**，有的IP地址还附带有端口号

+ 主机的域名是结构化的命名系统，因此域名服务器可以划分为集中不同的级别便于查找。但P2P系统则不同，其资源名是非结构化的。因此不能套用DNS的那种查找方法

+ **分布式散列表DHT(Distributed Hash Table)**。DHT也可译为分布式哈希表，它是由大量对等方共同维护的散列表

+ 分布式散列表DHT利用散列函数，把资源名K及其存放的结点IP地址N都分别映射为**资源名标识符KID**和**结点标识符NID**

+ 散列函数SHA-1是多对一函数，但实际上不同输入得到相同的输出的概率极小，此外，通过SHA-1映射得到的标识符能够比较均匀而稀疏地分布在Chord环上

  ![image-20200328185110150](X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328185110150.png)

+ K31和K2都放在K4，这表示要查找存放资源K31或K2的结点的IP地址，就应当到结点N4去查找。注意K31和K2并非存放在结点N4

+ 每个资源由Chord环上与其标识符值**最接近**的下一个结点提供服务

+ 在这样的Chord环上查找资源，从理论上讲，任何一个结点，只要从其后继结点一个个地遍历查找下去，一定可以找到所查询的资源，可见要定位一个资源，平均需要沿环发送查找报文N/2个，或遍历O(N)个结点（N为换上的总结点数）。显然，这种顺序查找的方法效率很低。

+ 为了加速查找，在Chord环上可以增加一些**指针表(finger table)**，它又称为**路由表**或**查找器表**。若Chord环上的标识符有m位，则在结点n上的指针表可设置不超过m个指针，指向其后继的结点

+ 这种查找方法类似于二分查找，只用了两次查找，定位一个资源仅需O(log~2~N)步

  <img src="X:\0931Xu\Study\Review\计算机网络\PhotosInMd\image-20200328185144791.png" alt="image-20200328185144791" style="zoom:75%;" />

+ 在P2P网络中，对等方可能相当频繁地加入或退出系统，这就需要很好地维护这个分布式数据库（维护各结点的指针和指针表），而这种维护的工作量可能回很大

+ 音频/视频文件的知识产权是其中一个问题